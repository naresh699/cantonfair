(()=>{(function(){"use strict";function d(){if(typeof window.markdownit=="function"){window.aipkit_md=window.markdownit({html:!1,xhtmlOut:!1,breaks:!0,langPrefix:"language-",linkify:!0,typographer:!0,quotes:"\u201C\u201D\u2018\u2019"});let n=window.aipkit_md.renderer.rules.link_open||function(e,i,a,t,o){return o.renderToken(e,i,a)};window.aipkit_md.renderer.rules.link_open=function(e,i,a,t,o){let r=e[i],s=r.attrIndex("target");s<0?r.attrPush(["target","_blank"]):r.attrs[s][1]="_blank";let u=r.attrIndex("rel");if(u<0)r.attrPush(["rel","noopener noreferrer"]);else{let l=(r.attrs[u][1]||"").split(/\s+/).filter(Boolean);l.includes("noopener")||l.push("noopener"),l.includes("noreferrer")||l.push("noreferrer"),r.attrs[u][1]=l.join(" ")}return n(e,i,a,t,o)},window.hljs&&typeof window.markdownitHighlight=="function"&&window.aipkit_md.use(window.markdownitHighlight,{hljs:window.hljs})}else console.error("AIPKit Chat Markdown: markdown-it library not found. Markdown parsing will be basic."),window.aipkit_md={render:function(n){return console.warn("AIPKit Chat Markdown: Using fallback markdown renderer."),(window.aipkit_escapeHtml||function(i){return typeof i!="string"?"":i.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")})(n).replace(/\n/g,"<br>")}}}window.aipkit_initializeMarkdownParser=d})();(function(){"use strict";function d(e){return e===null||typeof e>"u"?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function n(e){return d(e)}window.aipkit_escapeHtml=d,window.aipkit_escapeAttribute=n})();(function(){"use strict";function d(n){let e=Number(n);if(!e||isNaN(e))return"";try{let i=new Date(e*1e3);if(isNaN(i.getTime()))return"";let a=String(i.getHours()).padStart(2,"0"),t=String(i.getMinutes()).padStart(2,"0"),o=String(i.getSeconds()).padStart(2,"0");return`${a}:${t}:${o}`}catch(i){return console.error("Error formatting timestamp:",n,i),""}}window.aipkit_formatTimestamp=d})();(function(){"use strict";function d(n,e={},i={}){return new Promise((a,t)=>{if(!i.ajaxUrl)return t(new Error("AIPKit Frontend AJAX: ajaxUrl missing in config."));let o=new FormData;o.append("action",n),i.nonce?o.append("_ajax_nonce",i.nonce):console.warn(`AIPKit Frontend AJAX: Nonce not found in config for action "${n}".`),i.botId&&o.append("bot_id",i.botId),window.aipkit_guest_uuid&&o.append("session_id",window.aipkit_guest_uuid),window.aipkit_current_conversation_uuid&&o.append("conversation_uuid",window.aipkit_current_conversation_uuid),window.aipkit_current_post_id&&o.append("post_id",window.aipkit_current_post_id),i.provider==="OpenAI"&&i.enableOpenAIConversationState&&window.aipkit_current_openai_response_id&&o.append("previous_openai_response_id",window.aipkit_current_openai_response_id),e.frontend_web_search_active===!0&&o.append("frontend_web_search_active","true"),e.frontend_google_search_grounding_active===!0&&o.append("frontend_google_search_grounding_active","true"),i.activeFileContext?(i.activeFileContext.provider==="OpenAI"&&i.activeFileContext.vector_store_id&&o.append("active_openai_vs_id",i.activeFileContext.vector_store_id),i.activeFileContext.provider==="Pinecone"&&i.activeFileContext.index_name&&i.activeFileContext.namespace&&(o.append("active_pinecone_index_name",i.activeFileContext.index_name),o.append("active_pinecone_namespace",i.activeFileContext.namespace)),i.activeFileContext.provider==="Qdrant"&&i.activeFileContext.collection_name&&i.activeFileContext.file_upload_context_id&&(o.append("active_qdrant_collection_name",i.activeFileContext.collection_name),o.append("active_qdrant_file_upload_context_id",i.activeFileContext.file_upload_context_id)),i.activeFileContext.provider==="Claude"&&i.activeFileContext.file_id&&o.append("active_claude_file_id",i.activeFileContext.file_id)):e.active_openai_vs_id?console.log(`AIPKit frontendApiRequest: Sending active_openai_vs_id from data object: ${e.active_openai_vs_id}`):e.active_pinecone_index_name&&e.active_pinecone_namespace?console.log(`AIPKit frontendApiRequest: Sending Pinecone context from data object: Index: ${e.active_pinecone_index_name}, Namespace: ${e.active_pinecone_namespace}`):e.active_qdrant_collection_name&&e.active_qdrant_file_upload_context_id?console.log(`AIPKit frontendApiRequest: Sending Qdrant context from data object: Collection: ${e.active_qdrant_collection_name}, File Context ID: ${e.active_qdrant_file_upload_context_id}`):e.active_claude_file_id&&console.log(`AIPKit frontendApiRequest: Sending Claude file context from data object: File ID: ${e.active_claude_file_id}`);for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&r!=="frontend_web_search_active"&&r!=="frontend_google_search_grounding_active"&&r!=="active_openai_vs_id"&&r!=="active_pinecone_index_name"&&r!=="active_pinecone_namespace"&&r!=="active_qdrant_collection_name"&&r!=="active_qdrant_file_upload_context_id"&&r!=="active_claude_file_id"&&(r==="audio_file"&&e[r]instanceof Blob?o.append(r,e[r],"speech."+(e.audio_format||"webm")):o.append(r,e[r]));fetch(i.ajaxUrl,{method:"POST",body:o,credentials:"same-origin"}).then(r=>r.json()).then(r=>{if(r.success)a(r.data);else{let s=r.data&&typeof r.data=="object"&&r.data.message?r.data.message:"Unknown frontend API error (data or data.message missing/invalid)";t(new Error(s))}}).catch(r=>{console.error(`AIPKit Frontend AJAX Error (Action: ${n}):`,r),t(r)})})}window.aipkit_frontendApiRequest=d})();(function(){"use strict";function d(n){return`aipkit-client-msg-${String(n||"default").replace(/[^a-zA-Z0-9_-]/g,"")}-${Date.now()}-${Math.random().toString(36).substring(2,7)}`}window.aipkit_generateClientMessageId=d})();(function(){"use strict";function d(n){if(!n||typeof n.style>"u")return;n.style.height="auto";let e=n.scrollHeight,i=window.getComputedStyle(n),a=parseInt(i.minHeight,10)||0,t=parseInt(i.maxHeight,10)||1/0,o=Math.max(a,e);o=Math.min(o,t),n.style.height=`${o}px`,o>=t?(n.style.overflowY="auto",n.classList.add("aipkit-textarea-scrollable")):(n.style.overflowY="hidden",n.classList.remove("aipkit-textarea-scrollable"))}window.aipkit_autoResizeTextarea=d})();(function(){"use strict";function d(e,i,a,t){let{webSearchToggleButton:o}=e,r=i.allowWebSearchTool&&(i.provider==="OpenAI"||i.provider==="Claude"||i.provider==="OpenRouter");a.webSearchToolActive=r&&!!t,!(!o||!r)&&(o.classList.toggle("aipkit_active",a.webSearchToolActive),o.title=a.webSearchToolActive?i.text?.webSearchActive||"Web Search Active":i.text?.webSearchInactive||"Web Search Inactive",o.setAttribute("aria-pressed",a.webSearchToolActive.toString()))}function n(e,i,a){d(e,i,a,!a.webSearchToolActive)}window.aipkit_syncWebSearchToggleState=d,window.aipkit_toggleWebSearchAction=n})();(function(){"use strict";function d(e,i,a,t){let{googleSearchGroundingToggleButton:o}=e,r=i.allowGoogleSearchGrounding&&i.provider==="Google";a.googleSearchGroundingActive=r&&!!t,!(!o||!r)&&(o.classList.toggle("aipkit_active",a.googleSearchGroundingActive),o.title=a.googleSearchGroundingActive?i.text?.googleSearchGroundingActive||"Google Search Grounding Active":i.text?.googleSearchGroundingInactive||"Google Search Grounding Inactive",o.setAttribute("aria-pressed",a.googleSearchGroundingActive.toString()))}function n(e,i,a){d(e,i,a,!a.googleSearchGroundingActive)}window.aipkit_syncGoogleSearchGroundingToggleState=d,window.aipkit_toggleGoogleSearchGroundingAction=n})();(function(){"use strict";let d="aipkit_chat_ui_notice",n="aipkit_chat_ui_notice--visible",e=new Set(["info","success","error","processing","warning"]),i=new WeakMap,a=new WeakMap;function t(p){if(!p)return null;if(p.inputArea&&p.inputArea.nodeType===1)return p.inputArea;if(p.elements&&p.elements.inputArea)return p.elements.inputArea;if(p.container&&p.container.nodeType===1)return p.container.querySelector(".aipkit_chat_input");let l=p.messagesEl?p.messagesEl:p.elements&&p.elements.messagesEl?p.elements.messagesEl:null;if(l&&l.nodeType===1){let w=l.closest(".aipkit_chat_container");if(w)return w.querySelector(".aipkit_chat_input")}return null}function o(p){let l=p.querySelector(`.${d}`);if(l)return l;l=document.createElement("div"),l.className=d,l.setAttribute("role","status"),l.setAttribute("aria-live","polite");let w=p.querySelector(".aipkit_chat_input_wrapper");return w?p.insertBefore(l,w):p.appendChild(l),l}function r(p){let l=i.get(p);l&&(clearTimeout(l),i.delete(p));let w=a.get(p);w&&(clearTimeout(w),a.delete(p))}function s(p,l=!0){if(!p)return;r(p);let w=()=>{p.textContent="",p.style.display="none",p.className=d,a.delete(p)};if(!l){w();return}p.classList.remove(n);let _=window.setTimeout(w,220);a.set(p,_)}function u(p,l="info",w={},_,c){let f=String(p||"").trim();if(!f)return;let g=e.has(l)?l:"info",m=t(w);if(!m){console.warn("AIPKit Inline Notice: Could not resolve input area for message:",f);return}let h=o(m);if(r(h),h.textContent=f,h.className=`${d} aipkit_status-${g}`,h.style.display="block",requestAnimationFrame(()=>{h.style.display!=="none"&&h.classList.add(n)}),!(typeof _=="boolean"?_:g!=="processing"))return;let I=Number.isFinite(c)?Math.max(1e3,c):g==="error"||g==="warning"?7e3:4500,y=window.setTimeout(()=>{s(h,!0)},I);i.set(h,y)}window.aipkit_chatUI_showInlineNotice=u})();(function(){"use strict";let d=new Set(["muted","info","error","loading"]);function n(i={}){let a=d.has(i.type)?i.type:"muted",t=String(i.message||"").trim(),o=i.scope==="messages"?"messages":"sidebar",r=!!i.showSpinner,s=document.createElement("div");if(s.className=`aipkit_ui_state aipkit_ui_state--${a} aipkit_ui_state--${o}`,r&&!t&&s.classList.add("aipkit_ui_state--spinner-only"),t){let u=document.createElement("p");u.className="aipkit_ui_state_text",u.textContent=t,s.appendChild(u)}if(r){let u=document.createElement("span");u.className="aipkit_ui_state_spinner";let p=document.createElement("span");p.className="aipkit_spinner",p.setAttribute("aria-hidden","true"),u.appendChild(p),s.appendChild(u)}return s}function e(i,a={}){i&&(i.innerHTML="",i.appendChild(n(a)))}window.aipkit_chatUI_createStateElement=n,window.aipkit_chatUI_renderUIState=e})();(function(){"use strict";function d(n,e){let i=e.botId||"unknown",a=n.querySelector(".aipkit_chat_header"),t=n.querySelector(".aipkit_chat_main"),o=t?t.querySelector(".aipkit_chat_messages"):null,r=t?t.querySelector(".aipkit_chat_footer"):null,s=t?t.querySelector(".aipkit_chat_input"):null,u=s?s.querySelector(".aipkit_chat_input_field"):null,p=s?s.querySelector(".aipkit_chat_input_wrapper"):null,l=p?p.querySelector(".aipkit_chat_input_actions_bar"):null,w=n.querySelector(".aipkit_chat_image_preview_container"),_=n.querySelector(".aipkit_chat_image_upload_input");if(e.imageUploadEnabledUI&&s&&p){if(w||(w=document.createElement("div"),w.className="aipkit_chat_image_preview_container"),!p.contains(w)){let C=p.querySelector(".aipkit_chat_input_field");C?p.insertBefore(w,C):p.appendChild(w)}_||(_=document.createElement("input"),_.type="file",_.className="aipkit_chat_image_upload_input",_.hidden=!0,_.setAttribute("aria-hidden","true"),s.appendChild(_))}let c=s?s.querySelector(".aipkit_chat_file_upload_input"):null;e.fileUploadEnabledUI&&s&&(c||(c=document.createElement("input"),c.type="file",c.className="aipkit_chat_file_upload_input",c.hidden=!0,c.setAttribute("aria-hidden","true"),s.appendChild(c)));let f=l?l.querySelector(".aipkit_input_action_btn.aipkit_input_action_toggle"):null,g=s?s.querySelector(".aipkit_input_action_menu"):null,m=l?l.querySelector(".aipkit_voice_input_btn"):null,h=l?l.querySelector(".aipkit_web_search_toggle"):null,b=l?l.querySelector(".aipkit_google_search_grounding_toggle"):null,I=l?l.querySelector(".aipkit_chat_action_btn.aipkit_send_btn"):null,y=I?I.querySelector(".aipkit_send_icon"):null,v=I?I.querySelector(".aipkit_clear_icon"):null,U=I?I.querySelector(".aipkit_spinner"):null,x=t?t.querySelector(".aipkit_conversation_starters"):null,M=a?a.querySelector(".aipkit_sidebar_toggle_btn"):null,F=a?a.querySelector(".aipkit_fullscreen_btn"):null,k=a?a.querySelector(".aipkit_download_btn"):null,S=n.querySelector(".aipkit_chat_sidebar"),A=S?S.querySelector(".aipkit_sidebar_new_chat_btn"):null;return!t||!o||!u||!I||!y||!v||!U?(console.error(`AIPKit Chat FindElements (${i}): Essential chat UI elements not found within container.`),null):(e.enableStarters&&!x&&console.warn(`AIPKit Chat FindElements (${i}): Starters enabled but container not found.`),e.enableSidebar&&(!S||!M)&&console.warn(`AIPKit Chat FindElements (${i}): Sidebar enabled but container or toggle button not found.`),e.inputActionButtonEnabled&&!f&&console.warn(`AIPKit Chat FindElements (${i}): Input Action Button features enabled but button element missing.`),e.allowWebSearchTool&&(e.provider==="OpenAI"||e.provider==="Claude"||e.provider==="OpenRouter")&&!h&&console.warn(`AIPKit Chat FindElements (${i}): Provider Web Search allowed but toggle button missing.`),e.allowGoogleSearchGrounding&&e.provider==="Google"&&!b&&console.warn(`AIPKit Chat FindElements (${i}): Google Search Grounding allowed but toggle button missing.`),{container:n,headerEl:a,mainContentEl:t,messagesEl:o,footerEl:r,inputArea:s,inputField:u,inputWrapper:p,actionsBar:l,imageUploadInput:_,imagePreviewContainer:w,fileUploadInput:c,inputActionButton:f,inputActionMenu:g,voiceInputButton:m,webSearchToggleButton:h,googleSearchGroundingToggleButton:b,actionButton:I,sendIcon:y,clearIcon:v,spinner:U,startersContainer:x,sidebarToggleBtn:M,fullscreenButton:F,downloadButton:k,sidebarEl:S,newChatBtn:A})}window.aipkit_chatUI_findElements=d})();(function(){"use strict";function d(n,e=!1){n&&requestAnimationFrame(()=>{let i=n.scrollHeight-n.scrollTop-n.clientHeight<100;(e||i)&&(n.scrollTop=n.scrollHeight,setTimeout(()=>{n&&(n.scrollTop=n.scrollHeight)},50)),typeof window.aipkit_chatUI_updateScrollToBottomButton=="function"&&window.aipkit_chatUI_updateScrollToBottomButton(n)})}window.aipkit_chatUI_scrollToBottom=d})();(function(){"use strict";function d(n){if(!n)return;let e=n.style.animation;n.style.animation="none",n.offsetHeight,e?n.style.animation=e:n.style.removeProperty("animation")}window.aipkit_chatUI_triggerMessageAnimation=d})();(function(){"use strict";let d="aipkit_scroll_to_bottom_btn",n="aipkit-scroll-visible",a=window.requestAnimationFrame||function(w){return window.setTimeout(w,16)};function t(w,_=48){return w?w.scrollHeight-w.scrollTop-w.clientHeight<=_:!0}function o(w){return w?w.scrollHeight>w.clientHeight+4:!1}function r(w){if(!w||!w._aipkitScrollToBottomButton)return;let _=w._aipkitScrollToBottomButton,c=o(w)&&!t(w);_.classList.toggle(n,c),_.setAttribute("aria-hidden",c?"false":"true")}function s(w,_,c){if(!w)return;let f=_?Math.round(_.getBoundingClientRect().height):0,g=c?Math.round(c.getBoundingClientRect().height):0,h=Math.max(96,f+g+12);w.style.setProperty("--aipkit-chat-scroll-button-bottom-offset",`${h}px`)}function u(w){let _=w.querySelector(`.${d}`);return _||(_=document.createElement("button"),_.type="button",_.className=d,_.setAttribute("aria-label","Scroll to bottom"),_.setAttribute("aria-hidden","true"),_.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5v14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 13l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',w.appendChild(_),_)}function p(w){if(!w||!w.mainContentEl||!w.messagesEl||w.mainContentEl.dataset.aipkitScrollButtonInit==="1")return;w.mainContentEl.dataset.aipkitScrollButtonInit="1";let{mainContentEl:_,messagesEl:c,inputArea:f,footerEl:g}=w,m=u(_);c._aipkitScrollToBottomButton=m,c._aipkitScrollToBottomUpdate=()=>r(c);let h=()=>{a(()=>r(c))};if(c.addEventListener("scroll",h,{passive:!0}),typeof MutationObserver<"u"&&new MutationObserver(h).observe(c,{childList:!0,subtree:!0}),typeof ResizeObserver<"u"){let b=new ResizeObserver(()=>{s(_,f,g),h()});b.observe(c),f&&b.observe(f),g&&b.observe(g)}else window.addEventListener("resize",()=>{s(_,f,g),h()});m.addEventListener("click",()=>{typeof window.aipkit_chatUI_scrollToBottom=="function"?window.aipkit_chatUI_scrollToBottom(c,!0):c&&c.scrollTo({top:c.scrollHeight,behavior:"smooth"}),h()}),s(_,f,g),h()}function l(w){!w||!w._aipkitScrollToBottomUpdate||w._aipkitScrollToBottomUpdate()}window.aipkit_chatUI_initScrollToBottomButton=p,window.aipkit_chatUI_updateScrollToBottomButton=l})();(function(){"use strict";function d(n,e=null){if(!n)return;if(e&&e.parentNode===n){try{n.removeChild(e)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeTypingIndicator: Error removing provided indicator:",r)}return}let a=`aipkit-typing-indicator-${n.closest(".aipkit_chat_container")?.dataset.botId||n.closest(".aipkit_popup_wrapper")?.dataset.botId||"default"}`,t=n.querySelector(`#${CSS.escape(a)}`);if(t)try{n.removeChild(t)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeTypingIndicator: Error removing indicator by ID:",r)}let o=n.querySelector(".aipkit_typing-indicator");if(o)try{n.removeChild(o)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeTypingIndicator: Error removing indicator by class:",r)}}window.aipkit_chatUI_removeTypingIndicator=d})();(function(){"use strict";function d(n,e=null){if(!n)return;if(e&&e.parentNode===n){try{n.removeChild(e)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeImageLoadingIndicator: Error removing provided indicator:",r)}return}let a=`aipkit-image-loading-indicator-${n.closest(".aipkit_chat_container")?.dataset.botId||n.closest(".aipkit_popup_wrapper")?.dataset.botId||"default"}`,t=n.querySelector(`#${CSS.escape(a)}`);if(t)try{n.removeChild(t)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeImageLoadingIndicator: Error removing indicator by ID:",r)}let o=n.querySelector(".aipkit_image_loading_indicator");if(o)try{n.removeChild(o)}catch(r){r.name!=="NotFoundError"&&console.warn("AIPKit removeImageLoadingIndicator: Error removing indicator by class:",r)}}window.aipkit_chatUI_removeImageLoadingIndicator=d})();(function(){"use strict";function d(n,e){if(!n||!e||!e.text)return null;typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(n),typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"&&window.aipkit_chatUI_removeImageLoadingIndicator(n);let a=`aipkit-typing-indicator-${e.botId||"default"}`,t=document.createElement("div");t.className="aipkit_chat_message aipkit_chat_message-bot aipkit_typing-indicator",t.id=a;let o=(e.customTypingText||"").trim(),r=document.createElement("div");if(r.className="aipkit_chat_bubble",o!==""){let s=(window.aipkit_escapeHtml||(u=>String(u)))(o);r.innerHTML=`
        <span class="aipkit_typing-text">${s}</span>
        <span class="aipkit_typing-ellipsis-text" aria-hidden="true"><span>.</span><span>.</span><span>.</span></span>
      `}else r.innerHTML=`
        <span class="aipkit_typing-dot"></span>
        <span class="aipkit_typing-dot"></span>
        <span class="aipkit_typing-dot"></span>
      `;return t.appendChild(r),n.appendChild(t),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,!0),t}window.aipkit_chatUI_showTypingIndicator=d})();(function(){"use strict";function d(n,e){if(!n||!e)return null;typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(n),typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"&&window.aipkit_chatUI_removeImageLoadingIndicator(n);let a=`aipkit-image-loading-indicator-${e.botId||"default"}`,t=document.createElement("div");t.className="aipkit_chat_message aipkit_chat_message-bot aipkit_image_loading_indicator",t.id=a;let o=document.createElement("div");return o.className="aipkit_chat_bubble aipkit_image_loader_bubble_thumbnail",o.innerHTML='<span class="dashicons dashicons-format-image"></span>',t.appendChild(o),n.appendChild(t),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,!0),t}window.aipkit_chatUI_showImageLoadingIndicator=d})();(function(){"use strict";let d='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-copy"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg>';function n(o){if(!o)return"";let r=o.querySelector("code");return r?r.textContent:o.textContent}function e(o,r){if(o){if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(o).then(r).catch(()=>{i(o,r)});return}i(o,r)}}function i(o,r){try{let s=document.createElement("textarea");s.value=o,s.setAttribute("readonly",""),s.style.position="absolute",s.style.left="-9999px",document.body.appendChild(s),s.select();let u=document.execCommand("copy");document.body.removeChild(s),u&&r()}catch(s){console.error("AIPKit Code Copy: Fallback copy failed.",s)}}function a(o,r){if(!o||r&&r.enableCopyButton===!1)return;let s=o.querySelectorAll("pre");if(!s.length)return;let u=r&&r.text&&r.text.copyCodeLabel||"Copy code";s.forEach(p=>{if(p.classList.contains("aipkit_code_block"))return;let l=document.createElement("button");l.type="button",l.className="aipkit_code_copy_btn",l.setAttribute("aria-label",u),l.setAttribute("title",u),l.innerHTML=d,p.classList.add("aipkit_code_block"),p.insertBefore(l,p.firstChild)})}function t(o){let r=o.target.closest(".aipkit_code_copy_btn");if(!r)return;o.preventDefault();let s=r.closest("pre"),u=n(s);u&&e(u,()=>{typeof window.aipkit_chatUI_showSuccessIcon=="function"&&window.aipkit_chatUI_showSuccessIcon(r)})}document.addEventListener("click",t),window.aipkit_chatUI_attachCodeCopyButtons=a})();(function(){"use strict";function d(n,e,i,a,t=!1,o=!1,r=null,s=!1,u=null){if(!n||!a)return;let p=window.aipkit_escapeHtml||function(f){return f};o||n.querySelectorAll(".aipkit_initial_greeting").forEach(g=>g.remove());let l=document.createElement("div"),w=i==="user"?"user":"bot";l.className=`aipkit_chat_message aipkit_chat_message-${w}`,t&&l.classList.add("aipkit_chat_message-error"),o&&l.classList.add("aipkit_initial_greeting"),r&&(l.id=r,l.setAttribute("data-message-id",r));let _=document.createElement("div");_.className="aipkit_chat_bubble";let c="";if(w==="user"&&typeof e=="object"&&e!==null&&e.user_image){if(e.user_image.base64_data&&e.user_image.mime_type){let f=document.createElement("img");f.src=`data:${e.user_image.mime_type};base64,${e.user_image.base64_data}`,f.alt=e.text||"User uploaded image",f.className="aipkit_user_sent_image_thumbnail",_.appendChild(f)}if(e.text&&e.text.trim()!==""){let f=document.createElement("div");f.className="aipkit_user_message_text_content",f.textContent=e.text,_.appendChild(f),c=e.text}else!e.text&&e.user_image&&(c="Image sent by user.")}else if(typeof e=="object"&&e?.type==="image"&&e.images?.length>0){let f=e.images[0],g=String(e.prompt||"Generated image"),m=typeof f.revised_prompt=="string"?f.revised_prompt:"",h=({src:b,href:I,alt:y})=>{let v=document.createElement("img");if(v.src=b,v.alt=y,v.className="aipkit_bot_generated_image",I){let U=document.createElement("a");U.href=I,U.target="_blank",U.rel="noopener noreferrer",U.appendChild(v),_.appendChild(U);return}_.appendChild(v)};if(f.media_library_url)h({src:String(f.media_library_url),href:String(f.media_library_url),alt:g});else if(f.url)h({src:String(f.url),href:String(f.url),alt:g});else if(f.b64_json)h({src:`data:image/png;base64,${f.b64_json}`,alt:g});else{let b=e.content||a.text?.noImageData||"Image data unavailable.",I=document.createElement("p");I.className="aipkit_image_unavailable_text",I.textContent=b,_.appendChild(I)}if(_.classList.add("aipkit_chat_bubble--image"),_.title=`Prompt: ${g}`,c=`Image generated for prompt: ${g}`,m){let b=document.createElement("p");b.className="aipkit_image_revised_prompt",b.textContent=`Revised: ${m}`,_.appendChild(b),c+=`. Revised prompt: ${m}`}}else if(typeof e=="string")if(c=e,(w==="bot"||o)&&!t&&window.aipkit_md)_.innerHTML=window.aipkit_md.render(e),typeof window.aipkit_chatUI_attachCodeCopyButtons=="function"&&window.aipkit_chatUI_attachCodeCopyButtons(_,a);else{let f=e.split(`
`);f.forEach((g,m)=>{_.appendChild(document.createTextNode(g)),m<f.length-1&&_.appendChild(document.createElement("br"))})}else console.error("AIPKit appendMessage: Invalid content type provided.",e),_.textContent=p("[Invalid Content]"),c="Invalid Content";if(_.setAttribute("data-raw-text",c),l.appendChild(_),w==="bot"&&!o&&!t)if(l.classList.add("aipkit_message_complete"),typeof window.aipkit_chatUI_createActionsContainerHTML=="function"){let f=window.aipkit_chatUI_createActionsContainerHTML(a);f&&(l.insertAdjacentHTML("beforeend",f),l.classList.add("aipkit_has_message_actions"))}else console.error("AIPKit DOM: aipkit_chatUI_createActionsContainerHTML function not found globally.");if(w==="bot"&&!t&&u&&u.searchEntryPoint&&u.searchEntryPoint.renderedContent){let f=document.createElement("div");f.className="aipkit_grounding_widget",f.innerHTML=u.searchEntryPoint.renderedContent,l.appendChild(f)}n.appendChild(l),typeof window.aipkit_chatUI_triggerMessageAnimation=="function"&&window.aipkit_chatUI_triggerMessageAnimation(l),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,s)}window.aipkit_chatUI_appendMessage=d})();(function(){"use strict";function d(n,e){let i=n.querySelector(`.${e}`);i?i.parentNode&&i.parentNode.removeChild(i):(i=document.createElement("span"),i.className=e);let a=o=>{let r=Array.from(o.childNodes);for(let s=r.length-1;s>=0;s--){let u=r[s];if(u.nodeType===Node.TEXT_NODE&&u.textContent.trim()!==""){let p=document.createElement("span"),l=document.createTextNode(u.textContent);return p.appendChild(l),o.replaceChild(p,u),p.appendChild(i),!0}if(u.nodeType===Node.ELEMENT_NODE&&u.offsetParent!==null&&!u.classList.contains(e)&&["P","DIV","SPAN","LI","H1","H2","H3","H4","H5","H6","CODE","STRONG","EM","A","BR"].includes(u.tagName))return u.childNodes.length>0&&a(u)||(u.nextSibling?o.insertBefore(i,u.nextSibling):o.appendChild(i)),!0}return!1};a(n)||n.appendChild(i)}window.positionStreamingIndicator=d})();(function(){"use strict";function d(n,e,i,a,t,o=!1,r=!1,s=null){if(!n||!t||!e){console.error("AIPKit appendOrUpdateMessage: Missing messagesEl, config, or messageId.",{messagesEl:n,messageId:e,config:t});return}let u=window.aipkit_escapeHtml||function(f){return f},p=n.querySelector(`#${CSS.escape(e)}`),l,w="",_="aipkit_stream_indicator",c=a==="user"?"user":"bot";if(!p)n.querySelectorAll(".aipkit_initial_greeting").forEach(g=>g.remove()),p=document.createElement("div"),p.id=e,p.setAttribute("data-message-id",e),p.className=`aipkit_chat_message aipkit_chat_message-${c}`,r&&p.classList.add("aipkit_chat_message-error"),l=document.createElement("div"),l.className="aipkit_chat_bubble",l.dataset.aipkitFullContent="",l.setAttribute("data-raw-text",""),p.appendChild(l),n.appendChild(p),typeof window.aipkit_chatUI_triggerMessageAnimation=="function"&&window.aipkit_chatUI_triggerMessageAnimation(p);else{if(l=p.querySelector(".aipkit_chat_bubble"),!l)return;r&&!p.classList.contains("aipkit_chat_message-error")&&p.classList.add("aipkit_chat_message-error")}if(l.dataset.aipkitFullContent===void 0&&(l.dataset.aipkitFullContent=""),l.getAttribute("data-raw-text")===null&&l.setAttribute("data-raw-text",""),l.dataset.aipkitFullContent+=i,l.setAttribute("data-raw-text",l.getAttribute("data-raw-text")+i),w=l.dataset.aipkitFullContent,r?l.textContent=w:(l.innerHTML=window.aipkit_md?window.aipkit_md.render(w):w.replace(/\n/g,"<br>"),typeof window.aipkit_chatUI_attachCodeCopyButtons=="function"&&window.aipkit_chatUI_attachCodeCopyButtons(l,t)),p.classList.remove("aipkit_message_streaming"),!o&&!r){if(typeof window.positionStreamingIndicator=="function")window.positionStreamingIndicator(l,_);else{console.error("AIPKit appendOrUpdateMessage: positionStreamingIndicator function not found.");let f=l.querySelector(`.${_}`);f||(f=document.createElement("span"),f.className=_,l.appendChild(f))}p.classList.add("aipkit_message_streaming")}else{let f=l.querySelector(`.${_}`);if(f&&f.parentNode&&f.parentNode.removeChild(f),o&&!r&&c==="bot"&&!p.querySelector(".aipkit_message_actions")){if(p.classList.remove("aipkit_message_streaming"),p.classList.add("aipkit_message_complete"),typeof window.aipkit_chatUI_createActionsContainerHTML=="function"){let g=window.aipkit_chatUI_createActionsContainerHTML(t);g&&(p.insertAdjacentHTML("beforeend",g),p.classList.add("aipkit_has_message_actions"))}else console.error("AIPKit DOM: aipkit_chatUI_createActionsContainerHTML function not found globally.");if(s&&s.searchEntryPoint&&s.searchEntryPoint.renderedContent){let g=document.createElement("div");g.className="aipkit_grounding_widget",g.innerHTML=s.searchEntryPoint.renderedContent,p.appendChild(g)}}}typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,o||r)}window.aipkit_chatUI_appendOrUpdateMessage=d})();(function(){"use strict";function d(n,e,i,a=null){if(!n||!e||!e.form_id||!Array.isArray(e.elements)){console.error("AIPKit RenderChatForm: Invalid arguments. Missing messagesEl, formDefinition, form_id, or elements array.");return}let t=window.aipkit_escapeHtml||function(_){return _},o=i.botId||"default",r=document.createElement("div");if(r.className="aipkit_chat_message aipkit_chat_message-bot aipkit_chat_form_message",a)r.id=a,r.setAttribute("data-message-id",a);else{let _=window.aipkit_generateClientMessageId?window.aipkit_generateClientMessageId(o):`form-msg-${Date.now()}`;r.id=_,r.setAttribute("data-message-id",_)}let s=document.createElement("div");s.className="aipkit_chat_bubble";let u=document.createElement("div");if(u.className="aipkit_chat_form_wrapper",u.dataset.formId=e.form_id,e.title){let _=document.createElement("h5");_.className="aipkit_chat_form_title",_.textContent=t(e.title),u.appendChild(_)}let p=document.createElement("form");p.className="aipkit_chat_form",p.dataset.formId=e.form_id;let l={};e.elements.forEach(_=>{let c=document.createElement("div");c.className="aipkit_chat_form_element";let f,g=typeof _.id=="string"?_.id:"";if(g){let m={};Array.isArray(_.options)&&_.options.forEach(h=>{if(!h||h.value===void 0)return;let b=String(h.value);m[b]=String(h.text??h.value)}),l[g]={label:String(_.label||g),type:String(_.type||""),optionsMap:m}}switch(_.type){case"text_input":case"textarea":if(_.label){let h=document.createElement("label");h.setAttribute("for",`form-${t(e.form_id)}-${t(_.id)}`),h.textContent=t(_.label),h.className="aipkit_chat_form_label_text",c.appendChild(h)}f=_.type==="textarea"?document.createElement("textarea"):document.createElement("input"),_.type==="text_input"&&(f.type="text"),_.type==="textarea"&&(f.rows=_.rows||3),f.id=`form-${t(e.form_id)}-${t(_.id)}`,f.name=t(_.id),f.className="aipkit_form-input",_.placeholder&&(f.placeholder=t(_.placeholder)),_.required&&(f.required=!0),_.default_value!==void 0&&(f.value=t(String(_.default_value))),c.appendChild(f);break;case"dropdown":if(_.label){let h=document.createElement("label");h.setAttribute("for",`form-${t(e.form_id)}-${t(_.id)}`),h.textContent=t(_.label),h.className="aipkit_chat_form_label_text",c.appendChild(h)}f=document.createElement("select"),f.id=`form-${t(e.form_id)}-${t(_.id)}`,f.name=t(_.id),f.className="aipkit_form-input",_.required&&(f.required=!0),Array.isArray(_.options)&&_.options.forEach(h=>{let b=document.createElement("option");b.value=t(h.value),b.textContent=t(h.text),_.default_value===h.value&&(b.selected=!0),f.appendChild(b)}),c.appendChild(f);break;case"checkbox_group":case"radio_group":let m=document.createElement("fieldset");if(_.label){let h=document.createElement("legend");h.textContent=t(_.label),h.className="aipkit_chat_form_label_text",m.appendChild(h)}Array.isArray(_.options)&&_.options.forEach(h=>{let b=document.createElement("div");b.className=_.type==="checkbox_group"?"aipkit_form_checkbox_group_item":"aipkit_form_radio_group_item";let I=document.createElement("input");I.type=_.type==="checkbox_group"?"checkbox":"radio",I.id=`form-${t(e.form_id)}-${t(_.id)}-${t(h.value)}`,I.name=t(_.id)+(_.type==="checkbox_group"?"[]":""),I.value=t(h.value),(_.type==="checkbox_group"&&Array.isArray(_.default_value)&&_.default_value.includes(h.value)||_.type==="radio_group"&&_.default_value===h.value)&&(I.checked=!0);let y=document.createElement("label");y.setAttribute("for",I.id),y.textContent=t(h.text),b.appendChild(I),b.appendChild(y),m.appendChild(b)}),c.appendChild(m);break;case"heading":f=document.createElement(_.level||"h5"),f.className="aipkit_chat_form_element_heading",f.textContent=t(_.label||""),c.appendChild(f);break;case"label":f=document.createElement("p"),f.className="aipkit_chat_form_element_label_only",f.textContent=t(_.label||""),c.appendChild(f);break}if(_.help_text){let m=document.createElement("p");m.className="aipkit_form_help_text",m.textContent=t(_.help_text),c.appendChild(m)}p.appendChild(c)}),p.aipkitFieldMeta=l;let w=document.createElement("button");w.type="submit",w.className="aipkit_btn aipkit_chat_form_submit_btn",w.textContent=t(e.submit_button_text||"Submit"),p.appendChild(w),p.addEventListener("submit",_=>{if(typeof window.aipkit_chatUI_handleChatFormSubmission=="function"){let c=n.closest(".aipkit_chat_container")||n.closest(".aipkit_popup_wrapper"),f=null,g=null;c&&window.aipkitChatInstances&&window.aipkitChatInstances[c.id]?(f=window.aipkitChatInstances[c.id].elements,g=window.aipkitChatInstances[c.id].actions):window.aipkit_chat_ui_elements&&window.aipkit_chat_ui_actions&&(f=window.aipkit_chat_ui_elements,g=window.aipkit_chat_ui_actions),f&&g?window.aipkit_chatUI_handleChatFormSubmission(_,i,f,g):(console.error("AIPKit RenderChatForm: Could not find chat instance elements/actions for form submission. Form ID:",e.form_id),typeof window.aipkit_chatUI_showInlineNotice=="function"&&window.aipkit_chatUI_showInlineNotice("Error submitting form: Chat context not found.","error",{messagesEl:n,config:i},!0,7e3))}else console.error("AIPKit RenderChatForm: aipkit_chatUI_handleChatFormSubmission function not found."),typeof window.aipkit_chatUI_showInlineNotice=="function"&&window.aipkit_chatUI_showInlineNotice("Error submitting form: Submission handler missing.","error",{messagesEl:n,config:i},!0,7e3)}),u.appendChild(p),s.appendChild(u),r.appendChild(s),n.appendChild(r),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,!0)}window.aipkit_chatUI_renderChatForm=d})();(function(){"use strict";window.aipkitSttState={mediaRecorder:null,audioChunks:[],audioStream:null,currentMimeType:"",onRecordingStartCallback:()=>{},onRecordingStopCallback:(d,n)=>{},onRecordingErrorCallback:d=>{}}})();(function(){"use strict";function d(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&window.MediaRecorder)}window.aipkit_isMediaRecorderSupported=d})();(function(){"use strict";function d(n,e,i){if(!window.aipkitSttState){console.error("AIPKit STT Callbacks: State object not initialized.");return}window.aipkitSttState.onRecordingStartCallback=typeof n=="function"?n:()=>{},window.aipkitSttState.onRecordingStopCallback=typeof e=="function"?e:()=>{},window.aipkitSttState.onRecordingErrorCallback=typeof i=="function"?i:()=>{}}window.aipkit_setRecordingCallbacks=d})();(function(){"use strict";async function d(n={}){if(!window.aipkitSttState){console.error("AIPKit STT Start: State object not initialized."),typeof window.aipkit_setRecordingCallbacks=="function"&&window.aipkitSttState.onRecordingErrorCallback&&window.aipkitSttState.onRecordingErrorCallback(new Error("STT system not ready."));return}let e=window.aipkitSttState;if(typeof window.aipkit_isMediaRecorderSupported!="function"||!window.aipkit_isMediaRecorderSupported()){console.error("AIPKit STT Start: MediaRecorder API not supported by this browser."),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(new Error("Recording not supported."));return}if(e.mediaRecorder&&e.mediaRecorder.state==="recording"){console.warn("AIPKit STT Start: Recording is already in progress.");return}if(e.mediaRecorder&&e.mediaRecorder.state==="paused"){e.mediaRecorder.resume(),e.onRecordingStartCallback&&e.onRecordingStartCallback();return}e.audioChunks=[];try{e.audioStream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1});let i=["audio/webm;codecs=opus","audio/ogg;codecs=opus","audio/webm","audio/mp4","audio/mp3","audio/wav"],a="";for(let o of i)if(MediaRecorder.isTypeSupported(o)){a=o;break}if(!a&&MediaRecorder.isTypeSupported(""))a="";else if(!a)throw console.error("AIPKit STT Start: No suitable audio mimeType supported by MediaRecorder."),new Error("No supported audio format found.");let t=a?{mimeType:a}:{};e.mediaRecorder=new MediaRecorder(e.audioStream,t),e.currentMimeType=e.mediaRecorder.mimeType||a||"application/octet-stream",e.mediaRecorder.ondataavailable=o=>{o.data.size>0&&e.audioChunks.push(o.data)},e.mediaRecorder.onstop=()=>{if(e.audioChunks.length>0){let o=new Blob(e.audioChunks,{type:e.currentMimeType});e.onRecordingStopCallback&&e.onRecordingStopCallback(o,e.currentMimeType),e.audioStream&&(e.audioStream.getTracks().forEach(r=>r.stop()),e.audioStream=null)}else console.warn("AIPKit STT Start (onstop): Recording stopped, but no audio chunks received."),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(new Error("No audio data recorded.")),e.audioStream&&(e.audioStream.getTracks().forEach(o=>o.stop()),e.audioStream=null);e.audioChunks=[]},e.mediaRecorder.onerror=o=>{console.error("AIPKit STT Start (onerror): MediaRecorder error:",o.error),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(o.error),e.audioStream&&(e.audioStream.getTracks().forEach(r=>r.stop()),e.audioStream=null),e.audioChunks=[],e.mediaRecorder=null},e.mediaRecorder.start(),e.onRecordingStartCallback&&e.onRecordingStartCallback()}catch(i){console.error("AIPKit STT Start: Error accessing microphone or starting recorder:",i),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(i),e.audioStream&&(e.audioStream.getTracks().forEach(a=>a.stop()),e.audioStream=null)}}window.aipkit_startRecording=d})();(function(){"use strict";function d(){if(!window.aipkitSttState){console.error("AIPKit STT Stop: State object not initialized.");return}let n=window.aipkitSttState;n.mediaRecorder&&(n.mediaRecorder.state==="recording"||n.mediaRecorder.state==="paused")?n.mediaRecorder.stop():(console.warn("AIPKit STT Stop: stopRecording called but no active/paused recording found."),n.audioStream&&(n.audioStream.getTracks().forEach(e=>e.stop()),n.audioStream=null))}window.aipkit_stopRecording=d})();(function(){"use strict";function d(n,e,i){let{elements:a,config:t,state:o,setButtonStateAction:r,sendMessageAction:s}=i,{inputField:u,voiceInputButton:p}=a,l=(c,f="error",g=!0,m=7e3)=>{typeof window.aipkit_chatUI_showInlineNotice=="function"&&window.aipkit_chatUI_showInlineNotice(c,f,{elements:a,config:t},g,m)};if(!n||!e||!a||!t||!o||!r||!s){if(console.error("AIPKit STT UI (Transcribe): Missing required parameters for transcribeAudio.",i),l(t.text?.voiceConfigError||"Failed to process audio: Configuration error."),p){p.disabled=t.requireConsentCompliance&&!o.consentGiven,p.classList.remove("aipkit_loading");let c=p.querySelector(".dashicons");c&&(c.style.display="")}return}if(p){p.disabled=!0,p.classList.add("aipkit_loading");let c=p.querySelector(".dashicons");c&&(c.style.display="none")}let w=(e||"").split(";")[0].split("/")[1]||"webm",_={audio_file:n,audio_format:w};window.aipkit_frontendApiRequest("aipkit_transcribe_audio",_,t).then(c=>{if(c&&c.transcription)u.value=c.transcription,typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(u),r("send",!0,o),s(c.transcription);else throw new Error("Invalid transcription response from server.")}).catch(c=>{console.error(`AIPKit STT UI (${t.botId}): Transcription AJAX error:`,c),l(`${t.text?.voiceTranscriptionFailedPrefix||"Transcription failed"}: ${c.message||"Unknown error"}`)}).finally(()=>{if(p){p.disabled=t.requireConsentCompliance&&!o.consentGiven,p.classList.remove("aipkit_loading");let c=p.querySelector(".dashicons");c&&(c.style.display="")}})}window.aipkit_chatUI_transcribeAudio=d})();(function(){"use strict";function d(n,e,i,a,t){let{inputField:o,voiceInputButton:r,actionButton:s,inputActionButton:u}=n,p=e.botId,l=(w,_="error",c=!0,f=7e3)=>{typeof window.aipkit_chatUI_showInlineNotice=="function"&&window.aipkit_chatUI_showInlineNotice(w,_,{elements:n,config:e},c,f)};if(a&&typeof a.showConsentBoxIfNeeded=="function"&&a.showConsentBoxIfNeeded()){console.warn(`AIPKit Chat UI Main (${p}): Cannot record, consent required and box shown.`);return}if(e.requireConsentCompliance&&!i.consentGiven){console.warn(`AIPKit Chat UI Main (${p}): Consent required but not given (fallback check).`);return}if(typeof window.aipkit_startRecording!="function"||typeof window.aipkit_stopRecording!="function"||typeof window.aipkit_setRecordingCallbacks!="function"||typeof window.aipkit_isMediaRecorderSupported!="function"){console.error("AIPKit STT (Handle Action): Required recording functions not available from core STT scripts."),l(e.text?.voiceUnavailableScriptError||"Voice input is currently unavailable (script error).");return}if(!window.aipkit_isMediaRecorderSupported()){let w=window.location.protocol==="https:",_=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1";l(!w&&!_?e.text?.voiceRequiresHttps||"Voice recording requires HTTPS connection for security. Please access this site using HTTPS or contact the administrator to enable SSL.":e.text?.voiceBrowserUnsupported||"Voice recording is not supported by your browser. Please try a different browser like Chrome or Firefox.");return}i.isRecording?window.aipkit_stopRecording():(window.aipkit_setRecordingCallbacks(()=>{i.isRecording=!0,r.classList.add("aipkit_recording"),r.setAttribute("aria-label","Stop recording"),r.title="Stop recording",o.disabled=!0,s.disabled=!0,u&&(u.disabled=!0)},(w,_)=>{i.isRecording=!1,r.classList.remove("aipkit_recording"),r.setAttribute("aria-label","Voice input"),r.title="Voice input",o.disabled=e.requireConsentCompliance&&!i.consentGiven,s.disabled=o.value.trim()==="",u&&(u.disabled=!1),typeof window.aipkit_chatUI_transcribeAudio=="function"?window.aipkit_chatUI_transcribeAudio(w,_,{elements:n,config:e,state:i,setButtonStateAction:t.setButtonStateAction,sendMessageAction:t.sendMessageAction}):(console.error("AIPKit STT (Handle Action): transcribeAudio UI function not found."),l(e.text?.voiceProcessingError||"Error processing recorded audio."))},w=>{i.isRecording=!1,r.classList.remove("aipkit_recording"),r.setAttribute("aria-label","Voice input"),r.title="Voice input",o.disabled=e.requireConsentCompliance&&!i.consentGiven,s.disabled=o.value.trim()==="",u&&(u.disabled=!1),console.error(`AIPKit STT (${p}): Recording error:`,w),l(`${e.text?.voiceRecordingFailedPrefix||"Recording failed"}: ${w.message||"Unknown error"}`)}),window.aipkit_startRecording())}window.aipkit_chatUI_handleVoiceInputAction=d})();(function(){"use strict"})();(function(){"use strict";window.aipkitImageUploadConstants={MAX_IMAGE_SIZE_MB:20,MAX_IMAGE_SIZE_BYTES:20*1024*1024,ALLOWED_IMAGE_TYPES:["image/jpeg","image/png","image/webp"],ALLOWED_IMAGE_EXTENSIONS:[".jpg",".jpeg",".png",".webp"]}})();(function(){"use strict";window.aipkitImageUploadState={currentImageFile:null,currentImageBase64:null}})();(function(){"use strict";function d(n){let e=window.aipkitImageUploadConstants;return e?n?e.ALLOWED_IMAGE_TYPES.includes(n.type)?n.size>e.MAX_IMAGE_SIZE_BYTES?{isValid:!1,error:`Image is too large. Max size: ${e.MAX_IMAGE_SIZE_MB}MB.`}:{isValid:!0}:{isValid:!1,error:`Invalid file type. Please use ${e.ALLOWED_IMAGE_EXTENSIONS.join(", ")}.`}:{isValid:!1,error:"No file selected."}:(console.error("Image Upload Validate: Constants not loaded."),{isValid:!1,error:"Internal configuration error (constants missing)."})}window.aipkit_validateImage=d})();(function(){"use strict";function d(n){return new Promise((e,i)=>{let a=new FileReader;a.onload=()=>e(a.result),a.onerror=t=>i(t),a.readAsDataURL(n)})}window.aipkit_convertFileToBase64=d})();(function(){"use strict";function d(n){let e;n&&n.parentNode&&(e=n.parentNode.querySelector(".chat-image-upload-error")),e&&e.remove(),document.querySelectorAll(".chat-image-upload-error").forEach(i=>i.remove())}window.aipkit_clearImageUploadError=d})();(function(){"use strict";function d(n,e){typeof window.aipkit_clearImageUploadError=="function"?window.aipkit_clearImageUploadError(e):console.error("Image Upload Display Error: clearImageUploadError function not found.");let i=document.createElement("div");if(i.className="chat-image-upload-error",i.textContent=n,e&&e.parentNode)e.parentNode.insertBefore(i,e.nextSibling);else{let a=document.querySelector(".aipkit_chat_input");a?a.appendChild(i):console.warn("Image Upload Display Error: Could not find a suitable place to display error message.")}}window.aipkit_displayImageUploadError=d})();(function(){"use strict";function d(n,e){let i=window.aipkitImageUploadState;if(!i){console.error("Image Upload Reset: State object not found.");return}i.currentImageFile=null,i.currentImageBase64=null,n&&(n.hasChildNodes()?(n.classList.add("aipkit-image-preview-fade-out"),setTimeout(()=>{n&&(n.innerHTML="",n.style.display="none",n.classList.remove("aipkit-image-preview-fade-out"))},300)):(n.innerHTML="",n.style.display="none")),e&&(e.value=""),typeof window.aipkit_clearImageUploadError=="function"?window.aipkit_clearImageUploadError(n||e):console.error("Image Upload Reset: clearImageUploadError function not found."),document.dispatchEvent(new CustomEvent("chatImageReset"))}window.aipkit_resetImageUpload=d})();(function(){"use strict";function d(n,e){if(!e)return;e.innerHTML="",e.style.display="block",e.classList.remove("aipkit-image-preview-fade-out");let i=document.createElement("div");i.className="chat-image-thumbnail-wrapper";let a=document.createElement("img");a.src=n,a.alt="Image preview",a.className="chat-image-thumbnail";let t=document.createElement("button");t.className="chat-image-remove-button",t.innerHTML="\xD7",t.setAttribute("aria-label","Remove image"),t.type="button",t.onclick=()=>{let o=e.closest(".aipkit_chat_input")?.querySelector(".aipkit_chat_image_upload_input");typeof window.aipkit_resetImageUpload=="function"?window.aipkit_resetImageUpload(e,o):console.error("Image Upload Render Preview: resetImageUpload function not found."),document.dispatchEvent(new CustomEvent("chatImageRemoved"))},i.appendChild(a),i.appendChild(t),e.appendChild(i)}window.aipkit_renderImagePreview=d})();(function(){"use strict";function d(){let n=window.aipkitImageUploadState;return n?n.currentImageFile&&n.currentImageBase64?{mime_type:n.currentImageFile.type,base64_data:n.currentImageBase64.split(",")[1]}:null:(console.error("Image Upload Get Data: State object not found."),null)}window.aipkit_getImageUploadData=d})();(function(){"use strict";function d(){let n=window.aipkitImageUploadConstants;return n?n.ALLOWED_IMAGE_EXTENSIONS:(console.error("Image Upload Get Extensions: Constants not loaded."),[".jpg",".jpeg",".png",".webp"])}window.aipkit_getAllowedImageExtensions=d})();(function(){"use strict";function d(){let n=window.aipkitImageUploadConstants;return n?n.MAX_IMAGE_SIZE_MB:(console.error("Image Upload Get Max Size: Constants not loaded."),20)}window.aipkit_getMaxImageSizeMB=d})();(function(){"use strict";function d(n,e){let i=window.aipkitImageUploadState,a=window.aipkitImageUploadConstants;if(!i||!a){console.error("Chat Image Upload Init: State or Constants not loaded.");return}if(!n||!e){console.error("Chat Image Upload Init: File input or preview container not provided for initialization.");return}if(typeof window.aipkit_validateImage!="function"||typeof window.aipkit_convertFileToBase64!="function"||typeof window.aipkit_displayImageUploadError!="function"||typeof window.aipkit_clearImageUploadError!="function"||typeof window.aipkit_renderImagePreview!="function"||typeof window.aipkit_resetImageUpload!="function"){console.error("Chat Image Upload Init: One or more helper functions are missing.");return}n.setAttribute("accept",a.ALLOWED_IMAGE_EXTENSIONS.join(",")),n.dataset.aipkitUploadListenerAttached!=="true"&&(n.addEventListener("change",async t=>{window.aipkit_clearImageUploadError(e);let o=t.target.files[0];if(!o){window.aipkit_resetImageUpload(e,n);return}let r=window.aipkit_validateImage(o);if(!r.isValid){window.aipkit_displayImageUploadError(r.error,e),window.aipkit_resetImageUpload(e,n),document.dispatchEvent(new CustomEvent("chatImageValidationFailed",{detail:{error:r.error}}));return}try{let s=await window.aipkit_convertFileToBase64(o);i.currentImageBase64=s,i.currentImageFile=o,window.aipkit_renderImagePreview(i.currentImageBase64,e),document.dispatchEvent(new CustomEvent("chatImageReady",{detail:{base64_data:i.currentImageBase64.split(",")[1],mime_type:i.currentImageFile.type}}))}catch(s){console.error("Error processing image:",s),window.aipkit_displayImageUploadError("Could not process image. Please try again.",e),window.aipkit_resetImageUpload(e,n),document.dispatchEvent(new CustomEvent("chatImageProcessingFailed",{detail:{error:"Could not process image."}}))}}),n.dataset.aipkitUploadListenerAttached="true")}window.chatImageUpload={init:d,getImageData:function(){return typeof window.aipkit_getImageUploadData=="function"?window.aipkit_getImageUploadData():(console.error("chatImageUpload: getImageData helper not found."),null)},reset:function(n,e){typeof window.aipkit_resetImageUpload=="function"?window.aipkit_resetImageUpload(n,e):console.error("chatImageUpload: resetUpload helper not found.")},getAllowedImageExtensions:function(){return typeof window.aipkit_getAllowedImageExtensions=="function"?window.aipkit_getAllowedImageExtensions():(console.error("chatImageUpload: getAllowedImageExtensions helper not found."),[])},getMaxImageSizeMB:function(){return typeof window.aipkit_getMaxImageSizeMB=="function"?window.aipkit_getMaxImageSizeMB():(console.error("chatImageUpload: getMaxImageSizeMB helper not found."),20)}}})();(function(){"use strict";window.aipkitFileUploadConstants={MAX_FILE_SIZE_MB:20,MAX_FILE_SIZE_BYTES:20*1024*1024,ALLOWED_FILE_TYPES:["text/plain","application/pdf"],ALLOWED_FILE_EXTENSIONS:[".txt",".pdf"]}})();(function(){"use strict";function d(){window.aipkitFileUploadState={currentFile:null}}window.aipkit_initFileUploadState=d;function n(e,i){window.aipkitFileUploadState&&(window.aipkitFileUploadState.currentFile=null),e&&(e.value=""),typeof window.aipkit_clearChatFileUploadStatus=="function"&&i&&window.aipkit_clearChatFileUploadStatus(i)}window.aipkit_resetChatFileUploadUI=n})();(function(){"use strict";function d(n){let e=window.aipkitFileUploadConstants;return e?n?e.ALLOWED_FILE_TYPES.includes(n.type)?n.size>e.MAX_FILE_SIZE_BYTES?{isValid:!1,error:`File is too large. Max size: ${e.MAX_FILE_SIZE_MB}MB.`}:{isValid:!0}:{isValid:!1,error:`Invalid file type. Please use ${e.ALLOWED_FILE_EXTENSIONS.join(", ")}.`}:{isValid:!1,error:"No file selected."}:(console.error("Chat File Upload Validate: Constants not loaded."),{isValid:!1,error:"Internal configuration error (file constants missing)."})}window.aipkit_validateChatFile=d})();(function(){"use strict";function d(n){if(!n)return;let e=n.querySelector(".aipkit_chat_file_upload_status");e&&(e.textContent="",e.style.display="none",e.className="aipkit_chat_file_upload_status")}window.aipkit_clearChatFileUploadStatus=d})();(function(){"use strict";function d(n,e="info",i){if(!i)return;let a=i.querySelector(".aipkit_chat_file_upload_status");if(!a){a=document.createElement("div"),a.className="aipkit_chat_file_upload_status";let t=i.querySelector(".aipkit_chat_input_wrapper");t?i.insertBefore(a,t):i.appendChild(a)}if(a.textContent=n,a.className="aipkit_chat_file_upload_status",a.classList.add(`aipkit_status-${e}`),a.style.display="block",e==="error")try{let t=i.closest(".aipkit_chat_container");if(!t)return;let o=window.aipkitChatInstances&&t.id?window.aipkitChatInstances[t.id]:null,r=null,s=null;if(o&&o.internalElements&&o.internalElements.messagesEl&&o.internalActions){r=o.internalElements.messagesEl;let c=t.getAttribute("data-config");if(c)try{s=JSON.parse(c)}catch{}}else{r=t.querySelector(".aipkit_chat_messages");let c=t.getAttribute("data-config");if(c)try{s=JSON.parse(c)}catch{}}if(!r)return;s||(s={botId:t.dataset.botId||"default",text:{errorPrefix:"Error:"}});let u=s.text&&s.text.errorPrefix?s.text.errorPrefix:"Error:",p=String(n||"").trim(),w=p.toLowerCase().startsWith(u.toLowerCase())?p:`${u} ${p}`,_=typeof window.aipkit_generateClientMessageId=="function"?window.aipkit_generateClientMessageId(s.botId):null;typeof window.aipkit_chatUI_appendMessage=="function"&&window.aipkit_chatUI_appendMessage(r,w,"bot",s,!0,!1,_,!0)}catch(t){console.error("AIPKit Chat File Upload: Failed to append error to chat window:",t)}}window.aipkit_displayChatFileUploadStatus=d})();(function(){"use strict";function d(){let n=window.aipkitFileUploadConstants;return n?n.ALLOWED_FILE_EXTENSIONS:(console.error("File Upload Get Extensions: Constants not loaded."),[".txt",".pdf"])}window.aipkit_getAllowedFileExtensions=d})();(function(){"use strict";function d(){let n=window.aipkitFileUploadConstants;return n?n.MAX_FILE_SIZE_MB:(console.error("File Upload Get Max Size: Constants not loaded."),2)}window.aipkit_getMaxFileSizeMB=d})();(function(){"use strict";typeof window.aipkit_initFileUploadState=="function"?window.aipkit_initFileUploadState():console.error("File Upload Init: State initializer (aipkit_initFileUploadState) not found.");let d=window.aipkit_escapeHtml||function(e){return e};async function n(e,i,a,t){let o=window.aipkitFileUploadState,r=window.aipkitFileUploadConstants;if(!o||!r)return console.error("Chat File Upload Init Processing: State or Constants not loaded."),typeof window.aipkit_displayChatFileUploadStatus=="function"&&window.aipkit_displayChatFileUploadStatus("File upload system error.","error",a),null;let s=["aipkit_validateChatFile","aipkit_displayChatFileUploadStatus","aipkit_clearChatFileUploadStatus","aipkit_resetChatFileUploadUI"];for(let l of s)if(typeof window[l]!="function")return console.error(`Chat File Upload Init Processing: Missing required helper function: ${l}.`),typeof window.aipkit_displayChatFileUploadStatus=="function"&&window.aipkit_displayChatFileUploadStatus("File upload component error.","error",a),null;window.aipkit_clearChatFileUploadStatus(a);let u=window.aipkit_validateChatFile(e);if(!u.isValid)return window.aipkit_displayChatFileUploadStatus(u.error,"error",a),window.aipkit_resetChatFileUploadUI(i,a),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),null;if(t.vectorStoreProvider==="claude_files"&&t.provider!=="Claude")return window.aipkit_displayChatFileUploadStatus('Claude Files requires the chatbot "Provider" to be Claude.',"error",a),window.aipkit_resetChatFileUploadUI(i,a),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),null;o.currentFile=e,window.aipkit_displayChatFileUploadStatus(`Uploading "${d(o.currentFile.name)}"...`,"processing",a);let p=new FormData;p.append("action","aipkit_frontend_chat_upload_file"),p.append("file_to_upload",o.currentFile),p.append("bot_id",t.botId),p.append("conversation_uuid",window.aipkit_current_conversation_uuid||""),window.aipkit_guest_uuid&&(!window.aipkit_current_user_id||window.aipkit_current_user_id===0)&&p.append("session_id",window.aipkit_guest_uuid),window.aipkit_current_post_id&&p.append("post_id",window.aipkit_current_post_id),p.append("upload_provider",t.vectorStoreProvider),p.append("_ajax_nonce",t.nonce);try{let l=await fetch(t.ajaxUrl,{method:"POST",body:p,credentials:"same-origin"}),w=await l.json();if(!l.ok||!w.success){let _=w.data?.message||w.message||"File upload failed on server.";throw new Error(_)}if(w.data&&w.data.file_context){let _=w.data.file_context;if(window.aipkit_current_conversation_uuid)try{localStorage.setItem(`aipkit_file_context_${window.aipkit_current_conversation_uuid}`,JSON.stringify(_))}catch(f){console.error("AIPKit File Upload: Error saving file context to localStorage:",f)}window.aipkit_active_file_context_provider=_.provider,window.aipkit_active_file_context_data=_,sessionStorage.setItem("aipkit_active_file_context_provider",window.aipkit_active_file_context_provider),sessionStorage.setItem("aipkit_active_file_context_data",JSON.stringify(window.aipkit_active_file_context_data));let c=(t.text?.fileContextActive||"Chatting with: %s").replace("%s",d(o.currentFile.name));return window.aipkit_displayChatFileUploadStatus(c,"success",a),document.dispatchEvent(new CustomEvent("aipkit:fileContextUpdated",{detail:window.aipkit_active_file_context_data})),window.aipkit_active_file_context_data}else throw new Error("Server did not return file context after upload.")}catch(l){return console.error("File Upload Processing Error:",l),window.aipkit_displayChatFileUploadStatus(`Error: ${l.message||"Upload failed."}`,"error",a),window.aipkit_resetChatFileUploadUI(i,a),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),null}}window.aipkitChatFileUpload={processFile:n,resetUI:function(e,i){typeof window.aipkit_resetChatFileUploadUI=="function"&&window.aipkit_resetChatFileUploadUI(e,i)},getAllowedFileExtensions:function(){return typeof window.aipkit_getAllowedFileExtensions=="function"?window.aipkit_getAllowedFileExtensions():[]},getMaxFileSizeMB:function(){return typeof window.aipkit_getMaxFileSizeMB=="function"?window.aipkit_getMaxFileSizeMB():2}}})();(function(){"use strict";function d(n,e,i,a,t=!1){let{inputField:o,actionButton:r,sendIcon:s,clearIcon:u,spinner:p,voiceInputButton:l,inputActionButton:w,webSearchToggleButton:_,googleSearchGroundingToggleButton:c}=e,f=i.text||{},g=(h,b)=>{!h||typeof h.setAttribute!="function"||typeof h.removeAttribute!="function"||(b?h.setAttribute("hidden","hidden"):h.removeAttribute("hidden"))};if(!r||!s||!u||!p||!o)return console.error("AIPKit SetButtonState: Missing required elements."),null;g(p,!0),g(s,!0),g(u,!0),r.disabled=!1,r.classList.remove("aipkit_btn-clear-state");let m=n;switch(n){case"sending":case"streaming":o.disabled=!0,r.disabled=!0,l&&(l.disabled=!0),w&&(w.disabled=!0),_&&(_.disabled=!0),c&&(c.disabled=!0),g(p,!1);let h=n==="streaming"?f.streaming||"Streaming...":f.sending||"Sending...";r.setAttribute("aria-label",h),r.setAttribute("title",h);break;case"clear":o.disabled=i.requireConsentCompliance&&!a.consentGiven,g(u,!1),r.classList.add("aipkit_btn-clear-state"),r.setAttribute("aria-label",f.clearChat||"Clear Chat"),r.setAttribute("title",f.clearChat||"Clear Chat"),r.disabled=!1,l&&(l.disabled=i.requireConsentCompliance&&!a.consentGiven),w&&(w.disabled=i.requireConsentCompliance&&!a.consentGiven),_&&(_.disabled=i.requireConsentCompliance&&!a.consentGiven),c&&(c.disabled=i.requireConsentCompliance&&!a.consentGiven);break;case"send":default:m="send",o.disabled=i.requireConsentCompliance&&!a.consentGiven,g(s,!1),r.setAttribute("aria-label",f.sendMessage||"Send Message"),r.setAttribute("title",f.sendMessage||"Send Message"),r.disabled=!t&&o.value.trim()==="",i.requireConsentCompliance&&!a.consentGiven&&(r.disabled=!0),l&&(l.disabled=i.requireConsentCompliance&&!a.consentGiven),w&&(w.disabled=i.requireConsentCompliance&&!a.consentGiven),_&&(_.disabled=i.requireConsentCompliance&&!a.consentGiven),c&&(c.disabled=i.requireConsentCompliance&&!a.consentGiven);break}return m}window.aipkit_chatUI_setButtonStateAction=d})();(function(){"use strict";function d(n,e,i){if(!n)return;let a=n.closest("#aipkit_admin_chat_preview_container"),t=window.innerWidth<=760;e.requireConsentCompliance&&!i.consentGiven||e.popupEnabled&&!i.isPopupOpen||((a||!t||i.userInitiatedAction)&&setTimeout(()=>{n&&typeof n.focus=="function"&&n.focus()},50),i.userInitiatedAction&&(i.userInitiatedAction=!1))}window.aipkit_chatUI_focusInputAction=d})();(function(){"use strict";function d(n,e,i,a,t,o){let{inputField:r,messagesEl:s,container:u,voiceInputButton:p,inputActionButton:l,webSearchToggleButton:w,googleSearchGroundingToggleButton:_}=i;t.isSending=!1,t.currentStreamId=null,t.currentStreamMessageId=null,r.disabled=a.requireConsentCompliance&&!t.consentGiven,p&&(p.disabled=a.requireConsentCompliance&&!t.consentGiven),l&&(l.disabled=a.requireConsentCompliance&&!t.consentGiven),w&&a.allowWebSearchTool&&(a.provider==="OpenAI"||a.provider==="Claude"||a.provider==="OpenRouter")&&(w.disabled=a.requireConsentCompliance&&!t.consentGiven),_&&a.allowGoogleSearchGrounding&&a.provider==="Google"&&(_.disabled=a.requireConsentCompliance&&!t.consentGiven);let c=r.value.trim()==="",f=s.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").length>0;t.buttonState=o.setButtonStateAction(c&&f?"clear":"send",!1,t),o.focusInputAction(),u.dispatchEvent(new CustomEvent("aipkit:messageReceived",{detail:{messageId:n,conversationUUID:window.aipkit_current_conversation_uuid,newConversation:e}})),a.ttsEnabled&&a.ttsAutoPlay&&n&&setTimeout(()=>{let m=s.querySelector(`#${CSS.escape(n)}`)?.querySelector(".aipkit_play_btn");m&&typeof window.aipkit_handlePlayAction=="function"?window.aipkit_handlePlayAction(m):a.ttsEnabled&&a.ttsAutoPlay&&console.warn(`AIPKit AutoPlay (${a.botId}): Could not find play button for message ${n} or play action is missing.`)},100)}window.aipkit_chatUI_handleCompletion=d})();(function(){"use strict";function d(n,e,i=!0,a,t,o,r){let{messagesEl:s,inputField:u,container:p,voiceInputButton:l,inputActionButton:w,webSearchToggleButton:_,googleSearchGroundingToggleButton:c}=a,f=t.botId;o.isSending=!1,o.currentStreamId=null,o.currentStreamMessageId=null;let g=window.aipkit_generateClientMessageId(f);window.aipkit_chatUI_appendMessage(s,n,"bot",t,!0,!1,g,i),window.aipkit_chatUI_removeTypingIndicator(s),u.disabled=t.requireConsentCompliance&&!o.consentGiven,l&&(l.disabled=t.requireConsentCompliance&&!o.consentGiven),w&&(w.disabled=t.requireConsentCompliance&&!o.consentGiven),_&&t.allowWebSearchTool&&(t.provider==="OpenAI"||t.provider==="Claude"||t.provider==="OpenRouter")&&(_.disabled=t.requireConsentCompliance&&!o.consentGiven),c&&t.allowGoogleSearchGrounding&&t.provider==="Google"&&(c.disabled=t.requireConsentCompliance&&!o.consentGiven),o.buttonState=r.setButtonStateAction("send",!1,o),r.focusInputAction(),p.dispatchEvent(new CustomEvent("aipkit:messageError",{detail:{messageId:g,error:n}}))}window.aipkit_chatUI_handleError=d})();(function(){"use strict";function d(n){if(!n)return;n.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").forEach(i=>{try{n.removeChild(i)}catch(a){a.name!=="NotFoundError"&&console.warn("AIPKit clearMessages: Error removing node:",a)}}),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,!0)}window.aipkit_chatUI_clearMessages=d})();(function(){"use strict";function d(n,e,i,a){let{messagesEl:t,inputField:o,imagePreviewContainer:r,imageUploadInput:s,fileUploadInput:u,inputArea:p}=n;typeof window.aipkit_chatUI_removeTypingIndicator!="function"?console.error("AIPKit Clear Action: Dependency window.aipkit_chatUI_removeTypingIndicator not found."):window.aipkit_chatUI_removeTypingIndicator(t),typeof window.aipkit_chatUI_clearMessages!="function"?console.error("AIPKit Clear Action: Dependency window.aipkit_chatUI_clearMessages not found."):window.aipkit_chatUI_clearMessages(t);let l=t.querySelector(".aipkit_initial_greeting");if(!l&&typeof window.aipkit_chatUI_appendMessage=="function"){let c=(e?.text?.initialGreeting||"Hello there!").trim(),f=(e?.text?.initialSubgreeting||"").trim(),g=c;f&&(g=c?`${c}

${f}`:f),typeof window.aipkit_generateClientMessageId=="function"?window.aipkit_chatUI_appendMessage(t,g,"bot",e,!1,!0,window.aipkit_generateClientMessageId(e.botId)):console.error("AIPKit Clear Action: window.aipkit_generateClientMessageId is missing, cannot append initial greeting reliably.")}else l||console.error("AIPKit Clear Action: Initial greeting missing after clear, and appendMessage function unavailable.");o&&(o.value="",o.disabled=e.requireConsentCompliance&&!i.consentGiven,typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(o)),e.imageUploadEnabledUI&&window.chatImageUpload&&typeof window.chatImageUpload.reset=="function"?n.imagePreviewContainer&&n.imageUploadInput?window.chatImageUpload.reset(n.imagePreviewContainer,n.imageUploadInput):console.warn("AIPKit Clear Action: Image upload UI reset skipped, preview or input element missing from 'elements' object passed to clearChatAction."):e.imageUploadEnabledUI&&typeof window.chatImageUpload>"u"&&console.warn("AIPKit Clear Action: Image upload UI reset skipped, chatImageUpload script not loaded."),e.fileUploadEnabledUI&&window.aipkitChatFileUpload&&typeof window.aipkitChatFileUpload.resetUI=="function"?n.fileUploadInput&&n.inputArea?window.aipkitChatFileUpload.resetUI(n.fileUploadInput,n.inputArea):console.warn("AIPKit Clear Action: File upload UI reset skipped, file input or input area missing from 'elements' object."):e.fileUploadEnabledUI&&typeof window.aipkitChatFileUpload>"u"&&console.warn("AIPKit Clear Action: File upload UI reset skipped, aipkitChatFileUpload script not loaded."),typeof a.setButtonStateAction=="function"?i.buttonState=a.setButtonStateAction("send",!1):console.error("AIPKit Clear Action: actions.setButtonStateAction function not provided.");let w=e.webToggleDefaultOn===!0;typeof window.aipkit_syncWebSearchToggleState=="function"&&window.aipkit_syncWebSearchToggleState(n,e,i,w),typeof window.aipkit_syncGoogleSearchGroundingToggleState=="function"&&window.aipkit_syncGoogleSearchGroundingToggleState(n,e,i,w),i.isSending=!1,i.currentStreamId=null,i.currentStreamMessageId=null,window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,sessionStorage.removeItem("aipkit_current_conversation_uuid"),window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),typeof window.aipkit_regenerateConversationUUID=="function"&&window.aipkit_regenerateConversationUUID(),typeof a.focusInputAction=="function"&&(!e.requireConsentCompliance||i.consentGiven)?a.focusInputAction():typeof a.focusInputAction!="function"&&console.error("AIPKit Clear Action: actions.focusInputAction function not provided.");let _=t.closest(".aipkit_chat_container")||t.closest(".aipkit_popup_wrapper");_&&_.dispatchEvent(new CustomEvent("aipkit:chatCleared"))}window.aipkit_chatUI_clearChatAction=d})();(function(){"use strict";async function d(n,e,i,a,t=null){let{inputField:o,messagesEl:r,container:s,inputArea:u}=n,p=e.botId,l=null;if(window.aipkit_active_file_context_data&&typeof window.aipkit_active_file_context_data=="object"&&window.aipkit_active_file_context_data!==null&&Object.keys(window.aipkit_active_file_context_data).length>0&&window.aipkit_active_file_context_data.provider){let y=!1,v=window.aipkit_active_file_context_data;(v.provider==="OpenAI"&&v.vector_store_id||v.provider==="Pinecone"&&v.index_name&&v.namespace||v.provider==="Qdrant"&&v.collection_name&&v.file_upload_context_id||v.provider==="Claude"&&v.file_id)&&(y=!0),y?l={...v}:(console.warn(`SendMessageAction (${p}): File context data found on window object, but missing required fields for provider: ${v.provider||"unknown"}. Context ignored. Data:`,v),l=null)}let w=null;if(e.imageUploadEnabledUI&&window.chatImageUpload&&typeof window.chatImageUpload.getImageData=="function"&&(w=window.chatImageUpload.getImageData(),w&&n.imagePreviewContainer&&n.imageUploadInput&&typeof window.chatImageUpload.reset=="function"&&window.chatImageUpload.reset(n.imagePreviewContainer,n.imageUploadInput)),window.aipkitChatFileUpload&&typeof window.aipkitChatFileUpload.resetUI=="function"&&n.fileUploadInput&&u){let y=window.aipkitFileUploadState;(l||y&&y.currentFile)&&window.aipkitChatFileUpload.resetUI(n.fileUploadInput,u)}let _=i.consentUIInstance;if(_&&typeof _.showConsentBoxIfNeeded=="function"&&_.showConsentBoxIfNeeded()){console.warn(`AIPKit SendMessage (${p}): Cannot send message, consent required and box shown.`);return}if(e.requireConsentCompliance&&!i.consentGiven){console.warn(`AIPKit SendMessage (${p}): Consent required but not given.`);return}let c=t!==null?t.trim():o.value.trim();if(i.isSending||!c&&!w&&!l||t===null&&(i.buttonState!=="send"||n.actionButton.disabled))return;let f=!1;(window.aipkit_is_fresh_session||!window.aipkit_current_conversation_uuid)&&(typeof window.aipkit_regenerateConversationUUID=="function"&&(window.aipkit_current_conversation_uuid||(window.aipkit_regenerateConversationUUID(),window.aipkit_active_file_context_data&&typeof window.aipkit_active_file_context_data=="object"&&window.aipkit_active_file_context_data!==null&&Object.keys(window.aipkit_active_file_context_data).length>0&&window.aipkit_active_file_context_data.provider&&(l={...window.aipkit_active_file_context_data}))),f=!0);let g=window.aipkit_generateClientMessageId(p),m=c;w&&(m={text:c,user_image:w}),window.aipkit_chatUI_appendMessage(r,m,"user",e,!1,!1,g,!0),t===null&&(o.value="",typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(o)),f&&(window.aipkit_is_fresh_session=!1);let h=(e.imageTriggers||"/image").toLowerCase().split(",").map(y=>y.trim()).filter(y=>y.length>0&&y.startsWith("/")),b=c.toLowerCase(),I=null;for(let y of h)if(b.startsWith(y+" ")||b===y){I=y;break}if(I){let y=c.substring(I.length).trim();if(!y&&b!==I){let v=(e.text.imageCommandEmptyPrompt||"Please provide description after /image.").replace("[trigger]",I);a.handleError(v,!1,!0),t===null&&(i.buttonState=a.setButtonStateAction("send",!1));return}typeof window.aipkit_chatUI_handleImageGeneration=="function"?window.aipkit_chatUI_handleImageGeneration(y,c,g,f,{state:i,elements:n,config:e,...a}):(console.error("AIPKit SendMessage: aipkit_chatUI_handleImageGeneration function not found."),a.handleError("Image generation feature unavailable.",!1,!0));return}if(typeof window.aipkit_checkMessageModeration=="function"){let y=window.aipkit_checkMessageModeration(c,e.userIp,e.bannedIpsConfig,e.bannedWordsConfig);if(y){let v=window.aipkit_generateClientMessageId(p);window.aipkit_chatUI_appendMessage(r,y.message,"bot",e,!0,!1,v),i.buttonState=a.setButtonStateAction("send",!1),a.focusInputAction(),s.dispatchEvent(new CustomEvent("aipkit:messageBlocked",{detail:{messageId:v,reason:y.type,content:c,...y.word&&{word:y.word},...y.ip&&{ip:y.ip}}}));return}}if(i.isSending=!0,o.disabled=!0,n.voiceInputButton&&(n.voiceInputButton.disabled=!0),n.inputActionButton&&(n.inputActionButton.disabled=!0),n.webSearchToggleButton&&(n.webSearchToggleButton.disabled=!0),n.googleSearchGroundingToggleButton&&(n.googleSearchGroundingToggleButton.disabled=!0),i.buttonState=a.setButtonStateAction(e.streamEnabled?"streaming":"sending",!0),s.dispatchEvent(new CustomEvent("aipkit:messageSent",{detail:{messageId:g}})),e.streamEnabled&&typeof window.aipkit_chatUI_streamMessage=="function")window.aipkit_chatUI_showTypingIndicator(r,e),window.aipkit_chatUI_streamMessage(c,p,e,r,a.handleError,()=>a.handleCompletion(i.currentStreamMessageId,f),i.webSearchToolActive,i.googleSearchGroundingActive,w,l,g);else if(!e.streamEnabled&&typeof window.aipkit_chatUI_sendMessage=="function")window.aipkit_chatUI_showTypingIndicator(r,e),window.aipkit_chatUI_sendMessage(c,p,e,n,(y,v,U,x)=>{window.aipkit_chatUI_removeTypingIndicator(r),window.aipkit_chatUI_appendMessage(r,y,"bot",e,!1,!1,v,!0,x),a.handleCompletion(v,f)},a.handleError,()=>{},i.webSearchToolActive,i.googleSearchGroundingActive,w,l,g);else{let y=e.streamEnabled?e.text.streamError||"Streaming function not loaded.":e.text.connError||"Send message function not loaded.";console.error(`AIPKit SendMessage (${p}): Required send function not available.`),a.handleError(y,!1)}}window.aipkit_chatUI_sendMessageAction=d})();(function(){"use strict";let d=new Set(["primary_color","secondary_color","auto_text_contrast","accent_color","app_bg_color","surface_color","text_color","border_color"]),n=new Set(["font_family","bubble_border_radius","container_border_radius"]),e=new Set(["container_max_width","popup_width","container_height","container_min_height","container_max_height","popup_height","popup_min_height","popup_max_height"]),i=new Set([...d,...n,...e]);function a(m,h,b){return Number.isNaN(m)?h:Math.min(Math.max(m,h),b)}function t(m){if(!m||typeof m!="string")return null;let h=m.trim().toLowerCase();if(h==="transparent")return{r:0,g:0,b:0,a:0};if(h[0]==="#"){let F=h.slice(1);if(F.length===3&&(F=F.split("").map(S=>S+S).join("")),F.length!==6)return null;let k=parseInt(F,16);return Number.isNaN(k)?null:{r:k>>16&255,g:k>>8&255,b:k&255,a:1}}let b=h.match(/^rgba?\((.+)\)$/);if(!b)return null;let I=b[1].split(",").map(F=>F.trim());if(I.length<3)return null;let y=F=>{if(F.endsWith("%")){let S=parseFloat(F);return Number.isNaN(S)?null:a(Math.round(255*S/100),0,255)}let k=parseFloat(F);return Number.isNaN(k)?null:a(Math.round(k),0,255)},v=y(I[0]),U=y(I[1]),x=y(I[2]);if(v===null||U===null||x===null)return null;let M=1;if(I[3]!==void 0){let F=parseFloat(I[3]);Number.isNaN(F)||(M=a(F,0,1))}return{r:v,g:U,b:x,a:M}}function o(m){if(!m)return"";if(typeof m=="string")return m;let h=a(Math.round(m.r),0,255),b=a(Math.round(m.g),0,255),I=a(Math.round(m.b),0,255),y=m.a===void 0?1:a(m.a,0,1);if(y>=1)return`rgb(${h}, ${b}, ${I})`;let v=Math.round(y*1e3)/1e3;return`rgba(${h}, ${b}, ${I}, ${v})`}function r(m,h,b){let I=a(b,0,1);return{r:m.r*(1-I)+h.r*I,g:m.g*(1-I)+h.g*I,b:m.b*(1-I)+h.b*I,a:1}}function s(m,h){return{r:m.r,g:m.g,b:m.b,a:a(h,0,1)}}function u(m,h){if(!m||!h)return!1;let b=m.a===void 0?1:m.a,I=h.a===void 0?1:h.a;return Math.round(m.r)===Math.round(h.r)&&Math.round(m.g)===Math.round(h.g)&&Math.round(m.b)===Math.round(h.b)&&Math.abs(b-I)<.01}function p(m){let h=m/255;return h<=.03928?h/12.92:Math.pow((h+.055)/1.055,2.4)}function l(m){return .2126*p(m.r)+.7152*p(m.g)+.0722*p(m.b)}function w(m,h){let b=l(m),I=l(h),y=Math.max(b,I),v=Math.min(b,I);return(y+.05)/(v+.05)}function _(m,h,b){let I=w(m,h),y=w(m,b);return I>=y?h:b}function c(m){let h={primary:"#0F766E",secondary:"#ECFEFF",legacyAccent:"#111111",legacyAppBg:"#FFFFFF",legacySurface:"#FFFFFF",legacyText:"#111111",legacyBorder:"#E5E5E5",botBubble:"#F3F3F3"},b={primary:t(h.primary),secondary:t(h.secondary),legacyAccent:t(h.legacyAccent),legacyAppBg:t(h.legacyAppBg),legacySurface:t(h.legacySurface),legacyText:t(h.legacyText),legacyBorder:t(h.legacyBorder),botBubble:t(h.botBubble)},I=t(m.primary_color),y=t(m.secondary_color),v=t(m.accent_color),U=t(m.app_bg_color),x=t(m.surface_color),M=v&&!u(v,b.legacyAccent),F=x&&!u(x,b.legacySurface)||U&&!u(U,b.legacyAppBg),k=null;I&&(!u(I,b.primary)||!M)?k=I:M?k=v:I?k=I:k=b.primary;let S=null;y&&(!u(y,b.secondary)||!F)?S=y:x&&!u(x,b.legacySurface)?S=x:U&&!u(U,b.legacyAppBg)?S=U:y?S=y:S=b.secondary;let A=m.auto_text_contrast!=="0",C={r:255,g:255,b:255,a:1},E={r:17,g:17,b:17,a:1},T=t(m.text_color),q=T&&!u(T,b.legacyText),L=!A&&q?T:_(S,C,E),H=l(S)<.5,O=S,D=r(O,L,H?.12:.06),B=t(m.border_color),$=B&&!u(B,b.legacyBorder)?B:r(O,L,H?.22:.12),K=r(L,O,H?.35:.18),G=r(L,O,H?.5:.35),Q=t(m.bot_bubble_bg_color)||r(D,L,H?.18:.08),P=t(m.user_bubble_bg_color)||k,N=A?_(k,C,E):L,V=A&&w(k,D)>=3?k:L,z=A?_(Q,C,E):L,X=A?_(P,C,E):L,J=r(O,L,H?.18:.08),te=r(O,k,H?.22:.12),Y=r(O,L,H?.12:.04),j=r(L,O,H?.3:.12),ee=A?_(te,C,E):L,ie=O,ne=J,ae=A?_(ie,C,E):L,ce=A?_(ne,C,E):L,le=l(k)<.5,oe=r(k,le?C:E,.12),de=k,re=s(k,.2),se=r(O,k,H?.2:.12),pe=s(N,.3);return{container_bg_color:o(D),container_text_color:o(L),container_border_color:o($),border_color:o($),bg_color_secondary:o(O),bg_color_hover:o(J),text_color_link:o(j),primary_color_dark:o(L),header_bg_color:o(O),header_text_color:o(K),header_border_color:o($),messages_bg_color:o(D),messages_scrollbar_thumb_color:o($),messages_scrollbar_track_color:"transparent",greeting_text_color:o(V),bot_bubble_bg_color:o(Q),bot_bubble_text_color:o(z),user_bubble_bg_color:o(P),user_bubble_text_color:o(X),subgreeting_text_color:o(K),input_area_bg_color:o(D),input_area_border_color:o($),input_wrapper_bg_color:o(O),input_wrapper_border_color:o($),input_text_color:o(L),input_placeholder_color:o(G),input_focus_border_color:o(k),input_focus_shadow_color:o(re),send_button_bg_color:o(k),send_button_text_color:o(N),send_button_border_color:o(k),send_button_hover_bg_color:o(oe),send_button_hover_border_color:o(oe),send_button_disabled_bg_color:o(se),send_button_disabled_border_color:o(se),send_button_spinner_base_color:o(pe),send_button_spinner_accent_color:o(N),popup_trigger_bg_color:o(k),popup_trigger_hover_bg_color:o(oe),popup_trigger_icon_color:o(N),action_button_bg_color:o(O),action_button_color:o(K),action_button_border_color:o($),action_button_hover_bg_color:o(J),action_button_hover_color:o(L),action_button_hover_border_color:o(de),mic_hover_bg_color:o(J),footer_bg_color:o(O),footer_text_color:o(K),footer_border_color:o($),sidebar_bg_color:o(Y),sidebar_text_color:o(j),sidebar_border_color:o($),sidebar_active_bg_color:o(te),sidebar_active_text_color:o(ee),sidebar_hover_bg_color:o(J),sidebar_hover_text_color:o(L),action_menu_bg_color:o(O),action_menu_border_color:o($),action_menu_item_text_color:o(L),action_menu_item_hover_bg_color:o(J),action_menu_item_hover_text_color:o(L),starter_bg_color:o(ie),starter_text_color:o(ae),starter_border_color:o($),starter_hover_bg_color:o(ne),starter_hover_text_color:o(ce),pdf_icon_color:o(k),image_icon_color:o(K),consent_overlay_bg_color:o(s(D,.95)),consent_overlay_border_color:o($),consent_title_color:o(L),consent_message_color:o(K),consent_button_bg_color:o(k),consent_button_text_color:o(N),form_title_color:o(L),form_label_color:o(L),form_help_text_color:o(K),form_input_bg:o(O),form_input_text:o(L),form_input_border:o($),form_input_focus_border:o(k),form_input_focus_shadow:o(re),form_submit_button_bg:o(k),form_submit_button_text:o(N),form_submit_button_hover_bg:o(oe)}}function f(m,h={}){let b=c(m),I=Object.assign({},b),y=!!h.skipDimensionSync;return n.forEach(v=>{let U=m[v];U!==""&&U!==null&&U!==void 0&&(I[v]=U)}),y||e.forEach(v=>{let U=m[v];U!==""&&U!==null&&U!==void 0&&(I[v]=U)}),y||(I.container_height!==""&&I.container_height!==null&&I.container_height!==void 0&&(I.popup_height=I.container_height),I.container_min_height!==""&&I.container_min_height!==null&&I.container_min_height!==void 0&&(I.popup_min_height=I.container_min_height),I.container_max_height!==""&&I.container_max_height!==null&&I.container_max_height!==void 0&&(I.popup_max_height=I.container_max_height)),I}function g(m,h,b={}){if(!m||typeof h!="object"||Object.keys(h).length===0)return;let I=f(h,b),y=U=>{if(U)for(let x in I){if(!Object.prototype.hasOwnProperty.call(I,x)||I[x]===""||I[x]===null)continue;let M=`--aipkit-chat-${x.replace(/_/g,"-")}`,F=I[x];x==="container_max_height"||x==="popup_max_height"?F=I[x]+"vh":x==="container_max_width"||x==="popup_width"||x==="container_height"||x==="container_min_height"||x==="popup_height"||x==="popup_min_height"?F=I[x]+"px":(x==="bubble_border_radius"||x==="container_border_radius")&&typeof F=="number"?F=F===0?"0":`${F}px`:(x==="bubble_border_radius"||x==="container_border_radius")&&typeof F=="string"&&/^\d+$/.test(F)&&(F=F==="0"?"0":`${F}px`),U.style.setProperty(M,F)}};y(m);let v=m.closest(".aipkit_popup_wrapper");v&&y(v)}window.aipkit_chatUI_applyCustomThemeStyles=g})();(function(){"use strict";function d(n){let i=`aipkit_chatbot_consent_given_${n.botId||"default"}`,a=localStorage.getItem(i)==="true",t=n.webToggleDefaultOn===!0,o=n.allowWebSearchTool&&(n.provider==="OpenAI"||n.provider==="Claude"||n.provider==="OpenRouter"),r=n.allowGoogleSearchGrounding&&n.provider==="Google";return{buttonState:"send",isPopupOpen:!1,isSending:!1,currentStreamId:null,isFullscreen:!1,isSidebarOpen:!1,currentStreamMessageId:null,isActionMenuOpen:!1,activeInputActionMenu:null,activeInputActionTrigger:null,closeActionMenuHandler:null,consentGiven:a,isRecording:!1,webSearchToolActive:t&&o,googleSearchGroundingActive:t&&r}}window.aipkit_chatUI_initState=d})();(function(){"use strict";function d(n,e){if(!n||!e||!e.text){console.error("AIPKit InitialMessage: Missing messagesEl or config.");return}let i=e.botId||"default";if(n.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").forEach(t=>{try{n.removeChild(t)}catch{}}),!n.querySelector(".aipkit_initial_greeting")){let t=(e.text.initialGreeting||"Hello there!").trim(),o=(e.text.initialSubgreeting||"").trim(),r=t;if(o&&(r=t?`${t}

${o}`:o),typeof window.aipkit_chatUI_appendMessage=="function"&&typeof window.aipkit_generateClientMessageId=="function")window.aipkit_chatUI_appendMessage(n,r,"bot",e,!1,!0,window.aipkit_generateClientMessageId(i));else{console.error("AIPKit InitialMessage: appendMessage or generateClientMessageId function not found.");let s=document.createElement("div");s.className="aipkit_chat_message aipkit_chat_message-bot aipkit_initial_greeting",s.innerHTML=`<div class="aipkit_chat_bubble">${r.replace(/\n/g,"<br>")}</div>`,n.appendChild(s),typeof window.aipkit_chatUI_triggerMessageAnimation=="function"&&window.aipkit_chatUI_triggerMessageAnimation(s)}}}window.aipkit_chatUI_displayInitialMessage=d})();(function(){"use strict";function d(n,e,i,a){let{inputField:t,messagesEl:o,container:r}=n,s=e.botId,u=e.webToggleDefaultOn===!0;i.buttonState=a.setButtonStateAction("send",!1,i),typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(t),e.popupEnabled||typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(o,!0),t.disabled=e.requireConsentCompliance&&!i.consentGiven,n.voiceInputButton&&(n.voiceInputButton.disabled=e.requireConsentCompliance&&!i.consentGiven),n.inputActionButton&&(n.inputActionButton.disabled=e.requireConsentCompliance&&!i.consentGiven),n.webSearchToggleButton&&e.allowWebSearchTool&&(e.provider==="OpenAI"||e.provider==="Claude"||e.provider==="OpenRouter")&&(n.webSearchToggleButton.disabled=e.requireConsentCompliance&&!i.consentGiven),n.googleSearchGroundingToggleButton&&e.allowGoogleSearchGrounding&&e.provider==="Google"&&(n.googleSearchGroundingToggleButton.disabled=e.requireConsentCompliance&&!i.consentGiven),typeof window.aipkit_syncWebSearchToggleState=="function"&&window.aipkit_syncWebSearchToggleState(n,e,i,u),typeof window.aipkit_syncGoogleSearchGroundingToggleState=="function"&&window.aipkit_syncGoogleSearchGroundingToggleState(n,e,i,u),r.dispatchEvent(new CustomEvent("aipkit:chatLoaded",{detail:{botId:s}}))}window.aipkit_chatUI_finalizeSetup=d})();(function(){"use strict";function d(e,i,a){if(!e||!i)return;let t=!!a;e.classList.toggle("aipkit-popup-open",t),e.setAttribute("aria-hidden",t?"false":"true"),i.isPopupOpen=t;let o=e.closest(".aipkit_popup_wrapper");if(!o)return;o.classList.toggle("aipkit-popup-open",t);let r=o.querySelector(".aipkit_popup_trigger");if(!r)return;r.setAttribute("aria-expanded",t?"true":"false");let s=r.getAttribute("data-label-open")||"Open Chat",u=r.getAttribute("data-label-close")||"Close Chat",p=t?u:s;r.setAttribute("aria-label",p),r.setAttribute("title",p);let l=r.querySelector(".aipkit_popup_icon--open"),w=r.querySelector(".aipkit_popup_icon--close");l&&l.setAttribute("aria-hidden",t?"true":"false"),w&&w.setAttribute("aria-hidden",t?"false":"true")}function n(e,i,a,t){if(!e||!a||!t||t.isPopupOpen)return;try{e._aipkitHint&&(typeof e._aipkitHint.handlePopupOpen=="function"?e._aipkitHint.handlePopupOpen():typeof e._aipkitHint.hideHint=="function"&&e._aipkitHint.hideHint())}catch{}d(e,t,!0),typeof window.aipkit_chatUI_scrollToBottom=="function"?window.aipkit_chatUI_scrollToBottom(i):console.error("AIPKit Popup Open: scrollToBottom function not found.");let o=e.closest("#aipkit_admin_chat_preview_container");(!(window.innerWidth<=768)||o)&&setTimeout(()=>{a&&typeof a.focus=="function"&&a.focus()},50)}window.aipkit_chatUI_setPopupLauncherState=d,window.aipkit_chatUI_openPopup=n})();(function(){"use strict";function d(n,e){if(!n||!e||!e.isPopupOpen)return;if(typeof window.aipkit_chatUI_setPopupLauncherState=="function"){window.aipkit_chatUI_setPopupLauncherState(n,e,!1);return}n.classList.remove("aipkit-popup-open"),n.setAttribute("aria-hidden","true"),e.isPopupOpen=!1;let i=n.closest(".aipkit_popup_wrapper");i&&i.classList.remove("aipkit-popup-open")}window.aipkit_chatUI_closePopup=d})();(function(){"use strict";function d(n,e,i,a,t,o){if(!n||!e||!t||!o){console.warn("AIPKit Chat Popup Handlers: Missing elements for setup (container, trigger, stateRef, or config).");return}let r=!!n.closest("#aipkit_admin_chat_preview_container");try{let p=n.closest(".aipkit_popup_wrapper"),l=p?p.querySelector(".aipkit_popup_hint"):null,w=768,_=()=>window.innerWidth<=w,c=o.popupLabelVersion&&String(o.popupLabelVersion).trim()||"v1",f=`aipkit_popup_hint_seen_${o.botId}_${c}`,g=`aipkit_popup_hint_dismissed_${o.botId}_${c}`,h=["always","once_per_session","once_per_visitor"].includes(o.popupLabelFrequency)?o.popupLabelFrequency:"once_per_visitor",b=r?"always":h,y=["always","on_delay","until_open","until_dismissed"].includes(o.popupLabelMode)?o.popupLabelMode:"on_delay",v=(o.popupLabelDelaySeconds>0?o.popupLabelDelaySeconds:0)*1e3,U=(o.popupLabelAutoHideSeconds>0?o.popupLabelAutoHideSeconds:0)*1e3,x=!!o.popupLabelDismissible,M=b==="always"?null:b==="once_per_session"?window.sessionStorage:window.localStorage,F=P=>{if(!M)return null;try{return M.getItem(P)}catch{return null}},k=(P,N)=>{if(M)try{M.setItem(P,N)}catch{}},S=!1,A=!1,C=()=>S||F(f)==="1",E=()=>A||F(g)==="1",T=()=>y==="until_dismissed"?!E():y==="until_open"?!C():b==="always"?!0:!C(),q=()=>{S=!0,k(f,"1")},L=()=>{A=!0,k(g,"1")},H=null,O=null,D=()=>{H&&(clearTimeout(H),H=null)},B=()=>{O&&(clearTimeout(O),O=null)},R=()=>{l&&(l.removeAttribute("hidden"),l.classList.add("aipkit-visible"),l.setAttribute("aria-hidden","false"),(y==="on_delay"||y==="always")&&q(),U>0&&(B(),O=setTimeout($,U)))},$=()=>{l&&(l.classList.remove("aipkit-visible"),l.setAttribute("aria-hidden","true"),l.setAttribute("hidden",""),B())},K=()=>{let P=_();return!(P&&!o.popupLabelShowOnMobile||!P&&!o.popupLabelShowOnDesktop)},G=()=>{if(!l||!o.popupLabelEnabled||!o.popupLabelText||t.isPopupOpen||!K()||!T())return;D();let P=y==="always"?0:v;if(P<=0){R();return}H=setTimeout(R,P)},W=()=>{D(),$(),y==="until_open"&&q()},Q=()=>{G()},Z=()=>{D(),$(),y==="until_dismissed"?L():b!=="always"&&q()};if(l&&x){let P=l.querySelector(".aipkit_popup_hint_close");P&&P.addEventListener("click",N=>{N.stopPropagation(),Z()})}if(l)try{let P=window.getComputedStyle(n),N=n.querySelector(".aipkit_chat_header"),V=N?window.getComputedStyle(N):null,z="",X="";if(V){let j=V.getPropertyValue("background-color").trim(),ee=V.getPropertyValue("color").trim();j&&(z=j),ee&&(X=ee)}z||(z=P.getPropertyValue("--aipkit-chat-header-bg-color").trim()),z||(z=P.getPropertyValue("--aipkit_brand-primary").trim()),z||(z="#4a6fa5"),X||(X=P.getPropertyValue("--aipkit-chat-header-text-color").trim()),X||(X="#ffffff");let J=p||n;z&&J.style.setProperty("--aipkit-chat-popup-hint-bg",z);let te=P.getPropertyValue("--aipkit-chat-bot-bubble-text-color").trim(),Y="";if(te)Y=te;else if(X)Y=X;else if(z){let j=z.match(/rgba?\((\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})/i);if(j){let ee=parseInt(j[1],10),ie=parseInt(j[2],10),ne=parseInt(j[3],10);Y=(ee*299+ie*587+ne*114)/1e3>200?"#2d3748":"#ffffff"}else Y="#2d3748"}else Y="#2d3748";Y&&J.style.setProperty("--aipkit-chat-popup-hint-text-color",Y)}catch{}$(),G(),n._aipkitHint={scheduleShow:G,hideHint:$,markSeen:q,markDismissed:L,handlePopupOpen:W,handlePopupClose:Q,dismissHintFromUser:Z,isDismissible:x,isVisible:()=>!!(l&&l.classList.contains("aipkit-visible"))}}catch(p){console.warn("AIPKit Popup Hint: setup error",p)}if(typeof window.aipkit_chatUI_openPopup!="function"||typeof window.aipkit_chatUI_closePopup!="function"){console.error("AIPKit Chat Popup Handlers: Missing openPopup or closePopup helper functions.");return}typeof window.aipkit_chatUI_setPopupLauncherState=="function"&&window.aipkit_chatUI_setPopupLauncherState(n,t,!!t.isPopupOpen);let s=(p=!1)=>{window.aipkit_chatUI_closePopup(n,t),p&&typeof e.focus=="function"?e.focus():typeof e.blur=="function"&&e.blur(),n._aipkitHint&&typeof n._aipkitHint.handlePopupClose=="function"&&n._aipkitHint.handlePopupClose()};document.addEventListener("keydown",p=>{if(p.key==="Escape"){if(t.isPopupOpen){s(!0);return}!n._aipkitHint||!n._aipkitHint.isDismissible||n._aipkitHint.isVisible?.()&&(n._aipkitHint.dismissHintFromUser?.(),typeof e.focus=="function"&&e.focus())}});let u=n.querySelector(".aipkit_popup_close_btn");u&&u.addEventListener("click",p=>{p.stopPropagation(),t.isPopupOpen&&s()}),!o.directVoiceMode&&(e.addEventListener("click",p=>{p.stopPropagation(),t.isPopupOpen?s(!1):window.aipkit_chatUI_openPopup(n,i,a,t)}),document.addEventListener("click",p=>{t.isPopupOpen&&(r||n.contains(p.target)||e.contains(p.target)||s(!1))},!0))}window.aipkit_chatUI_setupPopupHandlers=d})();(function(){"use strict";function d(n,e){let i=new Date,a=`${i.getFullYear()}${String(i.getMonth()+1).padStart(2,"0")}${String(i.getDate()).padStart(2,"0")}-${String(i.getHours()).padStart(2,"0")}${String(i.getMinutes()).padStart(2,"0")}`;return`chat-${n.botId||"transcript"}-${a}.${e}`}window.aipkit_chatUI_generateDownloadFilename=d})();(function(){"use strict";function d(n,e){let i=document.createElement("a");if(typeof i.download=="string")i.href=URL.createObjectURL(n),i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(i.href);else{console.warn("AIPKit Chat Download: Download attribute not supported, opening in new window.");let a=URL.createObjectURL(n);window.open(a,"_blank")}}window.aipkit_chatUI_triggerBlobDownload=d})();(function(){"use strict";function d(n,e){let{messagesEl:i}=n,a=(w,_="info",c=!0,f=4500)=>{typeof window.aipkit_chatUI_showInlineNotice=="function"&&window.aipkit_chatUI_showInlineNotice(w,_,{elements:n,config:e,messagesEl:i},c,f)};if(!i||!e||!e.text){console.error("AIPKit Download TXT: Missing messages element or config.");return}let t="",o=i.querySelectorAll(".aipkit_chat_message"),r=e?.headerName||"Bot",s=e.text.userPrefix||"User",u=e.text.errorPrefix||"Error";if(o.forEach(w=>{let _=w.querySelector(".aipkit_chat_bubble");if(!_)return;if(typeof window.aipkit_chatUI_extractTextFromBubble!="function"){console.error("AIPKit Download TXT: extractTextFromBubble function not found."),t+=`Error: Could not extract text.
`;return}let c=window.aipkit_chatUI_extractTextFromBubble(_),f="";w.classList.contains("aipkit_chat_message-user")?f=`[${s}]:`:w.classList.contains("aipkit_chat_message-bot")?f=`[${r}]:`:w.classList.contains("aipkit_chat_message-error")&&(f=`[${u}]:`),f&&c&&(t+=`${f}
${c}

`)}),t=t.trim(),!t){console.warn("AIPKit Chat Download TXT: No transcript content found."),a(e.text.downloadEmpty||"Nothing to download.","info",!0);return}let p=new Blob([t],{type:"text/plain;charset=utf-8"});if(typeof window.aipkit_chatUI_generateDownloadFilename!="function"||typeof window.aipkit_chatUI_triggerBlobDownload!="function"){console.error("AIPKit Download TXT: generateDownloadFilename or triggerBlobDownload function not found."),a(e.text?.downloadPrepareError||"Error: Could not prepare download.","error",!0,7e3);return}let l=window.aipkit_chatUI_generateDownloadFilename(e,"txt");window.aipkit_chatUI_triggerBlobDownload(p,l)}window.aipkit_chatUI_downloadTranscriptActionTxt=d})();(function(){"use strict";let d="aipkit_sidebar_state_";function n(e){return`${d}${e||"default"}`}window.aipkit_sidebar_getStorageKey=n})();(function(){"use strict";function d(n,e){if(!e||!n)return;let i=n.querySelector(".aipkit_chat_footer");if(!i){e.style.display="none";return}if(window.getComputedStyle(i).display!=="none"&&window.getComputedStyle(i).visibility!=="hidden"&&i.offsetHeight>0){let t=i.offsetHeight;t>0&&(e.style.height=`${t}px`),e.style.display="block"}else e.style.display="none"}window.aipkit_sidebar_syncFooterVisibility=d})();(function(){"use strict";function n(i,a){let t=i?i.closest(".aipkit_chat_container"):null;if(!t||t.closest("#aipkit_admin_chat_preview_container"))return null;let o=t.querySelector(".aipkit_sidebar_mobile_overlay");return o?o.setAttribute("aria-label",a):(o=document.createElement("button"),o.type="button",o.className="aipkit_sidebar_mobile_overlay",o.setAttribute("aria-label",a),o.setAttribute("aria-hidden","true"),o.tabIndex=-1,t.appendChild(o)),o}function e(i,a,t,o,r,s){if(!r)return;let u=s?.text?.sidebarOverlayClose||"Close conversation sidebar",p=window.innerWidth<=768,l=a?a.closest(".aipkit_chat_container"):null,w=p?n(a,u):l?l.querySelector(".aipkit_sidebar_mobile_overlay"):null;r.mobileOverlayHandler&&r.mobileOverlayTargetEl&&r.mobileOverlayTargetEl.removeEventListener("click",r.mobileOverlayHandler),w&&(w.classList.remove("aipkit-is-active"),w.setAttribute("aria-hidden","true")),r&&(r.mobileOverlayHandler=null,r.mobileOverlayTargetEl=null),i&&p&&w&&(r.mobileOverlayHandler=o,r.mobileOverlayTargetEl=w,w.classList.add("aipkit-is-active"),w.setAttribute("aria-hidden","false"),w.addEventListener("click",r.mobileOverlayHandler))}window.aipkit_sidebar_manageMobileOverlayListener=e})();(function(){"use strict";function d(n,e,i,a,t,o,r,s,u,p,l){!e||!i||(e.classList.toggle("aipkit-sidebar-state-open",n),e.classList.toggle("aipkit-sidebar-state-closed",!n),i.setAttribute("aria-expanded",n.toString()),r&&r.setAttribute("aria-hidden",(!n).toString()),localStorage.setItem(a,n?"open":"closed"),typeof t=="function"&&r&&t(e,r.querySelector(".aipkit_sidebar_footer")),typeof o=="function"&&r&&o(n,r,i,u,s,l))}window.aipkit_sidebar_applyCurrentState=d})();(function(){"use strict";function d(n,e,i){let a=n.isSidebarOpen;n.isSidebarOpen=!n.isSidebarOpen,!a&&n.isSidebarOpen&&typeof i=="function"&&i()}window.aipkit_sidebar_toggleSidebar=d})();(function(){"use strict";function n(e,i,a,t){let o=e.config?.botId||"unknown";if(typeof e.clearChatAction=="function"){e.clearChatAction();let r=i?i.querySelectorAll(".aipkit_conversation_item.aipkit_active"):[];r.length>0&&r.forEach(s=>s.classList.remove("aipkit_active")),window.innerWidth<=768&&a.isSidebarOpen&&typeof t=="function"&&t()}else console.error(`AIPKit Sidebar (${o}): clearChatAction is not a function in actions object.`)}window.aipkit_sidebar_handleNewChat=n})();(function(){"use strict";function d(n,e,i){let a=e.botId||"unknown",t=(o,r="muted",s=!1)=>{typeof window.aipkit_chatUI_renderUIState=="function"?window.aipkit_chatUI_renderUIState(n,{message:o,type:r,showSpinner:s,scope:"sidebar"}):n&&(n.textContent=o)};if(!n||!e||!i){console.error(`AIPKit Sidebar (${a}): Missing elements or functions for fetchConversationList.`),n&&t(e.text?.historyLoadError||"Error: Cannot load list.","error");return}if(!e.nonce){t(e.text.historyGuests||"History unavailable.","muted");return}t(e.text?.historyLoading||"Loading conversations...","loading",!0),window.aipkit_frontendApiRequest("aipkit_get_conversations_list",{},e).then(o=>{typeof i=="function"?i(o.conversations||[]):(console.error(`AIPKit Sidebar (${a}): renderConversationListFunc is not a function.`),t(e.text?.historyRenderError||"Error: Cannot display list.","error"))}).catch(o=>{console.error(`AIPKit Sidebar (${a}): Error fetching conversation list:`,o),t(`${e.text?.historyLoadErrorPrefix||"Error loading list"}: ${o.message||"Unknown error"}`,"error")})}window.aipkit_sidebar_fetchConversationList=d})();(function(){"use strict";function n(e,i,a,t,o,r,s){let u=a.botId||"unknown",p='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-x"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6l-12 12" /><path d="M6 6l12 12" /></svg>',l=(f,g="muted")=>{typeof window.aipkit_chatUI_renderUIState=="function"?window.aipkit_chatUI_renderUIState(i,{message:f,type:g,scope:"sidebar"}):i&&(i.textContent=f)};if(!i||!a||!t||typeof o!="function"||typeof r!="function"||typeof s!="function"){console.error(`AIPKit Sidebar (${u}): Missing elements or functions for renderConversationList.`),i&&l(a.text?.historyRenderError||"Error: Cannot render list.","error");return}if(!e||e.length===0){l(a.text.historyEmpty||"No past conversations.","muted");return}i.innerHTML="";let w=window.aipkit_current_conversation_uuid||null,_=a.text?.openConversation||"Open conversation",c=a.text?.deleteConversation||"Delete conversation";e.forEach(f=>{let g=document.createElement("div");g.className="aipkit_conversation_item",g.setAttribute("data-conversation-id",f.id);let m=f.title||f.id.substring(0,8),h=document.createElement("span");h.className="aipkit_conversation_item_title",h.textContent=m;let b=document.createElement("button");b.type="button",b.className="aipkit_conversation_item_title_btn",b.setAttribute("aria-label",`${_}: ${m}`),b.title=`${m} (ID: ${f.id})`,b.appendChild(h),g.appendChild(b);let I=document.createElement("button");I.type="button",I.className="aipkit_conversation_item_delete_btn",I.setAttribute("aria-label",`${c}: ${m}`),I.innerHTML=p,I.title=c,g.appendChild(I);let y=document.createElement("span");y.className="aipkit_conversation_item_spinner aipkit_spinner",g.appendChild(y),w&&f.id===w&&g.classList.add("aipkit_active"),!!t.isDeletingId&&t.isDeletingId===f.id&&(g.classList.add("aipkit_conversation_item--deleting"),g.setAttribute("aria-busy","true"),b.disabled=!0,I.disabled=!0,I.setAttribute("aria-disabled","true")),b.addEventListener("click",()=>{t.isDeletingId!==f.id&&(o(f.id),window.innerWidth<=768&&t.isSidebarOpen&&s())}),I.addEventListener("click",U=>{U.stopPropagation(),!t.isDeletingId&&r(f.id,g)}),i.appendChild(g)})}window.aipkit_sidebar_renderConversationList=n})();(function(){"use strict";function d(e,i){if(!e||!i)return;let a=e.querySelector(".aipkit_sidebar_inline_state");a&&a.remove();let t=null;typeof window.aipkit_chatUI_createStateElement=="function"?t=window.aipkit_chatUI_createStateElement({message:i,type:"error",scope:"sidebar"}):(t=document.createElement("div"),t.className="aipkit_ui_state aipkit_ui_state--error aipkit_ui_state--sidebar",t.textContent=i),t.classList.add("aipkit_sidebar_inline_state"),t.setAttribute("role","status"),t.setAttribute("aria-live","polite"),e.prepend(t),setTimeout(()=>{t.isConnected&&(t.classList.add("aipkit_sidebar_inline_state--hiding"),setTimeout(()=>{t.isConnected&&t.remove()},220))},5e3)}function n(e,i,a,t,o,r){let s=t.botId||"unknown";if(!i||o.isDeletingId)return;o.isDeletingId=e;let u=i.querySelector(".aipkit_conversation_item_delete_btn"),p=i.querySelector(".aipkit_conversation_item_title_btn");i.classList.add("aipkit_conversation_item--deleting"),i.setAttribute("aria-busy","true"),p&&(p.disabled=!0),u&&(u.disabled=!0,u.setAttribute("aria-disabled","true"));let l={bot_id:s,conversation_uuid:e},w=(()=>{let _=i.nextElementSibling;if(_){let g=_.querySelector(".aipkit_conversation_item_title_btn");if(g)return g}let c=i.previousElementSibling;if(c){let g=c.querySelector(".aipkit_conversation_item_title_btn");if(g)return g}let f=i.closest(".aipkit_chat_sidebar");if(f){let g=f.querySelector(".aipkit_sidebar_new_chat_btn");if(g)return g}return null})();window.aipkit_frontendApiRequest("aipkit_delete_single_conversation",l,t).then(_=>{i.classList.add("aipkit_conversation_item--removing");let c=!1,f=()=>{if(c)return;c=!0,i.removeEventListener("transitionend",g),i.parentNode&&i.remove();let m=!!(a&&a.querySelector(".aipkit_conversation_item"));a&&!m?typeof window.aipkit_chatUI_renderUIState=="function"?window.aipkit_chatUI_renderUIState(a,{message:t.text.historyEmpty||"No past conversations.",type:"muted",scope:"sidebar"}):a.textContent=t.text.historyEmpty||"No past conversations.":w&&typeof w.focus=="function"&&w.focus()},g=m=>{m.target===i&&m.propertyName==="opacity"&&f()};i.addEventListener("transitionend",g),setTimeout(f,350),window.aipkit_current_conversation_uuid===e&&(typeof r.clearChatAction=="function"?r.clearChatAction():console.error(`AIPKit Sidebar (${s}): clearChatAction is not a function in actions object.`))}).catch(_=>{d(a,`${t.text?.historyDeleteErrorPrefix||"Error deleting conversation"}: ${_.message||"Unknown error"}`),i.classList.remove("aipkit_conversation_item--deleting"),i.classList.remove("aipkit_conversation_item--removing"),i.removeAttribute("aria-busy"),p&&(p.disabled=!1),u&&(u.disabled=!1,u.removeAttribute("aria-disabled"),typeof u.focus=="function"&&u.focus())}).finally(()=>{o.isDeletingId=null})}window.aipkit_sidebar_handleDeleteConversation=n})();(function(){"use strict";function d(n,e,i,a,t,o,r){let s=a.botId||"unknown",u=i?i.closest(".aipkit_chat_container"):null,p=u?u.querySelector(".aipkit_conversation_starters"):null,l=(_,c="muted",f=!1)=>{typeof window.aipkit_chatUI_renderUIState=="function"?window.aipkit_chatUI_renderUIState(i,{message:_,type:c,showSpinner:f,scope:"messages"}):i&&(i.textContent=_)};if(!n||t.isDeletingId===n)return;p&&(p.classList.add("aipkit_hidden"),p.classList.remove("aipkit_starters_ready")),sessionStorage.setItem("aipkit_current_conversation_uuid",n),window.aipkit_current_conversation_uuid=n,window.aipkit_is_fresh_session=!1,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id");try{let _=localStorage.getItem(`aipkit_file_context_${n}`);if(_){let c=JSON.parse(_),f=!1;c&&c.provider&&(c.provider==="OpenAI"&&c.vector_store_id||c.provider==="Pinecone"&&c.index_name&&c.namespace||c.provider==="Qdrant"&&c.collection_name&&c.file_upload_context_id||c.provider==="Claude"&&c.file_id)&&(f=!0),f?(window.aipkit_active_file_context_provider=c.provider,window.aipkit_active_file_context_data=c,sessionStorage.setItem("aipkit_active_file_context_provider",window.aipkit_active_file_context_provider),sessionStorage.setItem("aipkit_active_file_context_data",JSON.stringify(window.aipkit_active_file_context_data)),document.dispatchEvent(new CustomEvent("aipkit:fileContextRestored",{detail:c}))):(console.warn(`AIPKit Sidebar (${s}): Invalid file context data in localStorage for conv ${n}. Clearing. Data:`,c),localStorage.removeItem(`aipkit_file_context_${n}`),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")))}else window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}catch(_){console.error("AIPKit Sidebar: Error handling localStorage for file context:",_),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}(e?e.querySelectorAll(".aipkit_conversation_item"):[]).forEach(_=>{_.classList.remove("aipkit_active"),_.getAttribute("data-conversation-id")===n&&_.classList.add("aipkit_active")}),typeof window.aipkit_chatUI_clearMessages=="function"&&window.aipkit_chatUI_clearMessages(i),l("","loading",!0),window.aipkit_frontendApiRequest("aipkit_get_conversation_history",{},a).then(_=>{i.innerHTML="";let c=_.history||[];if(c.length===0)if(typeof window.aipkit_chatUI_appendMessage=="function"&&a.text.initialGreeting){let f=(a.text.initialGreeting||"").trim(),g=(a.text.initialSubgreeting||"").trim(),m=f;g&&(m=f?`${f}

${g}`:g),typeof window.aipkit_generateClientMessageId=="function"&&window.aipkit_chatUI_appendMessage(i,m,"bot",a,!1,!0,window.aipkit_generateClientMessageId(s))}else l(a.text.historyEmpty||"No past messages.","muted");else{let f=null;c.forEach(g=>{let m=g.role==="assistant"||g.role==="bot"?"bot":"user",h=g.content||"";g.response_data&&g.response_data.type==="image"&&g.response_data.images&&g.response_data.images.length>0&&(h={type:"image",images:g.response_data.images,prompt:g.request_payload?.prompt||g.content}),g.response_data&&g.response_data.type==="user_image_upload"&&g.response_data.images&&g.response_data.images.length>0&&(h={text:g.content||"",user_image:g.response_data.images[0]}),window.aipkit_chatUI_appendMessage(i,h,m,a,g.role==="bot"&&(g.content||"").startsWith("Error:"),!1,g.message_id||null,!1,g.grounding_metadata||null),(m==="bot"||m==="assistant")&&g.openai_response_id&&(f=g.openai_response_id)}),f&&(window.aipkit_current_openai_response_id=f,sessionStorage.setItem("aipkit_current_openai_response_id",f)),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(i,!0)}typeof o.setButtonStateAction=="function"&&o.setButtonStateAction("send",!1),typeof o.focusInputAction=="function"&&o.focusInputAction(),u&&u.dispatchEvent(new CustomEvent("aipkit:historyLoaded",{detail:{conversationUUID:n}}))}).catch(_=>{l(`${a.text?.historyLoadErrorPrefix||"Error loading history"}: ${_.message||"Unknown error"}`,"error"),typeof o.setButtonStateAction=="function"&&o.setButtonStateAction("send",!1)})}window.aipkit_sidebar_loadConversation=d})();(function(){"use strict";function n(e,i,a,t){let{sidebarToggleBtn:o,sidebarEl:r,newChatBtn:s}=i,u=e.querySelector(".aipkit_chat_messages"),p=e.querySelector(".aipkit_chat_main"),l=r?r.querySelector(".aipkit_sidebar_content"):null,w=r?r.querySelector(".aipkit_sidebar_footer"):null;if(!e||!o||!r||!l||!u||!p){console.warn("AIPKit Sidebar (Orchestrator): Missing required elements. Sidebar init aborted.",{container:e,sidebarToggleBtn:o,sidebarEl:r,sidebarContentEl:l,messagesEl:u,mainContentEl:p});return}let _=a.botId;if(!_){console.error("AIPKit Sidebar (Orchestrator): Bot ID missing, cannot initialize."),o.disabled=!0,s&&(s.disabled=!0),typeof window.aipkit_chatUI_renderUIState=="function"?window.aipkit_chatUI_renderUIState(l,{message:a.text?.configurationError||"Configuration Error",type:"error",scope:"sidebar"}):l.textContent=a.text?.configurationError||"Configuration Error";return}let c={isSidebarOpen:!1,isDeletingId:null,mobileOverlayHandler:null,mobileOverlayTargetEl:null},f=()=>{if(!l)return;l.querySelectorAll(".aipkit_conversation_item.aipkit_active").forEach(S=>S.classList.remove("aipkit_active"))},g=(k=null)=>{if(!l)return;let S=k||null,A=l.querySelectorAll(".aipkit_conversation_item"),C=!1;A.forEach(E=>{let T=!!S&&E.getAttribute("data-conversation-id")===S;E.classList.toggle("aipkit_active",T),T&&(C=!0)}),C||f()},m=window.aipkit_sidebar_getStorageKey(_),h=localStorage.getItem(m);if(c.isSidebarOpen=h==="open",!r.id){let k=String(_).replace(/[^a-zA-Z0-9_-]/g,"_");r.id=`aipkit_chat_sidebar_${k}`}o.setAttribute("aria-controls",r.id),o.setAttribute("aria-expanded",c.isSidebarOpen.toString()),r.setAttribute("aria-hidden",(!c.isSidebarOpen).toString());let b=k=>{c.isSidebarOpen&&window.innerWidth<=768&&(k.preventDefault(),x())},I=k=>window.aipkit_sidebar_applyCurrentState(c.isSidebarOpen,e,o,m,window.aipkit_sidebar_syncFooterVisibility,window.aipkit_sidebar_manageMobileOverlayListener,r,c,b,k,a),y=()=>window.aipkit_sidebar_fetchConversationList(l,a,k=>window.aipkit_sidebar_renderConversationList(k,l,a,c,v,U,x)),v=k=>window.aipkit_sidebar_loadConversation(k,l,u,a,c,t,x),U=(k,S)=>window.aipkit_sidebar_handleDeleteConversation(k,S,l,a,c,t),x=()=>{window.aipkit_sidebar_toggleSidebar(c,I,y),I(c.isSidebarOpen)};typeof window.aipkit_sidebar_syncFooterVisibility=="function"&&(window.aipkit_sidebar_syncFooterVisibility(e,w),new MutationObserver(()=>window.aipkit_sidebar_syncFooterVisibility(e,w)).observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]})),I(!1),o.addEventListener("click",x),s&&typeof window.aipkit_sidebar_handleNewChat=="function"&&typeof t.clearChatAction=="function"?(s.addEventListener("click",()=>window.aipkit_sidebar_handleNewChat(t,l,c,x)),s.disabled=!1):s&&(s.disabled=!0,console.warn(`AIPKit Sidebar (${_}): New Chat button disabled, clearChatAction or handleNewChat helper missing.`)),window.addEventListener("resize",()=>{c.isSidebarOpen&&typeof window.aipkit_sidebar_manageMobileOverlayListener=="function"&&window.aipkit_sidebar_manageMobileOverlayListener(c.isSidebarOpen,r,o,b,c,a)}),(c.isSidebarOpen||!a.nonce)&&y();let M=k=>{k.detail&&(k.detail.conversationUUID&&g(k.detail.conversationUUID),k.detail.newConversation&&c.isSidebarOpen&&y())},F=()=>{f()};e.addEventListener("aipkit:messageReceived",M),e.addEventListener("aipkit:chatCleared",F)}window.aipkit_initConversationSidebar=n})();(function(){"use strict";function d(n){if(!n)return"";let e="",i=n.childNodes;function a(t){if(t.nodeType===Node.TEXT_NODE)return t.textContent;if(t.nodeName==="BR")return`
`;if(t.nodeType===Node.ELEMENT_NODE){let o="";return["P","UL","OL","H1","H2","H3","H4","H5","H6","PRE","BLOCKQUOTE","HR","DIV"].includes(t.tagName)&&(o+=`
`),t.tagName==="LI"&&(o+="- "),t.childNodes.forEach(r=>{o+=a(r)}),["P","UL","OL","H1","H2","H3","H4","H5","H6","PRE","BLOCKQUOTE","HR","DIV","LI"].includes(t.tagName)&&(o+=`
`),o}return""}return i.forEach(t=>{e+=a(t)}),e.replace(/\n\s*\n/g,`

`).replace(/^\s+|\s+$/g,"")}window.aipkit_chatUI_extractTextFromBubble=d})();(function(){"use strict";function d(n,e=1500){let i=n;if(!i){console.warn("AIPKit showSuccessIcon: Button element not found:",n);return}i.dataset.originalIconHtml||(i.dataset.originalIconHtml=i.innerHTML);let a='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-check"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5l10 -10" /></svg>';if(n.dataset.successTimeoutId||n.disabled)return;i.innerHTML=a;let t=i.querySelector("svg");t&&(t.style.color="var(--aipkit_status-success, #38A169)"),n.dataset.successTimeoutId&&clearTimeout(parseInt(n.dataset.successTimeoutId,10));let o=setTimeout(()=>{let r=i.dataset.originalIconHtml;r&&(i.innerHTML=r),delete i.dataset.originalIconHtml,delete n.dataset.successTimeoutId},e);n.dataset.successTimeoutId=o.toString()}window.aipkit_chatUI_showSuccessIcon=d})();(function(){"use strict";function d(n,e){let i=n.target.closest(".aipkit_copy_btn");if(!i||i.disabled||i.dataset.successTimeoutId)return;let a=i.closest(".aipkit_chat_message"),t=a?a.querySelector(".aipkit_chat_bubble"):null;if(!a||!t){console.error("AIPKit Message Actions: Could not find parent message container or bubble for copy button.");return}if(typeof window.aipkit_chatUI_extractTextFromBubble!="function"||typeof window.aipkit_chatUI_showSuccessIcon!="function"){console.error("AIPKit Copy Action: Missing required helper functions (extractTextFromBubble or showSuccessIcon).");return}let o=window.aipkit_chatUI_extractTextFromBubble(t);if(!o){console.warn("AIPKit Copy Action: No text extracted from bubble to copy.");return}if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function")navigator.clipboard.writeText(o).then(()=>{window.aipkit_chatUI_showSuccessIcon(i)}).catch(r=>{console.error("AIPKit Message Actions: Clipboard API failed:",r)});else{console.warn("AIPKit Message Actions: Using fallback copy method.");try{let r=document.createElement("textarea");r.value=o,r.style.position="fixed",r.style.top="-9999px",r.style.left="-9999px",r.style.opacity="0",document.body.appendChild(r),r.focus(),r.select();let s=document.execCommand("copy");if(document.body.removeChild(r),s)window.aipkit_chatUI_showSuccessIcon(i);else throw new Error("execCommand failed")}catch(r){console.error("AIPKit Message Actions: Fallback copy method failed:",r)}}}window.aipkit_chatUI_handleCopyAction=d})();(function(){"use strict";function d(n,e){let i=n.target.closest(".aipkit_feedback_btn");if(!i||i.disabled||i.classList.contains("aipkit_feedback_selected"))return;let a=i.getAttribute("data-feedback"),t=i.closest(".aipkit_chat_message"),o=t?t.getAttribute("data-message-id"):null,r=i.closest(".aipkit_message_actions");if(!o||!a||!r){console.error("AIPKit Feedback: Missing message ID, feedback type, or actions container.");return}let s=r.querySelectorAll(".aipkit_feedback_btn");if(s.forEach(p=>{p.disabled=!0,p===i?p.classList.add("aipkit_feedback_selected"):(p.classList.remove("aipkit_feedback_selected"),p.style.opacity="0.4")}),typeof window.aipkit_frontendApiRequest!="function"){console.error("AIPKit Feedback Error: aipkit_frontendApiRequest function not found."),s.forEach(p=>{p.disabled=!1,p.classList.remove("aipkit_feedback_selected"),p.style.opacity="1"});return}let u={message_id:o,feedback_type:a};window.aipkit_frontendApiRequest("aipkit_store_feedback",u,e).then(p=>{console.log(`AIPKit Feedback (${e.botId}): Feedback stored successfully for ${o}.`,p)}).catch(p=>{console.error(`AIPKit Feedback (${e.botId}): Error storing feedback for ${o}:`,p),s.forEach(l=>{l.disabled=!1,l.classList.remove("aipkit_feedback_selected"),l.style.opacity="1"})})}window.aipkit_chatUI_handleFeedbackAction=d})();(function(){"use strict";function d(n){let e='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-player-play"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 4v16l13 -8z" /></svg>',i='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-copy"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg>',a='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-thumb-up"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 11v8a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1v-7a1 1 0 0 1 1 -1h3a4 4 0 0 0 4 -4v-1a2 2 0 0 1 4 0v5h3a2 2 0 0 1 2 2l-1 5a2 3 0 0 1 -2 2h-7a3 3 0 0 1 -3 -3" /></svg>',t='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-thumb-down"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 13v-8a1 1 0 0 0 -1 -1h-2a1 1 0 0 0 -1 1v7a1 1 0 0 0 1 1h3a4 4 0 0 1 4 4v1a2 2 0 0 0 4 0v-5h3a2 2 0 0 0 2 -2l-1 -5a2 3 0 0 0 -2 -2h-7a3 3 0 0 0 -3 3" /></svg>',o="",r=n.text||{};if(n.ttsEnabled){let s=r.playActionLabel||"Play audio";o+=`<button type="button" class="aipkit_action_btn aipkit_play_btn" title="${s}" aria-label="${s}">${e}</button>`}if(n.enableCopyButton){let s=r.copyActionLabel||"Copy response";o+=`<button type="button" class="aipkit_action_btn aipkit_copy_btn" title="${s}" aria-label="${s}">${i}</button>`}if(n.enableFeedback){let s=r.feedbackLikeLabel||"Like response",u=r.feedbackDislikeLabel||"Dislike response";o+=`<button type="button" class="aipkit_action_btn aipkit_feedback_btn aipkit_thumb_up_btn" title="${s}" aria-label="${s}" data-feedback="up">${a}</button>`,o+=`<button type="button" class="aipkit_action_btn aipkit_feedback_btn aipkit_thumb_down_btn" title="${u}" aria-label="${u}" data-feedback="down">${t}</button>`}return o?`<div class="aipkit_message_actions">${o}</div>`:""}window.aipkit_chatUI_createActionsContainerHTML=d})();(function(){"use strict";function d(n,e){if(!n){console.error("AIPKit Init Message Actions: Messages container element not provided.");return}n.dataset.aipkitMessageActionsListenerAttached!=="true"&&(n.dataset.aipkitMessageActionsListenerAttached="true",n.addEventListener("click",function(i){if(i.target.closest(".aipkit_copy_btn")){typeof window.aipkit_chatUI_handleCopyAction=="function"?window.aipkit_chatUI_handleCopyAction(i,e):console.error("AIPKit Init Message Actions: handleCopyAction function not found.");return}if(i.target.closest(".aipkit_feedback_btn")){typeof window.aipkit_chatUI_handleFeedbackAction=="function"?window.aipkit_chatUI_handleFeedbackAction(i,e):console.error("AIPKit Init Message Actions: handleFeedbackAction function not found.");return}}))}window.aipkit_chatUI_initMessageActions=d})();(function(){"use strict";window.aipkitTtsState={currentAudio:null,currentBlobUrl:null,currentlyPlayingButton:null}})();(function(){"use strict";function d(n=!0){let e=window.aipkitTtsState;if(!e){console.error("AIPKit TTS StopAudio: State object not found.");return}if(e.currentAudio&&(e.currentAudio.pause(),e.currentAudio.src="",typeof window.aipkit_tts_handleCanPlayThrough=="function"&&e.currentAudio.removeEventListener("canplaythrough",window.aipkit_tts_handleCanPlayThrough),typeof window.aipkit_tts_handleAudioEnded=="function"&&e.currentAudio.removeEventListener("ended",window.aipkit_tts_handleAudioEnded),typeof window.aipkit_tts_handleAudioPaused=="function"&&e.currentAudio.removeEventListener("pause",window.aipkit_tts_handleAudioPaused),typeof window.aipkit_tts_handleAudioError=="function"&&e.currentAudio.removeEventListener("error",window.aipkit_tts_handleAudioError),e.currentAudio=null),e.currentBlobUrl&&(URL.revokeObjectURL(e.currentBlobUrl),e.currentBlobUrl=null),n&&e.currentlyPlayingButton){e.currentlyPlayingButton.classList.remove("aipkit_loading","aipkit_playing","aipkit_error"),e.currentlyPlayingButton.disabled=!1;let i=e.currentlyPlayingButton.getAttribute("data-original-icon-html");i&&(e.currentlyPlayingButton.innerHTML=i),e.currentlyPlayingButton.removeAttribute("data-original-icon-html"),e.currentlyPlayingButton=null}}window.aipkit_tts_stopCurrentAudio=d})();(function(){"use strict";let d='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-player-pause"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 5m0 1a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1z" /><path d="M14 5m0 1a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1z" /></svg>';function n(){let t=window.aipkitTtsState;!t||!t.currentAudio||!t.currentlyPlayingButton||(t.currentlyPlayingButton.classList.remove("aipkit_loading"),t.currentlyPlayingButton.classList.add("aipkit_playing"),t.currentlyPlayingButton.disabled=!1,t.currentlyPlayingButton.hasAttribute("data-original-icon-html")||t.currentlyPlayingButton.setAttribute("data-original-icon-html",t.currentlyPlayingButton.innerHTML),t.currentlyPlayingButton.innerHTML=d,t.currentAudio.play().catch(o=>{console.error("AIPKit TTS Handler: Error starting playback:",o),typeof window.aipkit_tts_handleAudioError=="function"&&window.aipkit_tts_handleAudioError(o)}))}function e(){typeof window.aipkit_tts_stopCurrentAudio=="function"?window.aipkit_tts_stopCurrentAudio(!0):console.error("AIPKit TTS Handler: stopCurrentAudio function not found for ended event.")}function i(){let t=window.aipkitTtsState;!t||!t.currentAudio||(typeof window.aipkit_tts_stopCurrentAudio=="function"?window.aipkit_tts_stopCurrentAudio(!0):console.error("AIPKit TTS Handler: stopCurrentAudio function not found for paused event."))}function a(t){let o=window.aipkitTtsState;if(!o)return;console.error("AIPKit TTS Handler: Error playing audio.",t);let r=o.currentlyPlayingButton;if(typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!1),r){r.classList.remove("aipkit_loading","aipkit_playing"),r.classList.add("aipkit_error"),r.disabled=!1;let s=r.getAttribute("data-original-icon-html");s&&(r.innerHTML=s),r.removeAttribute("data-original-icon-html")}o.currentlyPlayingButton=null}window.aipkit_tts_handleCanPlayThrough=n,window.aipkit_tts_handleAudioEnded=e,window.aipkit_tts_handleAudioPaused=i,window.aipkit_tts_handleAudioError=a})();(function(){"use strict";function d(n,e,i){let a=window.aipkitTtsState;if(!a){console.error("AIPKit TTS PlayFromBase64: State object not found."),typeof window.aipkit_tts_handleAudioError=="function"&&window.aipkit_tts_handleAudioError(new Error("TTS State missing"));return}try{let t=atob(n),o=new Array(t.length);for(let u=0;u<t.length;u++)o[u]=t.charCodeAt(u);let r=new Uint8Array(o),s=new Blob([r],{type:e});a.currentBlobUrl&&typeof URL.revokeObjectURL=="function"&&URL.revokeObjectURL(a.currentBlobUrl),a.currentBlobUrl=URL.createObjectURL(s),a.currentAudio&&typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!0),a.currentAudio=new Audio(a.currentBlobUrl),a.currentlyPlayingButton=i,typeof window.aipkit_tts_handleCanPlayThrough=="function"&&a.currentAudio.addEventListener("canplaythrough",window.aipkit_tts_handleCanPlayThrough),typeof window.aipkit_tts_handleAudioEnded=="function"&&a.currentAudio.addEventListener("ended",window.aipkit_tts_handleAudioEnded),typeof window.aipkit_tts_handleAudioPaused=="function"&&a.currentAudio.addEventListener("pause",window.aipkit_tts_handleAudioPaused),typeof window.aipkit_tts_handleAudioError=="function"?a.currentAudio.addEventListener("error",window.aipkit_tts_handleAudioError):console.error("AIPKit TTS PlayFromBase64: Audio error handler is missing globally."),a.currentAudio.load()}catch(t){console.error("AIPKit TTS PlayFromBase64: Error processing base64 or creating Blob URL:",t),typeof window.aipkit_tts_handleAudioError=="function"&&window.aipkit_tts_handleAudioError(t)}}window.aipkit_tts_playAudioFromBase64=d})();(function(){"use strict";async function d(n){let e=window.aipkitTtsState;if(!e){console.error("AIPKit TTS PlayAction: State object not found."),n&&(n.classList.remove("aipkit_loading"),n.classList.add("aipkit_error"),n.disabled=!1);return}let i=n.closest(".aipkit_chat_message"),a=i?i.querySelector(".aipkit_chat_bubble"):null,t=n.closest(".aipkit_chat_container[data-config]");t||(t=n.closest(".aipkit_popup_wrapper[data-config]"));let o=t?t.getAttribute("data-config"):null,r=null;if(!a||!t||!o){console.error("AIPKit TTS PlayAction: Could not find message bubble, config holder, or config attribute."),n&&(n.classList.remove("aipkit_loading"),n.classList.add("aipkit_error"),n.disabled=!1);return}try{r=JSON.parse(o)}catch(p){console.error("AIPKit TTS PlayAction: Failed to parse config.",p);return}let s=a.getAttribute("data-raw-text")||"",u=r.botId;if(!s){console.warn("AIPKit TTS PlayAction: No text found to play.");return}if(!u){console.error("AIPKit TTS PlayAction: Missing botId in config.");return}if(n===e.currentlyPlayingButton){typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!0);return}typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!0),n.classList.remove("aipkit_error","aipkit_playing"),n.classList.add("aipkit_loading"),n.disabled=!0;try{let p={text:s};if(typeof window.aipkit_frontendApiRequest!="function")throw console.error("AIPKit TTS PlayAction Error: aipkit_frontendApiRequest function not found."),new Error("Internal script error (TTS API).");let l=await window.aipkit_frontendApiRequest("aipkit_generate_speech",p,r);if(l&&l.audio_data_base64&&l.mime_type)if(typeof window.aipkit_tts_playAudioFromBase64=="function")window.aipkit_tts_playAudioFromBase64(l.audio_data_base64,l.mime_type,n);else throw console.error("AIPKit TTS PlayAction Error: playAudioFromBase64 function not found."),new Error("Internal script error (TTS Playback).");else throw console.error("AIPKit TTS PlayAction: API response missing audio data or mime type. Response:",l),new Error("Invalid response received from speech generation.")}catch(p){if(console.error("AIPKit TTS PlayAction: Error generating speech:",p),n){n.classList.remove("aipkit_loading","aipkit_playing"),n.classList.add("aipkit_error"),n.disabled=!1;let l=n.getAttribute("data-original-icon-html");l&&(n.innerHTML=l),n.removeAttribute("data-original-icon-html")}e.currentlyPlayingButton=null}}window.aipkit_handlePlayAction=d})();(function(){"use strict";function d(n,e,i,a,t){return new Promise((o,r)=>{if(!e.ajaxUrl)return r(new Error("Missing ajaxUrl in config for SSE cache."));if(!e.nonce)return r(new Error("Missing nonce in config for SSE cache."));let s=new FormData;s.append("action","aipkit_cache_sse_message"),s.append("message",n),s.append("_ajax_nonce",e.nonce),e.botId&&s.append("bot_id",e.botId),i&&s.append("image_inputs",JSON.stringify([i])),t&&s.append("user_client_message_id",t);let u=a;if(!u&&window.aipkit_current_conversation_uuid)try{let w=localStorage.getItem(`aipkit_file_context_${window.aipkit_current_conversation_uuid}`);w&&(u=JSON.parse(w))}catch(w){console.error("CacheSSE: Error reading file context from localStorage:",w)}u&&(u.provider==="OpenAI"&&u.vector_store_id&&s.append("active_openai_vs_id",u.vector_store_id),u.provider==="Pinecone"&&u.index_name&&u.namespace&&(s.append("active_pinecone_index_name",u.index_name),s.append("active_pinecone_namespace",u.namespace)),u.provider==="Qdrant"&&u.collection_name&&u.file_upload_context_id&&(s.append("active_qdrant_collection_name",u.collection_name),s.append("active_qdrant_file_upload_context_id",u.file_upload_context_id)),u.provider==="Claude"&&u.file_id&&s.append("active_claude_file_id",u.file_id));let p=()=>fetch(e.ajaxUrl,{method:"POST",body:s}).then(w=>w.ok?w.json():w.text().then(_=>{try{let c=JSON.parse(_);if(c?.data?.code==="embed_not_available")throw new Error("The embed feature is not available with your current plan. Please upgrade to use embedded chatbots.");if(c?.data?.code==="cors_denied")throw new Error("This domain is not permitted to access the chatbot. Please check your embed settings.");if(c?.data?.code==="nonce_failure_cache_sse")return l(e).then(()=>(s.set&&s.set("_ajax_nonce",e.nonce),fetch(e.ajaxUrl,{method:"POST",body:s}))).then(f=>f.ok?f.json():f.text().then(g=>{throw new Error(g||`HTTP error ${f.status} caching message.`)}));throw new Error(c?.data?.message||`HTTP error ${w.status} caching message.`)}catch{if(w.status===403)return l(e).then(()=>(s.set&&s.set("_ajax_nonce",e.nonce),fetch(e.ajaxUrl,{method:"POST",body:s}))).then(f=>f.ok?f.json():f.text().then(g=>{throw new Error(g||`HTTP error ${f.status} caching message.`)}));throw new Error(`Failed to prepare message for streaming. Please check your internet connection and try again. (HTTP ${w.status})`)}})).then(w=>{w.success&&w.data?.cache_key?o(w.data.cache_key):r(new Error(w.data?.message||"Failed to cache message for streaming."))}).catch(w=>{console.error("AIPKit SSE Cache Request Error:",w),r(w)});function l(w){return new Promise((_,c)=>{try{if(!w||!w.ajaxUrl)return c(new Error("No ajaxUrl for nonce refresh"));let f=new FormData;f.append("action",typeof window.aipkit_getChatNonceAction=="string"&&window.aipkit_getChatNonceAction?window.aipkit_getChatNonceAction:"aipkit_get_frontend_chat_nonce"),w.botId&&f.append("bot_id",w.botId),fetch(w.ajaxUrl,{method:"POST",body:f,credentials:"same-origin"}).then(g=>g.json()).then(g=>{g&&g.success&&g.data&&g.data.nonce?(w.nonce=g.data.nonce,_(g.data.nonce)):c(new Error("Nonce refresh failed"))}).catch(()=>c(new Error("Nonce refresh network error")))}catch(f){c(f)}})}p()})}window.aipkit_chatUI_cacheSseMessage=d})();(function(){"use strict";function d(n,e,i,a,t,o,r,s,u,p){if(!i.ajaxUrl||!i.nonce)return new Error("Missing ajaxUrl or nonce in config for EventSource.");let l=new URL(i.ajaxUrl);l.searchParams.append("action","aipkit_frontend_chat_stream"),l.searchParams.append("cache_key",n),l.searchParams.append("bot_id",e),l.searchParams.append("session_id",a||""),l.searchParams.append("conversation_uuid",t),o>0&&l.searchParams.append("post_id",o);try{l.searchParams.append("_ts",Date.now().toString())}catch{}i.provider==="OpenAI"&&i.enableOpenAIConversationState&&r&&l.searchParams.append("previous_openai_response_id",r),s&&i.allowWebSearchTool&&(i.provider==="OpenAI"||i.provider==="Claude"||i.provider==="OpenRouter")&&l.searchParams.append("frontend_web_search_active","true"),u&&i.provider==="Google"&&i.allowGoogleSearchGrounding&&l.searchParams.append("frontend_google_search_grounding_active","true"),p&&(p.provider==="OpenAI"&&p.vector_store_id&&l.searchParams.append("active_openai_vs_id",p.vector_store_id),p.provider==="Pinecone"&&p.index_name&&p.namespace&&(l.searchParams.append("active_pinecone_index_name",p.index_name),l.searchParams.append("active_pinecone_namespace",p.namespace)),p.provider==="Qdrant"&&p.collection_name&&p.file_upload_context_id&&(l.searchParams.append("active_qdrant_collection_name",p.collection_name),l.searchParams.append("active_qdrant_file_upload_context_id",p.file_upload_context_id)),p.provider==="Claude"&&p.file_id&&l.searchParams.append("active_claude_file_id",p.file_id)),l.searchParams.append("_ajax_nonce",i.nonce);try{return new EventSource(l.toString())}catch(w){return console.error(`[AIPKit Stream CreateEventSource (${e})] Failed to create EventSource instance:`,w),w}}window.aipkit_chatUI_createEventSource=d})();(function(){"use strict";function d(n,e,i,a){try{let t=JSON.parse(n.data),o=t.message_id;if(o){if(i.currentStreamMessageId&&i.currentStreamMessageId!==o&&a){let r=a.querySelector(`#${CSS.escape(i.currentStreamMessageId)}`);if(r){let s=r.querySelector(".aipkit_chat_bubble");if(s){let u=s.querySelector(".aipkit_stream_indicator");u&&u.parentNode&&u.parentNode.removeChild(u)}r.classList.remove("aipkit_message_streaming"),r.classList.add("aipkit_message_complete")}}i.currentStreamMessageId=o}e.provider==="OpenAI"&&e.enableOpenAIConversationState&&t.openai_response_id&&(window.aipkit_current_openai_response_id=t.openai_response_id,sessionStorage.setItem("aipkit_current_openai_response_id",t.openai_response_id))}catch(t){console.error("[AIPKit Stream HandleMessageStart] Error parsing message_start data:",n.data,t)}}window.aipkit_chatUI_handleMessageStartEvent=d})();(function(){"use strict";function d(n,e){try{let i=JSON.parse(n.data);e.provider==="OpenAI"&&e.enableOpenAIConversationState&&i.id&&(window.aipkit_current_openai_response_id=i.id,sessionStorage.setItem("aipkit_current_openai_response_id",i.id))}catch(i){console.error("[AIPKit Stream HandleOpenAIResponseId] Error parsing data:",n.data,i)}}window.aipkit_chatUI_handleOpenAIResponseIdEvent=d})();(function(){"use strict";function d(n,e){try{let i=JSON.parse(n.data);e.accumulatedGroundingMetadata=i}catch(i){console.error("[AIPKit Stream HandleGroundingMetadata] Error parsing data:",n.data,i)}}window.aipkit_chatUI_handleGroundingMetadataEvent=d})();(function(){"use strict";function d(n,e,i,a,t){try{let o=JSON.parse(n.data),r=o.delta;if(r!==void 0&&t.currentStreamMessageId)if(t.dataReceived)window.aipkit_chatUI_appendOrUpdateMessage(a,t.currentStreamMessageId,r,"bot",i,!1,!1,null),window.aipkit_chatUI_scrollToBottom(a,!0);else{t.dataReceived=!0;let s=`aipkit-typing-indicator-${e}`,u=a.querySelector(`#${CSS.escape(s)}`);if(u){let p=u.querySelector(".aipkit_chat_bubble");if(p){u.id=t.currentStreamMessageId,u.setAttribute("data-message-id",t.currentStreamMessageId),u.classList.remove("aipkit_typing-indicator"),p.dataset.aipkitFullContent=r,p.innerHTML=window.aipkit_md?window.aipkit_md.render(r):r.replace(/\n/g,"<br>"),typeof window.positionStreamingIndicator=="function"&&window.positionStreamingIndicator(p,"aipkit_stream_indicator");let l=typeof window.aipkit_chatUI_createActionsContainerHTML=="function"?window.aipkit_chatUI_createActionsContainerHTML(i):"";l&&!u.querySelector(".aipkit_message_actions")&&(u.insertAdjacentHTML("beforeend",l),u.classList.add("aipkit_has_message_actions")),window.aipkit_chatUI_scrollToBottom(a,!0)}else window.aipkit_chatUI_removeTypingIndicator(a,u),window.aipkit_chatUI_appendOrUpdateMessage(a,t.currentStreamMessageId,r,"bot",i,!1,!1,null),window.aipkit_chatUI_scrollToBottom(a,!0)}else window.aipkit_chatUI_appendOrUpdateMessage(a,t.currentStreamMessageId,r,"bot",i,!1,!1,null),window.aipkit_chatUI_scrollToBottom(a,!0)}else console.warn(`[AIPKit Stream OnMessage (${e})] Received message without delta or missing message ID:`,o)}catch(o){console.error(`[AIPKit Stream OnMessage (${e})] Error parsing message data:`,n.data,o)}}window.aipkit_chatUI_handleOnMessageEvent=d})();(function(){"use strict";function d(n,e,i,a,t,o,r){typeof window.aipkit_chatUI_appendOrUpdateMessage=="function"&&r.currentStreamMessageId&&window.aipkit_chatUI_appendOrUpdateMessage(a,r.currentStreamMessageId,"","bot",i,!0,!1,r.accumulatedGroundingMetadata),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(a,!0),typeof t=="function"&&t(),o.current&&(o.current.close(),o.current=null)}window.aipkit_chatUI_handleDoneEvent=d})();(function(){"use strict";function d(n,e,i,a,t){console.warn(`[AIPKit Stream HandleWarning (${e})] Received 'warning' event:`,n.data),t.dataReceived||(t.dataReceived=!0);try{let o=JSON.parse(n.data);o.error&&t.currentStreamMessageId&&typeof window.aipkit_chatUI_appendOrUpdateMessage=="function"&&(window.aipkit_chatUI_appendOrUpdateMessage(a,t.currentStreamMessageId,`

*${o.error}*`,"bot",i,!1,!0,null),window.aipkit_chatUI_scrollToBottom(a,!0))}catch(o){console.error(`[AIPKit Stream HandleWarning (${e})] Error parsing warning data:`,n.data,o)}}window.aipkit_chatUI_handleWarningEvent=d})();(function(){"use strict";function d(n,e,i,a,t,o,r){window.aipkit_chatUI_removeTypingIndicator(a);let s=i.text||{};console.error(`[AIPKit Stream HandleError (${e})] EventSource error.`,n);let u=null;if(n.data)try{let l=JSON.parse(n.data);l.error&&(u=l.error)}catch{typeof n.data=="string"&&n.data.length>0&&n.data.length<200&&(u=n.data)}else n.target&&n.target.readyState===EventSource.CLOSED?u="Connection was closed.":n.message&&(u=n.message);let p="";u?p=`${s.errorPrefix||"Error:"} ${u}`:p=r.dataReceived?s.streamError||"Stream error. Please try again.":s.connError||"Connection error. Please check setup or try again.",typeof t=="function"&&t(p,!1,!0),r.currentStreamMessageId=null,o.current&&(o.current.close(),o.current=null)}window.aipkit_chatUI_handleErrorEvent=d})();(function(){"use strict";function d(n,e,i,a,t){typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(a);try{let r=JSON.parse(n.data).form_definition;if(typeof r!="object"||r===null){console.error(`[AIPKit Stream HandleDisplayForm (${e})] Invalid or missing form_definition in event data.`);return}if(typeof window.aipkit_chatUI_renderChatForm!="function"){console.error(`[AIPKit Stream HandleDisplayForm (${e})] renderChatForm function not found.`);return}if(typeof window.aipkit_generateClientMessageId!="function"){console.error(`[AIPKit Stream HandleDisplayForm (${e})] generateClientMessageId function not found.`);return}let s=window.aipkit_generateClientMessageId(e);window.aipkit_chatUI_renderChatForm(a,r,i,s);let u=a.closest(".aipkit_chat_container");u&&u.dispatchEvent(new CustomEvent("aipkit:formDisplayed",{detail:{formId:r.form_id,messageId:s}}))}catch(o){console.error(`[AIPKit Stream HandleDisplayForm (${e})] Error parsing event data or rendering form:`,o,"Raw event data:",n.data)}}window.aipkit_chatUI_handleDisplayFormEvent=d})();(function(){"use strict";async function d(n,e,i,a,t,o,r,s,u,p,l){let w=i.text||{},_={dataReceived:!1,currentStreamMessageId:null,accumulatedGroundingMetadata:null},c={current:null},f=["aipkit_chatUI_cacheSseMessage","aipkit_chatUI_createEventSource","aipkit_chatUI_handleMessageStartEvent","aipkit_chatUI_handleOpenAIResponseIdEvent","aipkit_chatUI_handleGroundingMetadataEvent","aipkit_chatUI_handleOnMessageEvent","aipkit_chatUI_handleDoneEvent","aipkit_chatUI_handleWarningEvent","aipkit_chatUI_handleErrorEvent","aipkit_chatUI_removeTypingIndicator","aipkit_chatUI_handleDisplayFormEvent"];for(let v of f)if(typeof window[v]!="function"){console.error(`[AIPKit Stream Orchestrator (${e})] Missing required helper function: ${v}`),typeof t=="function"&&t(`${w.errorPrefix||"Error:"} Critical script component missing.`,!1,!0),typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(a);return}let g=window.aipkit_current_conversation_uuid,m=window.aipkit_guest_uuid,h=window.aipkit_current_post_id,b=window.aipkit_current_openai_response_id;if(!g){console.error(`[AIPKit Stream Orchestrator (${e})] Missing currentConversationUUID.`),typeof t=="function"&&t(w.errorPrefix+" "+(w.connError||"Configuration error (Conv ID)."),!1);return}let I=null;try{I=await window.aipkit_chatUI_cacheSseMessage(n,i,u,p,l)}catch(v){if(console.error(`[AIPKit Stream Orchestrator (${e})] Failed to cache message (see details below):`,v.message||"Unknown error during cache attempt."),console.error(`[AIPKit Stream Orchestrator (${e})] Full error object from cache failure:`,v),typeof t=="function"){let U=`${w.errorPrefix||"Error:"} Failed to prepare message for streaming.`;v&&typeof v=="object"&&v.code?U+=` (Code: ${v.code})`:v&&v.message?U+=` (${v.message})`:U+=" (Unknown error)",t(U)}typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(a);return}let y=window.aipkit_chatUI_createEventSource(I,e,i,m,g,h,b,r,s,p);if(y instanceof Error){console.error(`[AIPKit Stream Orchestrator (${e})] Error creating EventSource:`,y),typeof t=="function"&&t(w.connError||"Connection error. Please try again.",!1,!0),window.aipkit_chatUI_removeTypingIndicator(a);return}c.current=y,c.current.addEventListener("message_start",v=>window.aipkit_chatUI_handleMessageStartEvent(v,i,_,a)),c.current.addEventListener("openai_response_id",v=>window.aipkit_chatUI_handleOpenAIResponseIdEvent(v,i)),c.current.addEventListener("grounding_metadata",v=>window.aipkit_chatUI_handleGroundingMetadataEvent(v,_)),c.current.addEventListener("display_form_event",v=>window.aipkit_chatUI_handleDisplayFormEvent(v,e,i,a,_)),c.current.onmessage=v=>window.aipkit_chatUI_handleOnMessageEvent(v,e,i,a,_),c.current.addEventListener("done",v=>window.aipkit_chatUI_handleDoneEvent(v,e,i,a,o,c,_)),c.current.addEventListener("warning",v=>window.aipkit_chatUI_handleWarningEvent(v,e,i,a,_)),c.current.onerror=v=>window.aipkit_chatUI_handleErrorEvent(v,e,i,a,t,c,_)}window.aipkit_chatUI_streamMessage=d})();(function(){"use strict";async function d(n,e,i,a){n.preventDefault();let t=n.target;if(!t)return;let o=t.dataset.formId;if(!o){console.error("AIPKit Chat Form: Form ID missing from submitted form.");return}let r=new FormData(t),s={},u={},p={},l=t.aipkitFieldMeta&&typeof t.aipkitFieldMeta=="object"?t.aipkitFieldMeta:{},w=(m,h)=>{let b=l[m]&&typeof l[m]=="object"?l[m]:null,I=b&&b.optionsMap&&typeof b.optionsMap=="object"?b.optionsMap:{},y=String(h??"");return Object.prototype.hasOwnProperty.call(I,y)?String(I[y]??y):y},_=m=>{if(p[m])return;let h=l[m]&&typeof l[m]=="object"?l[m]:null;p[m]=String(h?.label||m)};for(let[m,h]of r.entries())if(m.endsWith("[]")){let b=m.slice(0,-2);_(b);let I=w(b,h);s[b]||(s[b]=[]),s[b].push(h),u[b]||(u[b]=[]),u[b].push(I)}else _(m),s[m]=h,u[m]=w(m,h);let c=t.querySelector('button[type="submit"]');c&&(c.disabled=!0);let f=t.closest(".aipkit_chat_form_wrapper"),g={form_id:o,submitted_data:JSON.stringify(s),submitted_data_display:JSON.stringify(u),submitted_data_labels:JSON.stringify(p)};try{if(typeof window.aipkit_frontendApiRequest!="function")throw new Error("Frontend API request function not found.");let m=await window.aipkit_frontendApiRequest("aipkit_handle_form_submission",g,e);if(c&&(c.disabled=!1),m.message_to_user?typeof window.aipkit_chatUI_appendMessage=="function"&&typeof window.aipkit_generateClientMessageId=="function"?window.aipkit_chatUI_appendMessage(i.messagesEl,m.message_to_user,"bot",e,!1,!1,m.message_id||window.aipkit_generateClientMessageId(e.botId),!0):console.error("AIPKit Chat Form: appendMessage or generateClientMessageId function not found."):m.message&&typeof window.aipkit_chatUI_appendMessage=="function"&&typeof window.aipkit_generateClientMessageId=="function"&&window.aipkit_chatUI_appendMessage(i.messagesEl,m.message,"bot",e,!1,!1,window.aipkit_generateClientMessageId(e.botId),!0),f){let h=f.closest(".aipkit_chat_message");h&&(h.remove(),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(i.messagesEl,!0))}}catch(m){console.error(`AIPKit Chat Form (${e.botId}): Error submitting form "${o}":`,m),c&&(c.disabled=!1),typeof a.handleError=="function"?a.handleError(m.message||"Failed to submit form.",!1,!0):typeof window.aipkit_chatUI_showInlineNotice=="function"&&window.aipkit_chatUI_showInlineNotice(m.message||"Failed to submit form.","error",{elements:i,config:e},!0,7e3)}}window.aipkit_chatUI_handleChatFormSubmission=d})();(function(){"use strict";let d=!1,n=null,e=null,i=null,a=null;function t(){n&&(n.classList.remove("aipkit_active"),n.setAttribute("aria-hidden","true"),n=null,d=!1),e&&(e.setAttribute("aria-expanded","false"),e=null),i&&(document.removeEventListener("click",i,!0),document.removeEventListener("click",i,!1),i=null),a&&(document.removeEventListener("keydown",a,!0),document.removeEventListener("keydown",a,!1),a=null)}window.aipkit_chatUI_closeActiveDownloadMenu=t,window.aipkit_chatUI_setActiveDownloadMenu=function(o,r,s,u,p){n=o,d=r,i=s,e=u||null,a=p||null},window.aipkit_chatUI_getDownloadMenuState=function(){return{isOpen:d,activeMenu:n,activeTrigger:e,handler:i,keyHandler:a}}})();(function(){"use strict";function d(n,e){if(!n||!e)return;let{inputActionButton:i,inputActionMenu:a}=n;e.activeInputActionMenu&&e.activeInputActionTrigger&&(a&&(a.classList.remove("aipkit-action-menu-open"),a.setAttribute("aria-hidden","true"),setTimeout(()=>{a&&!a.classList.contains("aipkit-action-menu-open")&&a.setAttribute("hidden","hidden")},200)),i&&(i.classList.remove("aipkit_active"),i.setAttribute("aria-expanded","false")),e.activeInputActionMenu=null,e.activeInputActionTrigger=null,e.isActionMenuOpen=!1,e.closeActionMenuHandler&&(document.removeEventListener("click",e.closeActionMenuHandler,!0),document.removeEventListener("keydown",e.closeActionMenuHandler,!0),e.closeActionMenuHandler=null))}window.aipkit_chatUI_closeActiveInputActionMenu=d})();(function(){"use strict";function d(n,e,i){let{inputActionButton:a,inputActionMenu:t,imageUploadInput:o,fileUploadInput:r}=n,{fileUploadEnabledUI:s,imageUploadEnabledUI:u}=e,p=()=>{t&&(t.classList.remove("aipkit-action-menu-open"),t.setAttribute("aria-hidden","true"),t.setAttribute("hidden","hidden"))};if(!a){p();return}let l='<svg xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-paperclip"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 7l-6.5 6.5a1.5 1.5 0 0 0 3 3l6.5 -6.5a3 3 0 0 0 -6 -6l-6.5 6.5a4.5 4.5 0 0 0 9 9l6.5 -6.5" /></svg>',w='<svg xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-photo-up"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 8h.01" /><path d="M12.5 21h-6.5a3 3 0 0 1 -3 -3v-12a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v6.5" /><path d="M3 16l5 -5c.928 -.893 2.072 -.893 3 0l3.5 3.5" /><path d="M14 14l1 -1c.679 -.653 1.473 -.829 2.214 -.526" /><path d="M19 22v-6" /><path d="M22 19l-3 -3l-3 3" /></svg>',_='<svg xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-file-upload"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 3v4a1 1 0 0 0 1 1h4" /><path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" /><path d="M12 11v6" /><path d="M9.5 13.5l2.5 -2.5l2.5 2.5" /></svg>';a.onclick=null;let c=window.aipkit_chatUI_closeActiveDownloadMenu,f=window.aipkit_chatUI_closeActiveInputActionMenu;if(typeof c!="function"||typeof f!="function"){console.error("AIPKit SetupInputActionButton: Missing global menu utility functions (closeDownloadMenu or closeInputActionMenu).");return}let g=l,m=e.text?.attachTools||"Attach or use tools",h="true";if(s&&!u)g=_,m=e.text?.uploadFile||"Upload File (TXT, PDF)",h="false";else if(!s&&u)g=w,m=e.text?.uploadImage||"Upload Image",h="false";else if(!s&&!u){a.hidden=!0,p();return}a.hidden=!1,a.innerHTML=g,a.setAttribute("aria-label",m),h==="true"?(a.setAttribute("aria-haspopup","true"),a.setAttribute("aria-expanded","false")):(a.removeAttribute("aria-haspopup"),a.removeAttribute("aria-expanded")),s&&u?(p(),a.onclick=b=>{b.stopPropagation(),c(),!i.isActionMenuOpen?(t&&(t.removeAttribute("hidden"),requestAnimationFrame(()=>{t&&t.classList.add("aipkit-action-menu-open")}),t.setAttribute("aria-hidden","false"),requestAnimationFrame(()=>{let y=t.querySelector(".aipkit_input_action_menu_item:not(:disabled)");y&&typeof y.focus=="function"&&y.focus()})),a.classList.add("aipkit_active"),a.setAttribute("aria-expanded","true"),i.isActionMenuOpen=!0,i.activeInputActionMenu=t,i.activeInputActionTrigger=a,setTimeout(()=>{i.closeActionMenuHandler=y=>{y.type==="click"&&(!i.activeInputActionMenu||!i.activeInputActionTrigger||i.activeInputActionMenu.contains(y.target)||i.activeInputActionTrigger.contains(y.target))||y.type==="keydown"&&y.key!=="Escape"||(f(n,i),y.type==="keydown"&&y.key==="Escape"&&a&&typeof a.focus=="function"&&a.focus())},document.addEventListener("click",i.closeActionMenuHandler,{capture:!0,once:!1}),document.addEventListener("keydown",i.closeActionMenuHandler,{capture:!0,once:!1})},0)):f(n,i)}):s?(p(),a.onclick=b=>{b.stopPropagation(),c(),r?r.click():(console.warn("AIPKit InputActionButton: File upload input not found in elements."),typeof window.aipkit_chatUI_showInlineNotice=="function"&&window.aipkit_chatUI_showInlineNotice(e.text?.uploadInitError||"File upload feature not properly initialized.","error",{elements:n,config:e},!0,7e3))}):u?(p(),a.onclick=b=>{b.stopPropagation(),c(),o?o.click():(console.warn("AIPKit InputActionButton: Image upload input not found in elements."),typeof window.aipkit_chatUI_showInlineNotice=="function"&&window.aipkit_chatUI_showInlineNotice(e.text?.imageUploadInitError||"Image upload feature not properly initialized.","error",{elements:n,config:e},!0,7e3))}):(a.hidden=!0,p())}window.aipkit_chatUI_setupInputActionButton=d})();(function(){"use strict";function d(n,e,i,a){let{actionButton:t}=n;t&&t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",()=>{i.buttonState==="send"&&!t.disabled?a.sendMessageAction():i.buttonState==="clear"&&a.clearChatAction()}),t.dataset.listenerAttached="true")}window.aipkit_chatUI_attachActionButtonListener=d})();(function(){"use strict";function d(n,e,i,a){let{inputField:t,messagesEl:o,actionButton:r}=n;t&&t.dataset.listenerAttached!=="true"&&(t.addEventListener("keydown",s=>{s.key==="Enter"&&!i.isActionMenuOpen&&(s.shiftKey?setTimeout(()=>{typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(t)},0):(s.preventDefault(),i.buttonState==="send"&&!r.disabled&&a.sendMessageAction()))}),t.addEventListener("input",()=>{let s=t.value.trim()==="",u=o.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").length>0;s?u&&i.buttonState!=="sending"&&i.buttonState!=="streaming"?i.buttonState=a.setButtonStateAction("clear",!1,i):i.buttonState!=="sending"&&i.buttonState!=="streaming"&&(i.buttonState=a.setButtonStateAction("send",!1,i)):i.buttonState=a.setButtonStateAction("send",!1,i),typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(t)}),t.dataset.listenerAttached="true")}window.aipkit_chatUI_attachInputFieldListeners=d})();(function(){"use strict";function d(n,e,i,a){let{fullscreenButton:t}=n;t&&typeof a.toggleFullscreenAction=="function"?t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",a.toggleFullscreenAction),t.dataset.listenerAttached="true"):t&&console.warn("AIPKit Chat Events: Fullscreen button exists, but toggleFullscreenAction action is missing.")}window.aipkit_chatUI_attachFullscreenButtonListener=d})();(function(){"use strict";function d(n,e,i,a){let{webSearchToggleButton:t}=n,o=e.allowWebSearchTool&&(e.provider==="OpenAI"||e.provider==="Claude"||e.provider==="OpenRouter");t&&o?t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",r=>{r.stopPropagation(),typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu(),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(n,i),typeof window.aipkit_toggleWebSearchAction=="function"?window.aipkit_toggleWebSearchAction(n,e,i):console.error("AIPKit Chat Events: aipkit_toggleWebSearchAction function not provided.")}),t.dataset.listenerAttached="true"):t&&(t.hidden=!0,t.setAttribute("aria-hidden","true"))}window.aipkit_chatUI_attachWebSearchToggleListener=d})();(function(){"use strict";function d(n,e,i,a){let{googleSearchGroundingToggleButton:t}=n,o=e.allowGoogleSearchGrounding&&e.provider==="Google";t&&o?t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",r=>{r.stopPropagation(),typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu(),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(n,i),typeof window.aipkit_toggleGoogleSearchGroundingAction=="function"?window.aipkit_toggleGoogleSearchGroundingAction(n,e,i):console.error("AIPKit Chat Events: aipkit_toggleGoogleSearchGroundingAction function not provided.")}),t.dataset.listenerAttached="true"):t&&(t.hidden=!0,t.setAttribute("aria-hidden","true"))}window.aipkit_chatUI_attachGoogleGroundingToggleListener=d})();(function(){"use strict";function d(n,e,i,a){let{downloadButton:t}=n;if(!t||!e.enableDownload)return;let o=t.closest(".aipkit_download_wrapper"),r=o?o.querySelector(".aipkit_download_menu"):null,s=e.pdfDownloadActive===!0,u=window.aipkit_chatUI_closeActiveDownloadMenu,p=window.aipkit_chatUI_setActiveDownloadMenu,l=window.aipkit_chatUI_getDownloadMenuState;t.dataset.ariaSetup!=="true"&&(t.setAttribute("aria-haspopup",s&&r?"menu":"false"),t.setAttribute("aria-expanded","false"),r&&r.id&&t.setAttribute("aria-controls",r.id),t.dataset.ariaSetup="true"),r&&r.dataset.ariaSetup!=="true"&&(r.setAttribute("role","menu"),r.setAttribute("aria-hidden","true"),r.querySelectorAll(".aipkit_download_menu_item").forEach(h=>{h.hasAttribute("role")||h.setAttribute("role","menuitem")}),r.dataset.ariaSetup="true");let w=(m=!1)=>{typeof u=="function"&&u(),m&&typeof t.focus=="function"&&t.focus()},_=()=>r?Array.from(r.querySelectorAll(".aipkit_download_menu_item:not(:disabled)")):[],c=()=>{let m=_();m.length>0&&m[0].focus()},f=()=>{if(!(!r||!s)){if(w(!1),r.classList.add("aipkit_active"),r.setAttribute("aria-hidden","false"),t.setAttribute("aria-expanded","true"),typeof p=="function"){let m=b=>{(!o||!o.contains(b.target))&&w(!1)},h=b=>{b.key==="Escape"&&(b.preventDefault(),w(!0))};p(r,!0,m,t,h),document.addEventListener("click",m,!0),document.addEventListener("keydown",h,!0)}requestAnimationFrame(c)}},g=()=>{let m=typeof l=="function"?l():{isOpen:!1,activeMenu:null};m.isOpen&&m.activeMenu===r?w(!1):f()};t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",m=>{if(m.stopPropagation(),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(n,i),s&&r){g();return}typeof a.downloadTranscriptTxtAction=="function"?a.downloadTranscriptTxtAction():console.error("AIPKit Chat Events: downloadTranscriptTxtAction action not provided.")}),t.addEventListener("keydown",m=>{s&&r&&(m.key==="ArrowDown"?(m.preventDefault(),f()):m.key==="Escape"&&(m.preventDefault(),w(!0)))}),t.dataset.listenerAttached="true"),r&&r.dataset.listenerAttached!=="true"&&(r.addEventListener("click",m=>{let h=m.target.closest(".aipkit_download_menu_item");if(!h)return;let b=h.getAttribute("data-format");b==="txt"?typeof a.downloadTranscriptTxtAction=="function"?a.downloadTranscriptTxtAction():console.error("AIPKit Chat Events: downloadTranscriptTxtAction action not provided."):b==="pdf"&&(typeof a.downloadTranscriptPdfAction=="function"?a.downloadTranscriptPdfAction():console.error("AIPKit Chat Events: downloadTranscriptPdfAction action not provided.")),w(!1)}),r.addEventListener("keydown",m=>{let h=_();if(m.key==="Escape"){m.preventDefault(),w(!0);return}if(m.key==="Tab"){w(!1);return}if(h.length===0)return;let b=document.activeElement,I=h.indexOf(b),y=I;if(m.key==="ArrowDown"||m.key==="ArrowRight")m.preventDefault(),y=I<0?0:(I+1)%h.length;else if(m.key==="ArrowUp"||m.key==="ArrowLeft")m.preventDefault(),y=I<=0?h.length-1:I-1;else if(m.key==="Home")m.preventDefault(),y=0;else if(m.key==="End")m.preventDefault(),y=h.length-1;else return;h[y]&&h[y].focus()}),r.dataset.listenerAttached="true")}window.aipkit_chatUI_attachDownloadMenuListeners=d})();(function(){"use strict";function d(n,e,i,a){let{inputActionMenu:t}=n;t&&typeof window.aipkit_chatUI_setupInputActionButton=="function"&&(t.dataset.itemClickListenerAttached!=="true"&&(t.addEventListener("click",o=>{let r=o.target.closest(".aipkit_input_action_menu_item");if(!r)return;o.preventDefault();let s=r.getAttribute("aria-label");s&&s.toLowerCase().includes("image")?n.imageUploadInput?n.imageUploadInput.click():(console.warn("AIPKit Chat Events: Image upload input not found for menu item."),typeof window.aipkit_chatUI_showInlineNotice=="function"&&window.aipkit_chatUI_showInlineNotice(e.text?.imageUploadInitError||"Image upload feature not properly initialized.","error",{elements:n,config:e},!0,7e3)):s&&(s.toLowerCase().includes("pdf")||s.toLowerCase().includes("file"))&&(n.fileUploadInput?n.fileUploadInput.click():(console.warn("AIPKit Chat Events: File upload input not found for menu item."),typeof window.aipkit_chatUI_showInlineNotice=="function"&&window.aipkit_chatUI_showInlineNotice(e.text?.uploadInitError||"File upload feature not properly initialized.","error",{elements:n,config:e},!0,7e3))),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(n,i)}),t.dataset.itemClickListenerAttached="true"),t.dataset.itemKeydownListenerAttached!=="true"&&(t.addEventListener("keydown",o=>{let r=Array.from(t.querySelectorAll(".aipkit_input_action_menu_item:not(:disabled)"));if(o.key==="Escape"){o.preventDefault(),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(n,i),n.inputActionButton&&typeof n.inputActionButton.focus=="function"&&n.inputActionButton.focus();return}if(o.key==="Tab"){typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(n,i);return}if(r.length===0)return;let s=r.indexOf(document.activeElement),u=s;if(o.key==="ArrowDown"||o.key==="ArrowRight")o.preventDefault(),u=s<0?0:(s+1)%r.length;else if(o.key==="ArrowUp"||o.key==="ArrowLeft")o.preventDefault(),u=s<=0?r.length-1:s-1;else if(o.key==="Home")o.preventDefault(),u=0;else if(o.key==="End")o.preventDefault(),u=r.length-1;else return;r[u]&&r[u].focus()}),t.dataset.itemKeydownListenerAttached="true"))}window.aipkit_chatUI_attachInputActionMenuListener=d})();(function(){"use strict";function d(n,e,i,a){let{voiceInputButton:t}=n;t&&e.enableVoiceInputUI&&t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",()=>{typeof window.aipkit_chatUI_handleVoiceInputAction=="function"?window.aipkit_chatUI_handleVoiceInputAction(n,e,i,i.consentUIInstance,a):(console.error("AIPKit Chat Events: aipkit_chatUI_handleVoiceInputAction function not found."),typeof window.aipkit_chatUI_showInlineNotice=="function"&&window.aipkit_chatUI_showInlineNotice(e.text?.voiceUnavailableScriptError||"Voice input is currently unavailable (script error).","error",{elements:n,config:e},!0,7e3))}),t.dataset.listenerAttached="true")}window.aipkit_chatUI_attachVoiceInputButtonListener=d})();(function(){"use strict";function d(n,e,i,a){let{fileUploadInput:t}=n;t&&e.fileUploadEnabledUI&&t.dataset.listenerAttached!=="true"&&(t.addEventListener("change",async o=>{let r=o.target.files[0];if(r&&window.aipkitChatFileUpload&&typeof window.aipkitChatFileUpload.processFile=="function"){let s=n.inputArea||t.closest(".aipkit_chat_input");await window.aipkitChatFileUpload.processFile(r,t,s,e)}else r&&(console.error("AIPKit Chat Events: aipkitChatFileUpload.processFile not found."),typeof window.aipkit_displayChatFileUploadStatus=="function"&&window.aipkit_displayChatFileUploadStatus("File processing system error.","error",n.inputArea))}),t.dataset.listenerAttached="true")}window.aipkit_chatUI_attachFileUploadInputListener=d})();(function(){"use strict";function d(n,e,i,a){let{messagesEl:t}=n;t&&typeof a.handlePlayAction=="function"?t.dataset.playListenerAttached!=="true"&&(t.addEventListener("click",function(o){let r=o.target.closest(".aipkit_play_btn");r&&!r.disabled&&a.handlePlayAction(r)}),t.dataset.playListenerAttached="true"):t&&console.warn("AIPKit Chat Events: handlePlayAction function not provided or invalid during listener attachment.")}window.aipkit_chatUI_attachPlayButtonListener=d})();(function(){"use strict";function d(n,e,i,a){typeof i.isActionMenuOpen>"u"&&(i.isActionMenuOpen=!1,i.activeInputActionMenu=null,i.activeInputActionTrigger=null,i.closeActionMenuHandler=null);let t=["aipkit_chatUI_attachActionButtonListener","aipkit_chatUI_attachInputFieldListeners","aipkit_chatUI_attachFullscreenButtonListener","aipkit_chatUI_attachWebSearchToggleListener","aipkit_chatUI_attachGoogleGroundingToggleListener","aipkit_chatUI_attachDownloadMenuListeners","aipkit_chatUI_attachInputActionMenuListener","aipkit_chatUI_attachVoiceInputButtonListener","aipkit_chatUI_attachFileUploadInputListener","aipkit_chatUI_attachPlayButtonListener"],o=!0;if(t.forEach(r=>{typeof window[r]!="function"&&(console.error(`AIPKit AttachEventListeners Orchestrator: Missing dependency function -> ${r}.`),o=!1)}),!o){console.error("AIPKit AttachEventListeners Orchestrator: Halting due to missing dependencies. Some UI features may not work.");return}window.aipkit_chatUI_attachActionButtonListener(n,e,i,a),window.aipkit_chatUI_attachInputFieldListeners(n,e,i,a),window.aipkit_chatUI_attachFullscreenButtonListener(n,e,i,a),window.aipkit_chatUI_attachWebSearchToggleListener(n,e,i,a),window.aipkit_chatUI_attachGoogleGroundingToggleListener(n,e,i,a),window.aipkit_chatUI_attachDownloadMenuListeners(n,e,i,a),window.aipkit_chatUI_attachInputActionMenuListener(n,e,i,a),window.aipkit_chatUI_attachVoiceInputButtonListener(n,e,i,a),window.aipkit_chatUI_attachFileUploadInputListener(n,e,i,a),window.aipkit_chatUI_attachPlayButtonListener(n,e,i,a)}window.aipkit_chatUI_attachEventListeners=d})();(function(){"use strict";function d(n,e,i,a,t,o,r,s,u,p,l,w){let{messagesEl:_}=a,c=i.text||{};if(!i.ajaxUrl||!e||!i.nonce){console.error(`AIPKit Chat AJAX (${e}): Missing essential config for API request.`),typeof o=="function"&&o(c.errorPrefix+" "+(c.connError||"Configuration error (API)."),!1),typeof r=="function"&&r();return}let f={message:n};s&&i.allowWebSearchTool&&(i.provider==="OpenAI"||i.provider==="Claude"||i.provider==="OpenRouter")&&(f.frontend_web_search_active=!0),u&&i.provider==="Google"&&i.allowGoogleSearchGrounding&&(f.frontend_google_search_grounding_active=!0),p&&(f.image_inputs=JSON.stringify([p]));let g={...i};if(l&&(g.activeFileContext=l,l.provider==="OpenAI"&&l.vector_store_id?console.log(`AIPKit Chat AJAX (sender): Adding OpenAI active_openai_vs_id to request config: ${l.vector_store_id}`):l.provider==="Pinecone"&&l.index_name&&l.namespace?console.log(`AIPKit Chat AJAX (sender): Adding Pinecone context to request config: Index: ${l.index_name}, Namespace: ${l.namespace}`):l.provider==="Qdrant"&&l.collection_name&&l.file_upload_context_id?console.log(`AIPKit Chat AJAX (sender): Adding Qdrant context to request config: Collection: ${l.collection_name}, Context ID: ${l.file_upload_context_id}`):l.provider==="Claude"&&l.file_id&&console.log(`AIPKit Chat AJAX (sender): Adding Claude file context to request config: File ID: ${l.file_id}`)),window.aipkit_chatUI_showTypingIndicator(_,i),typeof window.aipkit_frontendApiRequest!="function"){console.error("AIPKit Chat AJAX Error: aipkit_frontendApiRequest function not found."),typeof o=="function"&&o("Internal script error.",!1),typeof r=="function"&&r();return}window.aipkit_frontendApiRequest("aipkit_frontend_chat_message",f,g).then(m=>{if(window.aipkit_chatUI_removeTypingIndicator(_),m?.reply)i.provider==="OpenAI"&&i.enableOpenAIConversationState&&m.openai_response_id&&(window.aipkit_current_openai_response_id=m.openai_response_id,sessionStorage.setItem("aipkit_current_openai_response_id",m.openai_response_id),console.log(`AIPKit Chat AJAX: Stored new OpenAI Response ID: ${m.openai_response_id}`)),typeof t=="function"&&(t(m.reply,m.message_id||null,m.openai_response_id||null,m.grounding_metadata||null),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(_,!0));else{let h=m?.message||"Unknown error processing message (no reply).";console.error(`AIPKit Chat AJAX (${e}): AJAX Error -`,h,m),typeof o=="function"&&o(`${c.errorPrefix||"Error:"} ${h}`,!1)}}).catch(m=>{window.aipkit_chatUI_removeTypingIndicator(_);let h=`${c.errorPrefix||"Error:"} ${c.connError||"Could not connect."}`;console.error(`AIPKit Chat AJAX (${e}): Network/Fetch Error -`,m),typeof o=="function"&&o(h+(m.message?` (${m.message})`:""),!0)}).finally(()=>{typeof r=="function"&&r()})}window.aipkit_chatUI_sendMessage=d})();(function(){"use strict";function d(){let i=document.body,a=document.documentElement,t=Number(i.dataset.aipkitScrollLockCount||"0");t===0&&(i.dataset.aipkitScrollLockOverflow=i.style.overflow||"",i.dataset.aipkitScrollLockOverflowX=i.style.overflowX||"",i.dataset.aipkitScrollLockOverflowY=i.style.overflowY||"",i.dataset.aipkitScrollLockHtmlOverflow=a.style.overflow||"",i.dataset.aipkitScrollLockHtmlOverflowX=a.style.overflowX||"",i.dataset.aipkitScrollLockHtmlOverflowY=a.style.overflowY||"",i.style.overflow="hidden",i.style.overflowX="hidden",i.style.overflowY="hidden",a.style.overflow="hidden",a.style.overflowX="hidden",a.style.overflowY="hidden"),i.dataset.aipkitScrollLockCount=String(t+1)}function n(){let i=document.body,a=document.documentElement,t=Number(i.dataset.aipkitScrollLockCount||"0");t<=1?(i.style.overflow=i.dataset.aipkitScrollLockOverflow||"",i.style.overflowX=i.dataset.aipkitScrollLockOverflowX||"",i.style.overflowY=i.dataset.aipkitScrollLockOverflowY||"",a.style.overflow=i.dataset.aipkitScrollLockHtmlOverflow||"",a.style.overflowX=i.dataset.aipkitScrollLockHtmlOverflowX||"",a.style.overflowY=i.dataset.aipkitScrollLockHtmlOverflowY||"",delete i.dataset.aipkitScrollLockOverflow,delete i.dataset.aipkitScrollLockOverflowX,delete i.dataset.aipkitScrollLockOverflowY,delete i.dataset.aipkitScrollLockHtmlOverflow,delete i.dataset.aipkitScrollLockHtmlOverflowX,delete i.dataset.aipkitScrollLockHtmlOverflowY,delete i.dataset.aipkitScrollLockCount):i.dataset.aipkitScrollLockCount=String(t-1)}function e(i,a,t){let{container:o,fullscreenButton:r,messagesEl:s,inputField:u,startersContainer:p}=i,l=t.text||{};if(!o||!r){console.error("AIPKit Fullscreen: Container or fullscreen button element not found.");return}a.isFullscreen=!a.isFullscreen;let w=!!o.closest("#aipkit_admin_chat_preview_container");if(a.isFullscreen){if(!a.fullscreenPlaceholder){let g=document.createElement("div");g.id=`aipkit_fs_placeholder_${o.id}`,g.style.display="none",o.parentNode.insertBefore(g,o),a.fullscreenPlaceholder=g}document.body.appendChild(o),o.classList.add("aipkit-fullscreen"),w||d()}else o.classList.remove("aipkit-fullscreen"),a.fullscreenPlaceholder&&a.fullscreenPlaceholder.parentNode?(a.fullscreenPlaceholder.parentNode.insertBefore(o,a.fullscreenPlaceholder),a.fullscreenPlaceholder.remove(),a.fullscreenPlaceholder=null):console.warn("AIPKit Fullscreen: Could not find placeholder to return chat container to its original position."),w||n();let _=o.closest(".aipkit_popup_wrapper");_&&_.classList.toggle("aipkit-fullscreen-wrapper",a.isFullscreen);let c='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-arrows-maximize"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M16 4l4 0l0 4" /><path d="M14 10l6 -6" /><path d="M8 20l-4 0l0 -4" /><path d="M4 20l6 -6" /><path d="M16 20l4 0l0 -4" /><path d="M14 14l6 6" /><path d="M8 4l-4 0l0 4" /><path d="M4 4l6 6" /></svg>',f='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-arrows-minimize"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9l4 0l0 -4" /><path d="M3 3l6 6" /><path d="M5 15l4 0l0 4" /><path d="M3 21l6 -6" /><path d="M19 9l-4 0l0 -4" /><path d="M15 9l6 -6" /><path d="M19 15l-4 0l0 4" /><path d="M15 15l6 6" /></svg>';if(r.innerHTML=a.isFullscreen?f:c,r.title=a.isFullscreen?l.exitFullscreen||"Exit Fullscreen":l.fullscreen||"Fullscreen",r.setAttribute("aria-label",r.title),r.setAttribute("aria-expanded",a.isFullscreen.toString()),a.isFullscreen&&typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(s,!0),u&&setTimeout(()=>u.focus(),50),typeof window.aipkit_chatUI_triggerMessageAnimation=="function"&&s){let g=s.querySelector(".aipkit_initial_greeting");g&&window.aipkit_chatUI_triggerMessageAnimation(g)}typeof window.aipkit_chatUI_refreshStartersAnimation=="function"&&p&&window.aipkit_chatUI_refreshStartersAnimation(p)}window.aipkit_chatUI_toggleFullscreen=e})();(function(){"use strict";function d(n,e,i,a,t){let{state:o,elements:r,config:s,setButtonStateAction:u,handleError:p,generateClientMessageId:l,focusInputAction:w}=t,{inputField:_,voiceInputButton:c,messagesEl:f,container:g}=r;o.isSending=!0,_.disabled=!0,c&&(c.disabled=!0),u("sending",!0,o);let m=null;typeof window.aipkit_chatUI_showImageLoadingIndicator=="function"?m=window.aipkit_chatUI_showImageLoadingIndicator(f,s):(console.error("AIPKit Image Gen: aipkit_chatUI_showImageLoadingIndicator function not found."),typeof window.aipkit_chatUI_showTypingIndicator=="function"&&window.aipkit_chatUI_showTypingIndicator(f,s));let h={prompt:n,original_user_text:e,user_message_id:i};if(typeof window.aipkit_frontendApiRequest!="function"){console.error("AIPKit Chat Image Gen Error: aipkit_frontendApiRequest function not found."),p("Internal script error (image gen).",!1,!0),typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"&&window.aipkit_chatUI_removeImageLoadingIndicator(f,m),o.isSending=!1,_.disabled=s.requireConsentCompliance&&!o.consentGiven,c&&(c.disabled=s.requireConsentCompliance&&!o.consentGiven),u("send",!1,o),(!s.requireConsentCompliance||o.consentGiven)&&w();return}window.aipkit_frontendApiRequest("aipkit_chat_generate_image",h,s).then(b=>{if(typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"?window.aipkit_chatUI_removeImageLoadingIndicator(f,m):typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(f),b?.type==="image"&&b.images&&b.images.length>0){let I={type:"image",images:b.images,prompt:n};window.aipkit_chatUI_appendMessage(f,I,"bot",s,!1,!1,b.message_id,!0),g?g.dispatchEvent(new CustomEvent("aipkit:messageReceived",{detail:{messageId:b.message_id,conversationUUID:window.aipkit_current_conversation_uuid,newConversation:a}})):console.error("AIPKit Image Gen: Container element not found for dispatching event.")}else{let I=b?.message||"Invalid response for image generation (no images).";console.error(`AIPKit Chat Image Gen: ${I}`,b),p(`Image generation failed: ${I}`,!1,!0)}}).catch(b=>{typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"?window.aipkit_chatUI_removeImageLoadingIndicator(f,m):typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(f),p("Image generation failed: "+(b.message||"Unknown error"),!1,!0)}).finally(()=>{o.isSending=!1,_.disabled=s.requireConsentCompliance&&!o.consentGiven,c&&(c.disabled=s.requireConsentCompliance&&!o.consentGiven),u("send",!1,o),(!s.requireConsentCompliance||o.consentGiven)&&w()})}window.aipkit_chatUI_handleImageGeneration=d})();(function(){"use strict";function d(n,e,i,a){let t=n.toLowerCase(),o=i&&i.ipsList?i.ipsList.split(",").map(s=>s.trim()).filter(s=>s!==""):[];if(e&&o.length>0&&o.includes(e))return console.warn(`AIPKit Moderation: Banned IP detected: "${e}"`),{type:"banned_ip",message:i.message||"Access from your IP address has been blocked."};let r=a&&a.wordsList?a.wordsList.toLowerCase().split(",").map(s=>s.trim()).filter(s=>s!==""):[];if(r.length>0){let s=r.find(u=>t.includes(u));if(s)return console.warn(`AIPKit Moderation: Banned word detected: "${s}"`),{type:"banned_word",message:a.message||"Sorry, your message could not be sent as it contains prohibited words.",word:s}}return null}window.aipkit_checkMessageModeration=d})();(function(){"use strict";function d(t){return t?t.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").length===0:!0}function n(t){t&&(t.classList.add("aipkit_hidden"),t.classList.remove("aipkit_starters_ready"))}function e(t){t&&(t.classList.remove("aipkit_hidden"),i(t))}function i(t){!t||t.classList.contains("aipkit_hidden")||(t.classList.remove("aipkit_starters_ready"),t.offsetHeight,requestAnimationFrame(()=>{t.classList.contains("aipkit_hidden")||t.classList.add("aipkit_starters_ready")}))}function a(t,o,r,s,u,p){let{startersContainer:l,messagesEl:w,inputField:_}=r,c=o.botId,f=o.starters||[];if(!t||!o||!l||!w||!_){console.error(`AIPKit Starters (${c}): Missing container, config, startersContainer, messagesEl, or inputField.`);return}if(typeof s!="function"){console.error(`AIPKit Starters (${c}): sendMessageActionCallback is not a function.`),n(l);return}if(typeof p!="function"){console.error(`AIPKit Starters (${c}): isConsentGivenFunc is not a function.`),n(l);return}if(f.length===0){n(l);return}l.innerHTML="",f.forEach((h,b)=>{if(typeof h=="string"&&h.trim()!==""){let I=document.createElement("button");I.type="button",I.className="aipkit_starter_btn",I.textContent=h.trim(),I.style.setProperty("--aipkit-starter-index",String(b)),I.addEventListener("click",y=>{if(y.preventDefault(),u&&!p()){console.warn(`AIPKit Starters (${c}): Starter clicked, but consent not given.`);return}let v=I.textContent;s(v),n(l)}),l.appendChild(I)}});let g=()=>{if(u&&!p()){n(l);return}d(w)?e(l):n(l)},m=()=>n(l);t.addEventListener("aipkit:messageSent",m),t.addEventListener("aipkit:messageReceived",m),t.addEventListener("aipkit:messageError",m),t.addEventListener("aipkit:chatCleared",g),t.addEventListener("aipkit:chatLoaded",g),t.addEventListener("aipkit:consentGiven",()=>{g()}),g()}window.aipkit_initConversationStarters=a,window.aipkit_chatUI_refreshStartersAnimation=i})();function ue(d,n){let e=window.aipkit_chatUI_findElements(d,n);if(!e){let r=d.querySelector(".aipkit_chat_container")||d;return r&&typeof window.aipkit_chatUI_renderUIState=="function"?window.aipkit_chatUI_renderUIState(r,{message:"Chatbot UI error (DOM elements missing).",type:"error",scope:"messages"}):r&&(r.textContent="Chatbot UI error (DOM elements missing)."),null}let i=n.botId,a=window.aipkit_chatUI_initState(n);a.consentUIInstance=null;let t={setButtonStateAction:(r,s=!1)=>window.aipkit_chatUI_setButtonStateAction(r,e,n,a,s),focusInputAction:()=>window.aipkit_chatUI_focusInputAction(e.inputField,n,a),sendMessageAction:(r=null)=>window.aipkit_chatUI_sendMessageAction(e,n,a,t,r),clearChatAction:()=>window.aipkit_chatUI_clearChatAction(e,n,a,t),handleError:(r,s,u=!0)=>window.aipkit_chatUI_handleError(r,s,u,e,n,a,t),handleCompletion:(r,s=!1)=>window.aipkit_chatUI_handleCompletion(r,s,e,n,a,t),toggleFullscreenAction:()=>window.aipkit_chatUI_toggleFullscreen(e,a,n),downloadTranscriptTxtAction:()=>window.aipkit_chatUI_downloadTranscriptActionTxt(e,n),downloadTranscriptPdfAction:()=>window.aipkit_chatUI_downloadTranscriptActionPdf(e,n),handlePlayAction:r=>window.aipkit_handlePlayAction(r)};if(n.requireConsentCompliance&&typeof window.aipkit_initConsentUI=="function"?a.consentUIInstance=window.aipkit_initConsentUI(e.mainContentEl,n,a,()=>{e.inputField.disabled=!1,t.setButtonStateAction("send",!1),t.focusInputAction(),e.voiceInputButton&&(e.voiceInputButton.disabled=!1),e.inputActionButton&&(e.inputActionButton.disabled=!1),e.webSearchToggleButton&&(e.webSearchToggleButton.disabled=!1),e.googleSearchGroundingToggleButton&&(e.googleSearchGroundingToggleButton.disabled=!1)}):n.requireConsentCompliance&&console.error(`AIPKit Chat Main (${i}): Consent required, but aipkit_initConsentUI function not found.`),n.imageUploadEnabledUI&&window.chatImageUpload&&typeof window.chatImageUpload.init=="function"?e.imageUploadInput&&e.imagePreviewContainer?(window.chatImageUpload.init(e.imageUploadInput,e.imagePreviewContainer),e.container&&e.container.classList.add("aipkit-image-upload-enabled")):console.warn(`AIPKit Chat UI Main (${i}): Image Upload UI enabled, but input or preview elements were not found/created by findElements.`):n.imageUploadEnabledUI&&console.warn(`AIPKit Chat UI Main (${i}): Image Upload UI enabled, but chatImageUpload script not found or init function missing.`),typeof window.aipkit_chatUI_setupInputActionButton=="function"?window.aipkit_chatUI_setupInputActionButton(e,n,a):(console.error(`AIPKit Chat Main (${i}): setupInputActionButton function not found.`),e.inputActionButton&&(e.inputActionButton.hidden=!0),e.inputActionMenu&&(e.inputActionMenu.classList.remove("aipkit-action-menu-open"),e.inputActionMenu.setAttribute("aria-hidden","true"),e.inputActionMenu.setAttribute("hidden","hidden"))),typeof window.aipkit_chatUI_attachEventListeners=="function"?window.aipkit_chatUI_attachEventListeners(e,n,a,t):console.error(`AIPKit Chat Main (${i}): attachEventListeners not defined.`),typeof window.aipkit_chatUI_initMessageActions=="function"?window.aipkit_chatUI_initMessageActions(e.messagesEl,n):console.warn(`AIPKit Chat Main (${i}): aipkit_chatUI_initMessageActions missing; message actions might not work.`),typeof window.aipkit_chatUI_initScrollToBottomButton=="function"?window.aipkit_chatUI_initScrollToBottomButton(e,n,a):console.warn(`AIPKit Chat Main (${i}): aipkit_chatUI_initScrollToBottomButton missing; scroll button won't render.`),n.enableStarters&&e.startersContainer&&typeof window.aipkit_initConversationStarters=="function"){let r=a.consentUIInstance?a.consentUIInstance.isConsentGiven:()=>!n.requireConsentCompliance||a.consentGiven;window.aipkit_initConversationStarters(d,n,e,t.sendMessageAction,n.requireConsentCompliance,r)}else n.enableStarters&&console.warn(`AIPKit Chat Main (${i}): Starters enabled but container or init function missing.`);n.enableSidebar&&e.sidebarEl&&e.sidebarToggleBtn&&typeof window.aipkit_initConversationSidebar=="function"?window.aipkit_initConversationSidebar(d,e,n,t):n.enableSidebar&&console.warn(`AIPKit Chat Main (${i}): Sidebar enabled but elements or init function missing.`);let o={openPopup:n.popupEnabled&&typeof window.aipkit_chatUI_openPopup=="function"?()=>window.aipkit_chatUI_openPopup(d,e.messagesEl,e.inputField,a):()=>{},closePopup:n.popupEnabled&&typeof window.aipkit_chatUI_closePopup=="function"?()=>window.aipkit_chatUI_closePopup(d,a):()=>{},setupPopupHandlers:n.popupEnabled&&typeof window.aipkit_chatUI_setupPopupHandlers=="function"?r=>window.aipkit_chatUI_setupPopupHandlers(d,r,e.messagesEl,e.inputField,a,n):()=>{},isPopupOpen:()=>a.isPopupOpen,scrollToBottom:()=>window.aipkit_chatUI_scrollToBottom(e.messagesEl,!0),sendMessage:t.sendMessageAction,clearChat:t.clearChatAction,toggleFullscreen:t.toggleFullscreenAction};return n.enableRealtimeVoiceUI&&typeof window.aipkit_initRealtimeVoiceAgent=="function"?window.aipkit_initRealtimeVoiceAgent(e,n,a,t,o):n.enableRealtimeVoiceUI&&console.error(`AIPKit Chat Main (${i}): Realtime Voice enabled but aipkit_initRealtimeVoiceAgent function not found.`),typeof window.aipkit_chatUI_displayInitialMessage=="function"?window.aipkit_chatUI_displayInitialMessage(e.messagesEl,n):console.error(`AIPKit Chat Main (${i}): displayInitialMessage function not found.`),typeof window.aipkit_chatUI_finalizeSetup=="function"?window.aipkit_chatUI_finalizeSetup(e,n,a,t):console.error(`AIPKit Chat Main (${i}): finalizeSetup function not found.`),{publicApi:o,internalElements:e,internalActions:t}}window.aipkit_setupChatInstanceUI=ue;(function(){"use strict";window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,window.aipkit_current_post_id=0,window.aipkit_current_openai_response_id=null,window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null;let d=localStorage.getItem("aipkit_guest_uuid");d||(d=("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,i=>(i^crypto.getRandomValues(new Uint8Array(1))[0]&15>>i/4).toString(16)),localStorage.setItem("aipkit_guest_uuid",d)),window.aipkit_guest_uuid=d,window.aipkit_regenerateConversationUUID=function(){let i=("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,a=>(a^crypto.getRandomValues(new Uint8Array(1))[0]&15>>a/4).toString(16));return sessionStorage.setItem("aipkit_current_conversation_uuid",i),window.aipkit_current_conversation_uuid=i,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),i},typeof window.aipkit_initializeMarkdownParser=="function"?window.aipkit_initializeMarkdownParser():(console.error("AIPKit Chat Init: markdown-it initializer (aipkit_initializeMarkdownParser) not found. Markdown parsing will be basic."),window.aipkit_md={render:function(i){return console.warn("AIPKit Chat Init: Using fallback markdown renderer because initializer was missing."),(window.aipkit_escapeHtml||function(t){return typeof t!="string"?"":t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")})(i).replace(/\n/g,"<br>")}});function n(i){if(!i||i.classList.contains("aipkit-initializing")||i.classList.contains("aipkit-initialized"))return;i.classList.add("aipkit-initializing");let a=i.getAttribute("data-bot-id"),t=i.getAttribute("data-config"),o=null,r=(l,w)=>{if(l){if(typeof window.aipkit_chatUI_renderUIState=="function"){window.aipkit_chatUI_renderUIState(l,{message:w,type:"error",scope:"messages"});return}l.textContent=w}};try{t&&(o=JSON.parse(t),a&&(o.botId=a))}catch(l){console.error(`AIPKit Chat Init (${a||"Unknown"}): Failed to parse configuration.`,l,t);let w=i.querySelector(".aipkit_chat_container")||i;r(w,"Chatbot configuration error."),i.classList.remove("aipkit-initializing");return}if(!o){console.error(`AIPKit Chat Init (${a||"Unknown"}): Config object is null after parse attempt.`,i);let l=i.querySelector(".aipkit_chat_container")||i;r(l,"Chatbot config load error."),i.classList.remove("aipkit-initializing");return}if(!o.botId&&a&&(o.botId=a),window.aipkit_current_post_id=o.postId||0,o.enableSidebar)window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"));else{let l=sessionStorage.getItem("aipkit_current_conversation_uuid"),w=sessionStorage.getItem("aipkit_current_openai_response_id");if(l){if(window.aipkit_current_conversation_uuid=l,window.aipkit_is_fresh_session=!1,window.aipkit_current_openai_response_id=w||null,window.aipkit_current_openai_response_id)try{let _=localStorage.getItem(`aipkit_file_context_${l}`);if(_){let c=JSON.parse(_),f=!1;c&&c.provider&&(c.provider==="OpenAI"&&c.vector_store_id||c.provider==="Pinecone"&&c.index_name&&c.namespace||c.provider==="Qdrant"&&c.collection_name&&c.file_upload_context_id||c.provider==="Claude"&&c.file_id)&&(f=!0),f?(window.aipkit_active_file_context_provider=c.provider,window.aipkit_active_file_context_data=c,sessionStorage.setItem("aipkit_active_file_context_provider",window.aipkit_active_file_context_provider),sessionStorage.setItem("aipkit_active_file_context_data",JSON.stringify(window.aipkit_active_file_context_data)),document.dispatchEvent(new CustomEvent("aipkit:fileContextRestored",{detail:c}))):(console.warn(`AIPKit Chat Init (${o.botId}): Invalid file context data in localStorage for conv ${l}. Clearing. Data:`,c),localStorage.removeItem(`aipkit_file_context_${l}`),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")))}else window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}catch(_){console.error("AIPKit Chat Init: Error loading file context from localStorage:",_),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}}else window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}if(typeof aipkit_setupChatInstanceUI!="function"){console.error(`AIPKit Chat Init (${o.botId}): UI setup function (aipkit_setupChatInstanceUI) not found.`);let l=i.querySelector(".aipkit_chat_container")||i;r(l,"Chatbot script error."),i.classList.remove("aipkit-initializing");return}let s=i.classList.contains("aipkit_chat_container")?i:i.querySelector(".aipkit_chat_container");if(!s){console.error(`AIPKit Chat Init (${o.botId}): Chat container element not found within wrapper.`,i),r(i,"Chatbot structure error."),i.classList.remove("aipkit-initializing");return}if(o.guestUUID=window.aipkit_guest_uuid,o.conversationUUID=window.aipkit_current_conversation_uuid,o.previousOpenAIResponseId=window.aipkit_current_openai_response_id,o.activeFileContextProvider=window.aipkit_active_file_context_provider,o.activeFileContextData=window.aipkit_active_file_context_data,!o.botId||!o.ajaxUrl||!o.text||!o.guestUUID){console.error(`AIPKit Chat Init (${o.botId||"Unknown"}): Missing essential configuration.`,o,i);let l=i.querySelector(".aipkit_chat_container")||i;r(l,"Chatbot configuration error."),i.classList.remove("aipkit-initializing");return}if(typeof window.aipkit_chatUI_applyCustomThemeStyles=="function"&&o.theme==="custom"&&o.customThemeSettings&&Object.keys(o.customThemeSettings).length>0){let l={skipDimensionSync:!!o.customThemePresetKey};window.aipkit_chatUI_applyCustomThemeStyles(s,o.customThemeSettings,l)}else o.theme==="custom"&&console.warn(`AIPKit Chat Init (${o.botId}): Custom theme selected but aipkit_chatUI_applyCustomThemeStyles not found or no settings provided.`);let u=aipkit_setupChatInstanceUI(s,o);if(!u||!u.publicApi||!u.internalElements||!u.internalActions){console.error(`AIPKit Chat Init (${o.botId}): Failed to set up UI instance or get all necessary parts.`),i.classList.remove("aipkit-initializing");return}let p=u.publicApi;if(window.aipkitChatInstances||(window.aipkitChatInstances={}),window.aipkitChatInstances[s.id]={instance:p,elements:u.internalElements,actions:u.internalActions},o.popupEnabled){let l=i.querySelector(".aipkit_popup_trigger");if(!l){console.error(`AIPKit Chat Init (${o.botId}): Popup trigger button not found.`),i.classList.remove("aipkit-initializing");return}if(p.setupPopupHandlers){p.setupPopupHandlers(l);let w=o.popupDelay;w>0&&!o.directVoiceMode&&!i.dataset.aipkitAutoOpened&&(i.dataset.aipkitAutoOpened="true",setTimeout(()=>{p&&p.isPopupOpen&&!p.isPopupOpen()&&p.openPopup()},w*1e3))}else console.error(`AIPKit Chat Init (${o.botId}): setupPopupHandlers method missing in UI instance.`)}i.classList.remove("aipkit-initializing"),i.classList.add("aipkit-initialized")}function e(){document.querySelectorAll(".aipkit_chat_container:not(.aipkit-initializing):not(.aipkit-initialized)").forEach(t=>{t.closest(".aipkit_popup_wrapper")||n(t)}),document.querySelectorAll(".aipkit_popup_wrapper:not(.aipkit-initializing):not(.aipkit-initialized)").forEach(n)}if(document.addEventListener("DOMContentLoaded",e),typeof MutationObserver=="function"){let i=new MutationObserver(a=>{let t=!1;a.forEach(o=>{o.addedNodes&&o.addedNodes.forEach(r=>{r.nodeType===1&&(r.matches&&(r.matches(".aipkit_chat_container:not(.aipkit_popup_content)")||r.matches(".aipkit_popup_wrapper")||r.matches('[id^="aipkit-chatbot-container-"]'))||r.querySelector&&r.querySelector(".aipkit_chat_container:not(.aipkit_popup_content), .aipkit_popup_wrapper, [id^='aipkit-chatbot-container-']"))&&(t=!0)})}),t&&(i.scanTimeout&&clearTimeout(i.scanTimeout),i.scanTimeout=setTimeout(e,50))});i.observe(document.body,{childList:!0,subtree:!0,attributes:!0})}else console.warn("AIPKit Chat Init: MutationObserver not supported; dynamically added chatbots might not initialize automatically.");window.aipkit_initializeChatInstance=n})();(function(){"use strict";window.aipkitAIFormsPublicState={currentAIFormEventSource:null,mdInstanceAIForms:null}})();(function(){"use strict";async function d(n,e,i){let a=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:u=>u,t=new FormData;t.append("action","aipkit_cache_sse_message"),t.append("_ajax_nonce",i);let o={stream_context:"ai_forms",form_id:n,user_input_values:e};t.append("message",JSON.stringify(o));let r=await fetch(aipkit_ai_forms_public_config.ajaxUrl,{method:"POST",body:t,credentials:"same-origin"});if(!r.ok){let u=await r.json().catch(()=>({}));throw new Error(u?.data?.message||`HTTP error ${r.status}`)}let s=await r.json();if(s.success&&s.data?.cache_key)return s.data.cache_key;throw new Error(s.data?.message||a("Failed to cache form data for streaming.","gpt3-ai-content-generator"))}window.aipkit_cacheAIFormMessage=d})();(function(){"use strict";function d(n,e){let i=window.aipkitAIFormsPublicState,a=n?n.closest(".aipkit-ai-form-wrapper"):null,t=n?n.querySelector(".aipkit_btn-text"):null,o=n?n.querySelector(".aipkit_spinner"):null,r=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:l=>l,s=null,u=()=>{n&&(n.disabled=!1,n.classList.remove("aipkit_btn-danger"),n.classList.add("aipkit_btn-primary"),t&&(t.textContent=e),s&&(n.removeEventListener("click",s),s=null)),o&&(o.style.display="none")};return{restoreGenerateButton:u,setupStopButton:()=>{n&&(n.disabled=!1,n.classList.remove("aipkit_btn-primary"),n.classList.add("aipkit_btn-danger"),t&&(t.textContent=a.dataset.labelStopButton||r("Stop","gpt3-ai-content-generator")),s=l=>{l.preventDefault(),l.stopPropagation(),i.currentAIFormEventSource&&(i.currentAIFormEventSource.close(),i.currentAIFormEventSource=null),u()},n.addEventListener("click",s,{once:!0}))}}}window.aipkitForms_createSseUiManager=d})();(function(){"use strict";function d(n){let e=n.elements,i=!1,a=null,t={},o={};for(let r of e){if(!r.name)continue;let s=r.name.match(/aipkit_form_field\[(.+?)\](\[\])?$/);if(!s||!s[1])continue;let u=s[1];s[2]==="[]"?(t[u]||(t[u]=[]),r.checked&&t[u].push(r.value)):r.type==="radio"?r.checked&&(t[u]=r.value):t[u]=r.value}for(let r of e){let s=r.closest("fieldset");if(s){let _=s.querySelector("legend");_&&(_.style.color="")}else r.style.borderColor="";if(!(r.required||r.dataset&&r.dataset.isRequired==="true"))continue;let p=!1,l=r.name.match(/aipkit_form_field\[(.+?)\](\[\])?$/);if(!l||!l[1])continue;let w=l[1];if(!o[w]&&(r.type==="checkbox"?(p=!t[w]||t[w].length===0,o[w]=!0):r.type==="radio"?(p=!t[w],o[w]=!0):(r.classList.contains("aipkit-file-hidden-content")||r.type!=="file"&&r.type!=="submit"&&r.type!=="button")&&(p=r.value.trim()===""),p)){i=!0;let _=r;if(r.type==="radio"||r.type==="checkbox"?_=r.closest("fieldset"):r.classList.contains("aipkit-file-hidden-content")&&(_=n.querySelector(`.aipkit-file-upload-input[data-field-id="${w}"]`)),a||(a=_),_?.type!=="checkbox"&&_?.type!=="radio"&&_)_.style.borderColor="red";else if(_){let c=_.querySelector("legend");c&&(c.style.color="red")}}}return{isValid:!i,userInputs:t,firstInvalidField:a}}window.aipkitForms_validateSseInputs=d})();(function(){"use strict";let d=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:e=>e;function n(e,i){let a=window.aipkitAIFormsPublicState,t="",o=!0,r='<div class="aipkit-ai-form-results-top-actions"></div>',s='<div class="aipkit-ai-form-results-footer-actions"></div>',u=_=>`<div class="aipkit-ai-form-results-content">${_}</div>`;return{onMessageHandler:_=>{o&&(e.style.display="block",e.innerHTML=r+u("")+s,o=!1);let c=JSON.parse(_.data),f=e.querySelector(".aipkit-ai-form-results-content");c.delta&&f&&(t+=c.delta,a.mdInstanceAIForms?f.innerHTML=a.mdInstanceAIForms.render(t):f.innerHTML=t.replace(/\n/g,"<br />"),e.scrollTop=e.scrollHeight)},onDoneHandler:_=>{a.currentAIFormEventSource&&(a.currentAIFormEventSource.close(),a.currentAIFormEventSource=null),i();let c=e.querySelector(".aipkit-ai-form-results-content");a.mdInstanceAIForms&&c?c.innerHTML=a.mdInstanceAIForms.render(t):c&&(c.innerHTML=t.replace(/\n/g,"<br />"));let f=e.querySelector(".aipkit-ai-form-results-top-actions"),g=e.querySelector(".aipkit-ai-form-results-footer-actions");if(t.trim()!==""&&f&&g){let m=e.closest(".aipkit-ai-form-wrapper"),h=m.dataset.showSaveButton==="true",b=m.dataset.pdfDownloadEnabled==="true",I=m.dataset.showCopyButton==="true",y=window.aipkit_ai_forms_public_config||{},v=y.is_user_logged_in,U=document.createElement("button");if(U.type="button",U.className="aipkit-copy-results-btn",U.title=d("Copy Results","gpt3-ai-content-generator"),U.innerHTML='<span class="dashicons dashicons-admin-page"></span>',typeof window.aipkitForms_handleCopyAction=="function"&&U.addEventListener("click",window.aipkitForms_handleCopyAction),f.appendChild(U),U.style.display="inline-flex",h&&v){let x=m.dataset.labelSaveButton||y.text?.saveAsPost||d("Save","gpt3-ai-content-generator"),M=document.createElement("button");M.type="button",M.className="aipkit_btn aipkit_btn-secondary aipkit-save-as-post-btn",M.innerHTML=`<span class="aipkit_btn-text">${x}</span><span class="aipkit_spinner" style="display:none;"></span>`,typeof window.aipkitForms_handleSaveAsPost=="function"&&M.addEventListener("click",window.aipkitForms_handleSaveAsPost),g.appendChild(M),M.style.display="inline-flex"}if(b&&typeof window.aipkitForms_handleDownloadPdf=="function"){let x=m.dataset.labelDownloadButton||d("Download","gpt3-ai-content-generator"),M=document.createElement("button");M.type="button",M.className="aipkit_btn aipkit_btn-secondary aipkit-download-pdf-btn",M.innerHTML=`<span class="aipkit_btn-text">${x}</span>`,M.addEventListener("click",window.aipkitForms_handleDownloadPdf),g.appendChild(M),M.style.display="inline-flex"}if(I){let x=m.dataset.labelCopyButton||d("Copy","gpt3-ai-content-generator"),M=document.createElement("button");M.type="button",M.className="aipkit_btn aipkit_btn-secondary aipkit-copy-results-footer-btn",M.innerHTML=`<span class="aipkit_btn-text">${x}</span>`,typeof window.aipkitForms_handleCopyAction=="function"&&M.addEventListener("click",window.aipkitForms_handleCopyAction),g.appendChild(M),M.style.display="inline-flex"}}},onErrorHandler:_=>{if(a.currentAIFormEventSource===null)return;console.error("AI Form SSE Error:",_);let c=d(aipkit_ai_forms_public_config.text.error||"An error occurred.","gpt3-ai-content-generator");if(_.data)try{let g=JSON.parse(_.data);g.error&&(c=g.error)}catch{}if(e.style.display="block",t.trim()!==""){let g=e.querySelector(".aipkit-ai-form-error");if(!g){g=document.createElement("div"),g.className="aipkit-ai-form-error";let m=e.querySelector(".aipkit-ai-form-results-footer-actions");m&&m.parentNode?m.parentNode.insertBefore(g,m.nextSibling):e.appendChild(g)}g.textContent=c}else e.innerHTML=`<p style="color:red;">${c}</p>`;a.currentAIFormEventSource&&(a.currentAIFormEventSource.close(),a.currentAIFormEventSource=null),i()}}}window.aipkitForms_createSseEventHandlers=n})();(function(){"use strict";async function d(n,e,i,a,t){let o=window.aipkitAIFormsPublicState,r=await window.aipkit_cacheAIFormMessage(n,e,i),s=new URL(aipkit_ai_forms_public_config.ajaxUrl);s.searchParams.append("action","aipkit_frontend_chat_stream"),s.searchParams.append("cache_key",r),s.searchParams.append("_ajax_nonce",i),window.aipkit_guest_uuid&&s.searchParams.append("session_id",window.aipkit_guest_uuid),o.currentAIFormEventSource=new EventSource(s.toString());let{onMessageHandler:u,onDoneHandler:p,onErrorHandler:l}=window.aipkitForms_createSseEventHandlers(a,t);o.currentAIFormEventSource.onmessage=u,o.currentAIFormEventSource.addEventListener("done",p),o.currentAIFormEventSource.onerror=l}window.aipkitForms_setupAndStartEventSource=d})();(function(){"use strict";function d(i,a,t="info"){if(!i)return;let o=window.aipkit_escapeHtml||function(r){return r};i.innerHTML=o(a),i.className=`aipkit-file-upload-status aipkit-status-${t}`}function n(i){if(!i)return;let a=i.querySelector(".aipkit-file-upload-input"),t=i.querySelector(".aipkit-file-upload-status"),o=i.querySelector(".aipkit-file-remove-btn"),r=i.querySelector(".aipkit-file-hidden-content"),s=i.querySelector(".aipkit-file-status-wrapper");a&&(a.value="",a.style.display="block"),t&&(t.innerHTML="",t.className="aipkit-file-upload-status"),o&&(o.style.display="none"),s&&(s.style.display="none"),r&&(r.value="",r.dispatchEvent(new Event("change",{bubbles:!0})))}async function e(i){let a=i.target,t=a.closest(".aipkit_form_group-file-upload");if(!t)return;let o=a.files[0],r=t.querySelector(".aipkit-file-status-wrapper"),s=t.querySelector(".aipkit-file-upload-status"),u=t.querySelector(".aipkit-file-remove-btn"),p=t.querySelector(".aipkit-file-hidden-content"),l=a.closest("form").querySelector('button[type="submit"]'),w=t.dataset.nonce,_=window.aipkit_ai_forms_public_config.ajaxUrl,c=window.wp?.i18n?.__||(h=>h),f=window.aipkit_escapeHtml||function(h){return h};if(!o){n(t);return}if(!["text/plain","application/pdf"].includes(o.type)){d(s,c("Invalid file type. Please use .txt or .pdf.","gpt3-ai-content-generator"),"error"),n(t);return}if(o.size>20*1024*1024){d(s,c("File is too large (max 20MB).","gpt3-ai-content-generator"),"error"),n(t);return}d(s,c("Uploading & processing...","gpt3-ai-content-generator"),"info"),r&&(r.style.display="flex"),l&&(l.disabled=!0);let m=new FormData;m.append("action","aipkit_ai_form_upload_and_parse_file"),m.append("_ajax_nonce",w),m.append("file",o);try{let h=await fetch(_,{method:"POST",body:m,credentials:"same-origin"}),b=await h.json();if(!h.ok||!b.success)throw new Error(b.data?.message||c("Failed to process file.","gpt3-ai-content-generator"));if(typeof b.data.text=="string")p.value=b.data.text,p.dispatchEvent(new Event("change",{bubbles:!0})),d(s,`\u2705 ${f(o.name)}`,"success"),a.style.display="none",u&&(u.style.display="inline-flex"),r&&(r.style.display="flex"),l&&(l.disabled=!1);else throw new Error(c("No text content was extracted from the file.","gpt3-ai-content-generator"))}catch(h){d(s,h.message,"error"),n(t),l&&(l.disabled=!1)}}window.aipkitForms_handleFileUpload=e,window.aipkitForms_resetFileUploadUI=n})();(function(){"use strict";function d(i){let a=i.innerHTML;i.innerHTML='<span class="dashicons dashicons-yes-alt aipkit-copy-success-icon"></span>',i.disabled=!0,setTimeout(()=>{i.innerHTML=a,i.disabled=!1},1500)}function n(i){let a=i.currentTarget,t=a.closest(".aipkit-ai-form-results");if(!t)return;let o=t.cloneNode(!0),r=o.querySelector(".aipkit-copy-results-btn");r&&r.remove();let s=o.innerText||o.textContent;navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(s).then(()=>{d(a)}).catch(u=>{console.error("Failed to copy text using Clipboard API: ",u),e(s,a)}):e(s,a)}function e(i,a){let t=document.createElement("textarea");t.value=i,t.style.position="fixed",t.style.top="-9999px",t.style.left="-9999px",document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy"),d(a)}catch(o){console.error("Fallback copy failed: ",o),alert("Failed to copy content.")}document.body.removeChild(t)}window.aipkitForms_handleCopyAction=n})();(function(){"use strict";async function d(n){let e=n.currentTarget,i=e.closest(".aipkit-ai-form-wrapper");if(!i)return;let a=i.querySelector(".aipkit-ai-form-results"),t=i.querySelector("h5.aipkit-ai-form-title"),o=i.dataset.saveAsPostNonce,r=a?a.querySelector(".aipkit-ai-form-results-content"):null;if(!r||!t){console.error("AI Forms Save: Missing results content container or title element.");return}let s=window.aipkit_ai_forms_public_config||{},u=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:c=>c,p=t.textContent.trim(),l=r.innerHTML,w=e.innerHTML;e.disabled=!0,e.innerHTML='<span class="aipkit_spinner" style="display:inline-block;"></span>';let _={action:"aipkit_ai_form_save_as_post",_ajax_nonce:o,post_title:p,post_content:l};try{let c=new FormData;for(let h in _)c.append(h,_[h]);let f=await fetch(s.ajaxUrl,{method:"POST",body:c,credentials:"same-origin"}),g=await f.json();if(!f.ok||!g.success)throw new Error(g.data?.message||u("Failed to save post.","gpt3-ai-content-generator"));e.innerHTML='<span class="dashicons dashicons-yes-alt" style="color: #38a569;"></span>',e.disabled=!0;let m=null;g.data.edit_link&&(m=document.createElement("a"),m.href=g.data.edit_link,m.innerHTML='<span class="dashicons dashicons-external"></span>',m.title=u("Edit Post","gpt3-ai-content-generator"),m.target="_blank",m.rel="noopener noreferrer",m.classList.add("aipkit_btn","aipkit_btn-icon","aipkit_btn-small","aipkit_btn-secondary"),m.style.marginLeft="10px",e.parentNode.insertBefore(m,e.nextSibling)),setTimeout(()=>{e.innerHTML=w,e.disabled=!1,m&&m.parentNode&&m.remove()},5e3)}catch(c){console.error("Failed to save post:",c),alert(`${u("Error saving post:","gpt3-ai-content-generator")} ${c.message}`),e.innerHTML=w,e.disabled=!1}}window.aipkitForms_handleSaveAsPost=d})();(function(){"use strict";async function d(n){n.preventDefault(),n.stopPropagation();let e=window.aipkitAIFormsPublicState,i=n.target,a=i.closest(".aipkit-ai-form-wrapper");if(!a)return;let t=a.dataset.formId,o=aipkit_ai_forms_public_config.ajaxNonce,r=a.querySelector(".aipkit-ai-form-results"),s=i.querySelector('button[type="submit"]'),u=s?s.querySelector(".aipkit_spinner"):null,p=s?s.querySelector(".aipkit_btn-text"):null,l=a.dataset.labelGenerateButton||"Generate",w=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:g=>g;if(!t||!o||!r||!s){console.error("AI Form SSE: Missing essential elements (formId, nonce, resultsDiv, submitButton)."),r&&(r.innerHTML='<p style="color:red;">Configuration error.</p>');return}let{restoreGenerateButton:_,setupStopButton:c}=window.aipkitForms_createSseUiManager(s,l);e.currentAIFormEventSource&&(e.currentAIFormEventSource.close(),e.currentAIFormEventSource=null),r.innerHTML="",r.style.display="none",s&&(s.disabled=!0),u&&(u.style.display="inline-block");let f=window.aipkitForms_validateSseInputs(i);if(!f.isValid){if(f.firstInvalidField)if(f.firstInvalidField.type!=="checkbox")f.firstInvalidField.style.borderColor="red";else{let g=f.firstInvalidField.closest(".aipkit_form-group")?.querySelector("label");g&&(g.style.color="red")}r.style.display="block",r.innerHTML=`<p style="color:orange;">${w("Please fill in all required fields.","gpt3-ai-content-generator")}</p>`,s&&(s.disabled=!1),u&&(u.style.display="none");return}c();try{await window.aipkitForms_setupAndStartEventSource(t,f.userInputs,o,r,_)}catch(g){console.error("AI Form Submission Error (SSE Setup):",g),r.innerHTML=`<p style="color:red;">${g.message||w(aipkit_ai_forms_public_config.text.error||"An error occurred.","gpt3-ai-content-generator")}</p>`,_()}}window.aipkit_handleFormSubmitSSE=d})();(function(){"use strict";function d(i,a){let t=window.aipkit_ai_forms_models||{},o=window.aipkit_ai_forms_public_config||{},r=i.toLowerCase(),s=t[r]||[],u=a.dataset.currentValue||"";if(o.allowed_models&&o.allowed_models.trim()!==""){let l=new Set(o.allowed_models.split(",").map(w=>w.trim()));if(Array.isArray(s))s=s.filter(w=>l.has(w.id));else{let w={};for(let _ in s){let c=s[_].filter(f=>l.has(f.id));c.length>0&&(w[_]=c)}s=w}}if(a.innerHTML="",!s||Array.isArray(s)&&s.length===0||!Array.isArray(s)&&Object.keys(s).length===0){let l=new Option("No models available for this provider.","");a.appendChild(l);return}let p=!1;if(Array.isArray(s))s.forEach(l=>{let w=new Option(l.name,l.id);l.id===u&&(w.selected=!0,p=!0),a.appendChild(w)});else{let l=["o1 models","o3 models","o4 models","gpt-3.5 models","gpt-4 models","gpt-5 models","fine-tuned models","others"],w=Object.keys(s);l.filter(c=>w.includes(c)).concat(w.filter(c=>!l.includes(c)).sort()).forEach(c=>{let f=document.createElement("optgroup");f.label=c,s[c].forEach(g=>{let m=new Option(g.name,g.id);g.id===u&&(m.selected=!0,p=!0),f.appendChild(m)}),a.appendChild(f)})}if(!p&&u){let l=new Option(`${u} (Manual)`,u,!1,!0);a.insertBefore(l,a.firstChild)}if(a.selectedIndex===-1&&a.options.length>0){let l=a.querySelector("optgroup");l&&l.options.length>0?a.value=l.options[0].value:a.options[0].value&&(a.selectedIndex=0)}}function n(i){let a=i.querySelector(".aipkit_aiform_provider_select"),t=i.querySelector(".aipkit_aiform_model_select");if(t)if(a)d(a.value,t),a.addEventListener("change",function(){d(this.value,t)});else{let o=t.dataset.provider;o?d(o,t):console.warn("AI Forms: Model select is present, but no provider information was found (missing data-provider attribute).")}}function e(){let i=window.aipkitAIFormsPublicState;if(typeof window.aipkit_handleFormSubmitSSE!="function"){console.error("AIPKit AI Forms Init: handleFormSubmitSSE is not defined.");return}document.querySelectorAll(".aipkit-ai-form-wrapper").forEach(t=>{n(t);let o=t.querySelector("form.aipkit-ai-form-main");o&&!o.dataset.sseInitialized&&(o.addEventListener("submit",window.aipkit_handleFormSubmitSSE),o.dataset.sseInitialized="true"),o&&!o.dataset.fileUploadInitialized&&(o.addEventListener("change",r=>{r.target.matches(".aipkit-file-upload-input")&&typeof window.aipkitForms_handleFileUpload=="function"&&window.aipkitForms_handleFileUpload(r)}),o.addEventListener("click",r=>{if(r.target.matches(".aipkit-file-remove-btn, .aipkit-file-remove-btn *")){let s=r.target.closest(".aipkit_form_group-file-upload");s&&typeof window.aipkitForms_resetFileUploadUI=="function"&&window.aipkitForms_resetFileUploadUI(s)}}),o.dataset.fileUploadInitialized="true")}),typeof window.markdownit=="function"?i.mdInstanceAIForms=window.markdownit({html:!1,xhtmlOut:!1,breaks:!0,linkify:!0,typographer:!0,quotes:"\u201C\u201D\u2018\u2019"}):(console.warn("AI Forms Public: markdown-it library not found."),i.mdInstanceAIForms={render:function(t){return(window.aipkit_escapeHtml||function(r){return r})(t).replace(/\n/g,"<br />")}})}window.aipkit_initAIFormsPublic=e})();(function(){"use strict";document.readyState==="loading"?document.addEventListener("DOMContentLoaded",window.aipkit_initAIFormsPublic):window.aipkit_initAIFormsPublic()})();(function(){"use strict";function d(n,e,i){let a=n.querySelector(`#${e}`);if(a&&a.offsetParent!==null)return a.value;{let t=n.querySelector(`input[type="hidden"][name="${i}"]`);return t?t.value:null}}window.aipkit_getSettingValue=d})();(function(){"use strict";let d={image_input:!0,image_output:!0,image_generation:!0};function n(o){if(!o||typeof o!="object")return!1;let r=o.capabilities;if(!r||typeof r!="object")return!0;let s={...d,...r};return!!(s.image_output||s.image_generation)}function e(o){if(!o||typeof o!="object")return!1;let r=o.capabilities;if(!r||typeof r!="object")return!0;let s={...d,...r};return!!(s.image_input&&(s.image_output||s.image_generation))}function i(o){if(!o||typeof o!="object")return!1;let r=String(o.id||"").trim().toLowerCase();return r?!r.includes("veo")&&r.includes("gemini")&&r.includes("image-generation"):!1}function a(o){if(!o||typeof o!="object")return!1;let r=String(o.id||"").trim().toLowerCase();return r==="gpt-image-1.5"||r==="gpt-image-1"||r==="gpt-image-1-mini"}function t(o,r,s,u={}){if(!r)return;let p=String(r.value||"").trim().toLowerCase(),l=String(u?.preferredModel||"").trim().toLowerCase(),_=(String(u?.mode||"generate").trim().toLowerCase()==="edit"?"edit":"generate")==="edit";r.innerHTML="";let c=[],f=window.aipkit_image_generator_config_public||{},g=f.text||{},m=o.toLowerCase(),h=s?new Set(s.split(",").map(I=>I.trim().toLowerCase())):null;if(m==="openai"&&f.openai_models?c=f.openai_models||[]:m==="openrouter"&&f.openrouter_image_models?c=(f.openrouter_image_models||[]).filter(I=>n(I)):m==="google"&&f.google_models?c=f.google_models||{}:m==="azure"&&f.azure_models?c=f.azure_models||[]:m==="replicate"&&f.replicate_models&&(c=f.replicate_models||[]),_&&(m==="google"&&c&&typeof c=="object"?c={image:(Array.isArray(c.image)?c.image:[]).filter(y=>i(y)),video:[]}:m==="openai"&&Array.isArray(c)?c=c.filter(I=>a(I)):m==="openrouter"&&Array.isArray(c)?c=c.filter(I=>e(I)):c=[]),h&&!h.has(m))if(c.image||c.video){let I={};c.image&&Array.isArray(c.image)&&(I.image=c.image.filter(y=>h.has(y.id))),c.video&&Array.isArray(c.video)&&(I.video=c.video.filter(y=>h.has(y.id))),c=I}else Array.isArray(c)&&(c=c.filter(I=>h.has(I.id)));else h&&h.has(m);if(c.image&&c.image.length>0||c.video&&c.video.length>0||Array.isArray(c)&&c.length>0){if(m==="openai")c.sort((y,v)=>{let U={"gpt-image-1.5":1,"gpt-image-1":2,"gpt-image-1-mini":3,"dall-e-3":4,"dall-e-2":5};return(U[y.id]||99)-(U[v.id]||99)}),c.forEach(y=>{r.appendChild(new Option(y.name,y.id))});else if(m==="openrouter")c.sort((y,v)=>(y.name||y.id||"").localeCompare(v.name||v.id||"")),c.forEach(y=>{let v=new Option(y.name||y.id,y.id);y.capabilities&&typeof y.capabilities=="object"&&(v.dataset.capabilities=JSON.stringify(y.capabilities)),r.appendChild(v)});else if(m==="azure")c.forEach(y=>{let v=y.name||y.id;r.appendChild(new Option(v,y.id))});else if(m==="google"){if(c.image&&c.image.length>0){let y=document.createElement("optgroup");y.label=g.imageModelsGroup||"Image Models",c.image.sort((v,U)=>{let x=(v.name||v.id||"").toString().toLowerCase(),M=(U.name||U.id||"").toString().toLowerCase();return x.localeCompare(M)}),c.image.forEach(v=>{y.appendChild(new Option(v.name,v.id))}),r.appendChild(y)}if(c.video&&c.video.length>0){let y=document.createElement("optgroup");y.label=g.videoModelsGroup||"Video Models",c.video.forEach(v=>{y.appendChild(new Option(v.name,v.id))}),r.appendChild(y)}}else if(m==="replicate"){let y={};c.forEach(U=>{if(U&&U.name){let x=U.name.split("/"),M=x.length>1?x[0]:"other";y[M]||(y[M]=[]),y[M].push(U)}}),Object.keys(y).sort().forEach(U=>{let x=document.createElement("optgroup");x.label=U,y[U].sort((M,F)=>(M.name||"").localeCompare(F.name||"")),y[U].forEach(M=>{let F=M.name.replace(U+"/",""),k=new Option(F,M.id);x.appendChild(k)}),r.appendChild(x)})}r.disabled=!1;let I=l||p;if(I){let y=Array.from(r.options).find(v=>String(v.value||"").trim().toLowerCase()===I);y&&(r.value=y.value)}r.selectedIndex===-1&&(r.selectedIndex=0)}else{let I=_?g.noEditCapableModels||"(No edit-capable models available)":m==="openrouter"?g.noOpenRouterImageModels||"(No image-capable OpenRouter models found)":g.noModelsAvailable||"(No models available)";r.appendChild(new Option(I,"")),r.disabled=!0}}window.aipkit_populatePublicModelsForProvider=t})();(function(){"use strict";function d(n){let e=n.target.closest(".aipkit-image-history-delete-btn");if(!e)return;n.preventDefault(),n.stopPropagation();let i=e.dataset.attachmentId;if(!i)return;let a=window.aipkit_image_generator_config_public||{},t=a.text||{},o=a.ajaxUrl||window.aipkit_dashboard?.ajaxurl,r=document.getElementById("aipkit_image_generator_public_nonce")?.value;if(!o||!r){alert(t.deleteConfigMissing||"Error: Cannot delete image. Configuration missing.");return}let s=e.innerHTML;e.innerHTML='<span class="aipkit_spinner" style="display:inline-block;"></span>',e.disabled=!0;let u=new FormData;u.append("action","aipkit_delete_generated_image"),u.append("_ajax_nonce",r),u.append("attachment_id",i),fetch(o,{method:"POST",body:u,credentials:"same-origin"}).then(p=>p.json()).then(p=>{if(!p.success)throw new Error(p.data?.message||"Deletion failed.");let l=e.closest(".aipkit-image-history-item");l&&(l.style.transition="opacity 0.3s",l.style.opacity="0",setTimeout(()=>{l.remove();let w=l.closest(".aipkit_image_history_section"),_=w?w.querySelector(".aipkit-image-history-grid"):null;if(_&&w&&_.children.length===0){let c=w.querySelector(".aipkit-image-history-load-more-btn"),f=!1;if(c){let g=parseInt(c.dataset.currentPage,10)||1,m=parseInt(c.dataset.maxPages,10)||1;f=!(c.style.display==="none")&&g<m}f||w.remove()}},300))}).catch(p=>{alert(`${t.deleteImageErrorPrefix||"Error deleting image:"} ${p.message}`),e.innerHTML=s,e.disabled=!1})}window.aipkit_handleDeleteImage=d})();(function(){"use strict";let d=["image/jpeg","image/png","image/webp","image/gif"],e={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",webp:"image/webp",gif:"image/gif"},i={"image/jpeg":"jpg","image/png":"png","image/webp":"webp","image/gif":"gif"};function a(c){let f=Array.isArray(c?.edit_upload_allowed_mime_types)?c.edit_upload_allowed_mime_types.map(m=>String(m||"").trim().toLowerCase()).filter(Boolean):d,g=Number(c?.edit_upload_max_bytes||0);return{allowedMimeTypes:new Set(f),maxBytes:Number.isFinite(g)&&g>0?g:10485760}}function t(){return window.aipkit_escapeHtml||function(c){return String(c||"")}}function o(c,f,g="info"){if(!c)return;let m=t(),h=String(f||"").trim();if(!h)return;let b=g==="error"?"error":"info";c.innerHTML=`<p class="aipkit_image_results_message aipkit_message-${b}">${m(h)}</p>`,c.style.display="grid"}function r(c,f){let g=String(c||"").trim().toLowerCase();if(g&&Object.values(e).includes(g))return g;let m=String(f||"").trim().toLowerCase(),h=m.includes(".")?m.split(".").pop():"";return e[h]||""}function s(c,f){let g=String(c||"").trim().replace(/[^\w.\-]+/g,"-").replace(/-+/g,"-").replace(/^\.+/,"").replace(/^\-+/,"");return g?/\.[a-z0-9]+$/i.test(g)?g:`${g}.${i[f]||"png"}`:`aipkit-source-image.${i[f]||"png"}`}function u(c,f){if(!c)return;let g=c.querySelector(".dashicons"),m=c.querySelector(".aipkit_spinner");g&&(g.hidden=!!f),m&&(m.hidden=!f,m.classList.toggle("aipkit_spinner--visible",!!f)),c.disabled=!!f}function p(c,f){let g=c.querySelector("#aipkit_public_image_mode");if(String(g?.value||"").trim().toLowerCase()==="edit")return!0;let h=c.querySelector('.aipkit_image_generator_mode_btn[data-aipkit-image-mode="edit"]');if(h)return h.disabled?!1:(h.click(),String(g?.value||"").trim().toLowerCase()==="edit");if(String(c.dataset.imageMode||"generate").trim().toLowerCase()==="generate")return!1;g&&(g.value="edit");let I=c.querySelector("#aipkit_public_image_edit_upload_row");return I&&(I.hidden=!1),!0}async function l(c,f,g,m){let h=await fetch(c,{method:"GET",credentials:"same-origin"});if(!h.ok)throw new Error(m.editHistoryLoadFailed||"Could not load the selected image for editing.");let b=await h.blob(),I=r(b.type,f||c);if(!I||!g.allowedMimeTypes.has(I))throw new Error(m.editInvalidFileType||"Invalid image type. Allowed types: JPG, PNG, WEBP, GIF.");if(Number(b.size||0)>g.maxBytes)throw new Error(m.editFileTooLarge||"Source image is too large. Maximum allowed size is 10MB.");let y=s(f,I);return new File([b],y,{type:I})}function w(c,f,g){if(!c||!f)return!1;if(typeof DataTransfer>"u")throw new Error(g.editDropUsePicker||"Could not attach selected image automatically. Click to choose file.");let m=new DataTransfer;return m.items.add(f),c.files=m.files,c.dispatchEvent(new Event("change",{bubbles:!0})),!0}async function _(c){let f=c.target.closest(".aipkit-image-history-edit-btn");if(!f)return;c.preventDefault(),c.stopPropagation();let g=f.closest("#aipkit_public_image_generator");if(!g)return;let m=window.aipkit_image_generator_config_public||{},h=m.text||{},b=g.querySelector("#aipkit_public_image_results"),I=g.querySelector("#aipkit_public_image_edit_source_file"),y=g.querySelector("#aipkit_public_image_prompt"),v=g.querySelector("#aipkit_public_image_edit_upload_row"),U=String(f.dataset.imageUrl||"").trim(),x=String(f.dataset.imageName||"").trim();if(!U||!I){o(b,h.editHistoryLoadFailed||"Could not load the selected image for editing.","error");return}if(!p(g,h)){o(b,h.editHistoryUnavailable||"Image editing is not available in the current setup.","error");return}u(f,!0);try{let M=a(m),F=await l(U,x,M,h);w(I,F,h),v&&v.hidden&&(v.hidden=!1),v&&typeof v.scrollIntoView=="function"&&v.scrollIntoView({behavior:"smooth",block:"center"}),y&&typeof y.focus=="function"&&y.focus(),o(b,h.editHistoryLoaded||"Source image loaded. Describe your edits and click Edit Image.","info")}catch(M){console.error("AIPKit Image History Edit Error:",M),o(b,M?.message||h.error||"Error loading image for editing.","error")}finally{u(f,!1)}}window.aipkit_handleEditHistoryImage=_})();(function(){"use strict";let d={image_input:!0,image_output:!0,image_generation:!0},n=["image/jpeg","image/png","image/webp","image/gif"],e=10*1024*1024,i=new Set(["gpt-image-1.5","gpt-image-1","gpt-image-1-mini"]);function a(c,f){let g=Array.isArray(c?.openrouter_image_models)?c.openrouter_image_models:[],m=String(f||"").trim().toLowerCase();if(!m)return d;let h=g.find(b=>(b&&b.id?String(b.id).trim().toLowerCase():"")===m);return!h||typeof h.capabilities!="object"?d:{...d,...h.capabilities}}function t(c,f){let g=a(c,f);return!!(g.image_output||g.image_generation)}function o(c,f){let g=a(c,f);return!!(g.image_input&&(g.image_output||g.image_generation))}function r(c){let f=Array.isArray(c?.edit_upload_allowed_mime_types)?c.edit_upload_allowed_mime_types.map(m=>String(m||"").trim().toLowerCase()).filter(Boolean):n,g=Number(c?.edit_upload_max_bytes||0);return{allowedMimeTypes:new Set(f),maxBytes:Number.isFinite(g)&&g>0?g:e}}function s(c){let f=String(c||"").trim().toLowerCase();return i.has(f)}function u(c,f){c&&(c.hidden=!f)}function p(c,f="",g=!1){if(!c)return;let m=g?" aipkit_image_results_placeholder--with-message":"",h=f?` ${f}`:"";c.innerHTML=`<p class="aipkit_image_results_placeholder aipkit_image_results_placeholder--centered${m}"><span class="aipkit_spinner aipkit_spinner--visible"></span>${h}</p>`}function l(){let c=document.getElementById("aipkit_public_image_generator");if(!c)return;let f=c.querySelector("#aipkit_public_image_prompt"),g=c.querySelector("#aipkit_public_image_results"),m=c.querySelector("#aipkit_public_generate_image_btn"),h=c.querySelector("#aipkit_image_generator_public_nonce"),b=window.aipkit_image_generator_config_public||{},I=b.text||{},y=b.ajaxUrl||window.aipkit_dashboard?.ajaxurl,v=h?h.value:null,U=window.aipkit_escapeHtml||function(B){return B};if(!f||!g||!m||!y||!v){console.error("AIPKit Image Gen (Public): Missing required elements or config for AJAX."),g.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${I.configurationMissing||"Error: Configuration missing."}</p>`,g.style.display="grid";return}let x=window.aipkit_getSettingValue(c,"aipkit_public_image_provider","image_provider"),M=window.aipkit_getSettingValue(c,"aipkit_public_image_model","image_model"),F=window.aipkit_getSettingValue(c,"aipkit_public_image_mode","image_mode")==="edit"?"edit":"generate",k=c.querySelector("#aipkit_public_image_edit_source_file"),S=F==="edit",A=f.value.trim(),C=String(x||"").trim().toLowerCase(),E=String(M||"").trim().toLowerCase(),T=!1,q=b.google_models&&typeof b.google_models=="object"?b.google_models:{};if(C==="google"&&q.video&&Array.isArray(q.video)?T=q.video.some(B=>B&&String(B.id||"").trim().toLowerCase()===E):T=E.includes("veo"),!A){g.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${U(I.noPrompt||"Please enter a prompt.")}</p>`,g.style.display="grid";return}if(S){let B=!!(k&&k.files&&k.files.length),R=c.dataset.editUploadRequired||I.editUploadRequired||"Please upload an image to edit.";if(!B){g.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${U(R)}</p>`,g.style.display="grid";return}let $=k.files[0],K=r(b);if(!K.allowedMimeTypes.has(String($.type||"").toLowerCase())){g.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${U(I.editInvalidFileType||"Invalid image type. Allowed types: JPG, PNG, WEBP, GIF.")}</p>`,g.style.display="grid";return}if(Number($.size||0)>K.maxBytes){g.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${U(I.editFileTooLarge||"Source image is too large. Maximum allowed size is 10MB.")}</p>`,g.style.display="grid";return}}if(!x||!M){console.error("AIPKit Image Gen (Public): Missing required settings values (provider or model).",{provider:x,model:M}),g.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${I.missingRequiredSettings||"Error: Missing required image generation settings."}</p>`,g.style.display="grid";return}if(!S&&C==="openrouter"&&!t(b,E)){g.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${U(I.openrouterModelUnsupported||"Selected OpenRouter model does not support image generation.")}</p>`,g.style.display="grid";return}if(S&&C!=="google"&&C!=="openai"&&C!=="openrouter"){g.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${U(I.editProviderUnsupported||"Image editing is currently supported only for Google, OpenAI and OpenRouter providers.")}</p>`,g.style.display="grid";return}if(S&&(C==="google"&&T||C==="openai"&&!s(E)||C==="openrouter"&&!o(b,E))){g.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${U(I.editModelUnsupported||"Selected model does not support image editing.")}</p>`,g.style.display="grid";return}m.disabled=!0;let L=m.querySelector(".aipkit_btn-text"),H=m.querySelector(".aipkit_spinner"),O=L?L.textContent:I.generateButton||(T?"Generate Video":"Generate Image");L&&(S?L.textContent=I.editing||"Editing...":L.textContent=I.generating||(T?I.generatingVideo||"Generating Video...":"Generating...")),u(H,!0),g.style.display="grid",p(g);let D=new FormData;if(D.append("action","aipkit_generate_image"),D.append("_ajax_nonce",v),D.append("prompt",A),D.append("image_mode",F),D.append("provider",x),D.append("model",M),S&&k&&k.files&&k.files[0]&&D.append("source_image",k.files[0]),C==="openai"){let B=E.startsWith("gpt-image-1");E==="dall-e-3"?(D.append("quality","standard"),D.append("style","vivid")):B&&D.append("output_format","png"),B||D.append("response_format","url")}else C==="google"&&T&&(D.append("aspect_ratio","16:9"),D.append("person_generation","allow_all"));fetch(y,{method:"POST",body:D,credentials:"same-origin"}).then(B=>B.json()).then(B=>{if(!B.success){let R=B.data&&B.data.message?B.data.message:"Unknown generation error";throw new Error(R)}if(B.data.status==="processing"&&B.data.operation_name){w(B.data.operation_name,M,v,m,g,L,H,O,T,A,I,U);return}_(B.data,m,g,L,H,O,T,A,I,U)}).catch(B=>{console.error("AIPKit Image Generation Error (Public):",B),g.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${I.error||"Error generating image:"} ${U(B.message||"Unknown error")}</p>`,m.disabled=!1,L&&(L.textContent=O),u(H,!1)})}function w(c,f,g,m,h,b,I,y,v,U,x,M){let S=0;b&&(b.textContent=x.generatingVideo||"Generating Video..."),p(h,x.videoGenerationInProgress||"Video generation in progress...",!0);function A(){if(S>=60){h.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${x.videoGenerationTimedOut||"Video generation timed out. Please try again."}</p>`,m.disabled=!1,b&&(b.textContent=y),u(I,!1);return}S++;let C=Math.min(S/60*100,95);p(h,`${x.generatingVideoProgress||"Generating video..."} (${Math.round(C)}%)`,!0);let E=new FormData;E.append("action","aipkit_check_video_status"),E.append("_ajax_nonce",g),E.append("operation_name",c),E.append("model_id",f),E.append("prompt",U),fetch(window.aipkit_image_generator_config_public.ajaxUrl,{method:"POST",body:E,credentials:"same-origin"}).then(T=>T.json()).then(T=>{if(T.success)if(T.data.status==="completed")_(T.data,m,h,b,I,y,v,U,x,M);else if(T.data.status==="processing")setTimeout(A,5e3);else throw new Error(`Unknown status: ${T.data.status}`);else throw new Error(T.data?.message||"Status check failed")}).catch(T=>{console.error("AIPKit Video Status Check Error:",T),h.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${x.videoGenerationFailed||"Video generation failed:"} ${M(T.message||"Unknown error")}</p>`,m.disabled=!1,b&&(b.textContent=y),u(I,!1)})}setTimeout(A,5e3)}function _(c,f,g,m,h,b,I,y,v,U){let x=c.images||c.videos||[];if(x.length>0)g.innerHTML="",x.forEach(M=>{let F=document.createElement("div");F.className=I?"aipkit_video_result":"aipkit_image_result";let k="",S=M.media_library_url||M.url||null,A=I?v.viewFullVideo||"Click to view full video":v.viewFullImage||"Click to view full image";if(I)if(M.url){let C=`<video controls preload="metadata" class="aipkit_image_result_video">
              <source src="${U(M.url)}" type="video/mp4">
              Your browser does not support the video tag.
            </video>`;S&&S!==M.url?k=`<a href="${U(S)}" target="_blank" rel="noopener noreferrer" title="${U(A)}">${C}</a>`:k=C}else k=`<p class="aipkit_video_results_message aipkit_message-error">${v.noVideoDataFound||"Error: No video data found."}</p>`;else{let C=M.url||(M.b64_json?`data:image/png;base64,${M.b64_json}`:null);if(C){let E=`<img src="${U(C)}" alt="${U(y)}">`;S?k=`<a href="${U(S)}" target="_blank" rel="noopener noreferrer" title="${U(A)}">${E}</a>`:k=E}else k=`<p class="aipkit_image_results_message aipkit_message-error">${v.noImageDataFound||"Error: No image data found."}</p>`}if(F.innerHTML=k,M.revised_prompt){let C=document.createElement("p");C.className="aipkit_image_result_revised_prompt",C.textContent=`${v.revisedPromptPrefix||"Revised:"} ${M.revised_prompt}`,F.appendChild(C)}g.appendChild(F)});else{let M=I?"videos":"images";g.innerHTML=`<p class="aipkit_image_results_message aipkit_message-info">${v.initialPlaceholder||`No ${M} returned. Try a different prompt.`}</p>`}f.disabled=!1,m&&(m.textContent=b),u(h,!1)}window.aipkit_handlePublicImageGeneration=l})();(function(){"use strict";function d(n){let e=n.currentTarget;if(e.disabled)return;let i=e.closest("#aipkit_public_image_generator");if(!i)return;let t=(window.aipkit_image_generator_config_public||{}).ajaxUrl||window.aipkit_dashboard?.ajaxurl,o=i.querySelector("#aipkit_image_generator_public_nonce")?.value,r=i.querySelector(".aipkit-image-history-grid");if(!t||!o||!r){console.error("Image History Load More: Missing required elements or config.");return}let s=parseInt(e.dataset.currentPage,10)||1,u=parseInt(e.dataset.maxPages,10)||1,p=s+1;if(p>u)return;let l=e.querySelector(".aipkit_btn-icon-content"),w=e.querySelector(".aipkit_spinner");l&&(l.style.display="none"),w&&(w.style.display="inline-block"),e.disabled=!0;let _=new FormData;_.append("action","aipkit_load_more_image_history"),_.append("_ajax_nonce",o),_.append("page",p),_.append("shortcode_mode",String(i.dataset.imageMode||"both").trim().toLowerCase()),fetch(t,{method:"POST",body:_,credentials:"same-origin"}).then(c=>c.json()).then(c=>{if(!c.success)throw new Error(c.data?.message||"Failed to load more images.");c.data.html&&r.insertAdjacentHTML("beforeend",c.data.html),e.dataset.currentPage=p,c.data.has_more||(e.style.display="none")}).catch(c=>{console.error("Image History Load More Error:",c)}).finally(()=>{l&&(l.style.display="inline-block"),w&&(w.style.display="none"),p<u?e.disabled=!1:e.style.display="none"})}window.aipkit_handleLoadMoreHistory=d})();(function(){"use strict";let d=["image/jpeg","image/png","image/webp","image/gif"],e=new Set(["gpt-image-1.5","gpt-image-1","gpt-image-1-mini"]),i={image_input:!0,image_output:!0,image_generation:!0};function a(k,S){let A=new Set(["generate","edit","both"]),C=new Set(["generate","edit"]),E=String(k?.dataset?.imageMode||"generate").trim().toLowerCase(),T=String(k?.dataset?.imageDefaultMode||"generate").trim().toLowerCase(),q=String(S?.value||"").trim().toLowerCase(),L=A.has(E)?E:"generate",H=C.has(T)?T:"generate",O=C.has(q)?q:"";return L==="both"?O||H:L==="edit"?"edit":"generate"}function t(k,S){if(!k)return;let A=S==="edit"?"edit":"generate",C=k.querySelector("#aipkit_public_image_mode"),E=k.querySelectorAll(".aipkit_image_generator_mode_btn"),T=k.querySelector("#aipkit_public_image_prompt"),q=k.querySelector("#aipkit_public_image_edit_upload_row"),L=k.querySelector("#aipkit_public_generate_image_btn"),H=L?L.querySelector(".aipkit_btn-text"):null,O=k.dataset.generatePlaceholder||"Describe the image you want to generate...",D=k.dataset.editPlaceholder||"Describe how you want to edit the uploaded image...",B=k.dataset.generateLabel||"Generate",R=k.dataset.editLabel||"Edit Image";C&&(C.value=A),T&&T.setAttribute("placeholder",A==="edit"?D:O),H&&(H.textContent=A==="edit"?R:B),q&&(q.hidden=A!=="edit"),E.forEach($=>{let G=(String($.getAttribute("data-aipkit-image-mode")||"").trim().toLowerCase()==="edit"?"edit":"generate")===A;$.classList.toggle("is-active",G),$.setAttribute("aria-pressed",G?"true":"false")})}function o(k,S,A){if(typeof window.aipkit_getSettingValue=="function"&&k)return window.aipkit_getSettingValue(k,S,A);let C=k?k.querySelector(`#${S}`):null;if(C&&typeof C.value<"u")return C.value;let E=k?k.querySelector(`[name="${A}"]`):null;return E&&typeof E.value<"u"?E.value:""}function r(k,S,A,C){let E=k?k.querySelector(`#${S}`):null;if(E&&typeof E.value<"u"){E.value=C;return}let T=k?k.querySelector(`[name="${A}"]`):null;T&&typeof T.value<"u"&&(T.value=C)}function s(k){let S=k.querySelector("#aipkit_public_image_mode");return String(S&&S.value?S.value:"generate").trim().toLowerCase()==="edit"?"edit":"generate"}function u(k){let S=Number(k||0);return!Number.isFinite(S)||S<=0?"0 B":S<1024?`${S} B`:S<1024*1024?`${(S/1024).toFixed(1)} KB`:`${(S/(1024*1024)).toFixed(1)} MB`}function p(k){let S=Array.isArray(k?.edit_upload_allowed_mime_types)?k.edit_upload_allowed_mime_types.map(C=>String(C||"").trim().toLowerCase()).filter(Boolean):d,A=Number(k?.edit_upload_max_bytes||0);return{allowedMimeTypes:new Set(S),maxBytes:Number.isFinite(A)&&A>0?A:10485760}}function l(k,S){if(!k)return;let A=k.querySelector("#aipkit_public_image_edit_source_file"),C=k.querySelector("#aipkit_public_image_edit_dropzone"),E=k.querySelector("#aipkit_public_image_edit_file_summary"),T=k.querySelector("#aipkit_public_image_edit_file_preview"),q=k.querySelector("#aipkit_public_image_edit_file_name"),L=k.querySelector("#aipkit_public_image_edit_file_remove"),H=k.querySelector("#aipkit_public_image_edit_upload_feedback");if(!A||!C||C.dataset.dropzoneListenerAttached==="true")return;let O=S&&typeof S.text=="object"?S.text:{},D=p(S),B="",R=()=>{B&&typeof URL<"u"&&typeof URL.revokeObjectURL=="function"&&URL.revokeObjectURL(B),B="",T&&(T.removeAttribute("src"),T.hidden=!0)},$=P=>{if(!H)return;let N=String(P||"").trim();if(!N){H.hidden=!0,H.textContent="",C.classList.remove("has-error");return}H.textContent=N,H.hidden=!1,C.classList.add("has-error")},K=()=>{A.value="",R(),E&&(E.hidden=!0),q&&(q.textContent=""),C.classList.remove("has-file"),$("")},G=P=>{P&&(E&&(E.hidden=!1),q&&(q.textContent=`${P.name} (${u(P.size)})`),T&&typeof URL<"u"&&typeof URL.createObjectURL=="function"&&(R(),B=URL.createObjectURL(P),T.src=B,T.hidden=!1),C.classList.add("has-file"),$(""))},W=P=>{if(!P)return{valid:!1,message:O.editUploadRequired||"Please upload an image to edit."};let N=String(P.type||"").trim().toLowerCase();return D.allowedMimeTypes.has(N)?Number(P.size||0)>D.maxBytes?{valid:!1,message:O.editFileTooLarge||"Source image is too large. Maximum allowed size is 10MB."}:{valid:!0,message:""}:{valid:!1,message:O.editInvalidFileType||"Invalid image type. Allowed types: JPG, PNG, WEBP, GIF."}},Q=P=>{if(!P||typeof DataTransfer>"u")return!1;try{let N=new DataTransfer;return N.items.add(P),A.files=N.files,!0}catch{return!1}},Z=(P,N=!1)=>{let V=W(P);return V.valid?N&&!Q(P)?($(O.editDropUsePicker||"Could not attach dropped file automatically. Click to choose file."),!1):(G(P),!0):($(V.message),!1)};C.addEventListener("click",()=>{A.click()}),C.addEventListener("keydown",P=>{(P.key==="Enter"||P.key===" ")&&(P.preventDefault(),A.click())}),["dragenter","dragover"].forEach(P=>{C.addEventListener(P,N=>{N.preventDefault(),N.stopPropagation(),C.classList.add("is-dragover")})}),["dragleave","drop"].forEach(P=>{C.addEventListener(P,N=>{N.preventDefault(),N.stopPropagation(),C.classList.remove("is-dragover")})}),C.addEventListener("drop",P=>{let N=P.dataTransfer&&P.dataTransfer.files&&P.dataTransfer.files.length>0?P.dataTransfer.files[0]:null;N&&Z(N,!0)}),A.addEventListener("change",()=>{let P=A.files&&A.files.length>0?A.files[0]:null;if(!P){K();return}Z(P,!1)}),L&&L.addEventListener("click",P=>{P.preventDefault(),K()}),A.files&&A.files.length>0?Z(A.files[0],!1):K(),C.dataset.dropzoneListenerAttached="true",window.addEventListener("beforeunload",R,{once:!0})}function w(k,S){let A=String(S||"").trim();if(!A)return!1;let C=k&&typeof k.google_models=="object"?k.google_models:{};return C.video&&Array.isArray(C.video)?C.video.some(E=>E&&E.id===A):A.toLowerCase().includes("veo")}function _(k,S){let A=String(S||"").trim().toLowerCase();return!A||w(k,A)?!1:A.includes("gemini")&&A.includes("image-generation")}function c(k){let S=String(k||"").trim().toLowerCase();return e.has(S)}function f(k,S){let A=Array.isArray(k?.openrouter_image_models)?k.openrouter_image_models:[],C=String(S||"").trim().toLowerCase();if(!C)return i;let E=A.find(T=>String(T?.id||"").trim().toLowerCase()===C);return!E||typeof E.capabilities!="object"?i:{...i,...E.capabilities}}function g(k,S){let A=f(k,S);return!!(A.image_input&&(A.image_output||A.image_generation))}function m(k){return k?new Set(String(k).split(",").map(S=>S.trim().toLowerCase()).filter(Boolean)):null}function h(k,S){let A=k&&typeof k.google_models=="object"?k.google_models:{},C=Array.isArray(A.image)?A.image:[],E=m(S);return C.filter(T=>{let q=String(T?.id||"").trim().toLowerCase();return!q||!_(k,q)?!1:!E||E.has("google")?!0:E.has(q)})}function b(k,S){let A=k&&Array.isArray(k.openai_models)?k.openai_models:[],C=m(S);return A.filter(E=>{let T=String(E?.id||"").trim().toLowerCase();return!T||!c(T)?!1:!C||C.has("openai")?!0:C.has(T)})}function I(k,S){let A=k&&Array.isArray(k.openrouter_image_models)?k.openrouter_image_models:[],C=m(S);return A.filter(E=>{let T=String(E?.id||"").trim().toLowerCase();return!T||!g(k,T)?!1:!C||C.has("openrouter")?!0:C.has(T)})}function y(k,S){let A=String(o(k,"aipkit_public_image_provider","image_provider")||"").trim().toLowerCase(),C=String(o(k,"aipkit_public_image_model","image_model")||"").trim().toLowerCase();if(A!=="google"&&A!=="openai"&&A!=="openrouter")return{supported:!1,reason:"provider"};if(!C)return{supported:!1,reason:"model"};if(A==="google"){let E=_(S,C);return{supported:E,reason:E?null:"model"}}if(A==="openrouter"){let E=g(S,C);return{supported:E,reason:E?null:"model"}}return c(C)?{supported:!0,reason:null}:{supported:!1,reason:"model"}}function v(k,S){let A=k.querySelector("#aipkit_public_image_provider");if(!A)return;let C=S==="edit",E=new Set(["google","openai","openrouter"]),T=Array.from(A.options),q=T.filter(O=>E.has(String(O.value||"").trim().toLowerCase()));T.forEach(O=>{let D=String(O.value||"").trim().toLowerCase(),B=!C||E.has(D);O.hidden=!B,O.disabled=!B});let L=String(A.value||"").trim().toLowerCase(),H=q.some(O=>String(O.value||"").trim().toLowerCase()===L);C&&!H&&q.length>0&&(A.value=q[0].value)}function U(k,S,A){let C=k.querySelector("#aipkit_public_image_model");if(!C||typeof window.aipkit_populatePublicModelsForProvider!="function")return;let E=String(o(k,"aipkit_public_image_provider","image_provider")||"").trim();if(window.aipkit_populatePublicModelsForProvider(E,C,S,{mode:A}),C.disabled){r(k,"aipkit_public_image_model","image_model","");return}r(k,"aipkit_public_image_model","image_model",C.value)}function x(k,S,A,C){if(C!=="edit")return;let E=k.querySelector("#aipkit_public_image_provider"),T=k.querySelector("#aipkit_public_image_model");if(E)return;let q=h(S,A),L=b(S,A),H=I(S,A),O=String(o(k,"aipkit_public_image_provider","image_provider")||"").trim().toLowerCase(),D="",B=[];if(O==="google"&&q.length>0?(D="Google",B=q):O==="openai"&&L.length>0?(D="OpenAI",B=L):O==="openrouter"&&H.length>0?(D="OpenRouter",B=H):q.length>0?(D="Google",B=q):L.length>0?(D="OpenAI",B=L):H.length>0&&(D="OpenRouter",B=H),!(!D||B.length===0)&&(r(k,"aipkit_public_image_provider","image_provider",D),!T)){let R=String(o(k,"aipkit_public_image_model","image_model")||"").trim().toLowerCase();B.some(K=>String(K.id||"").trim().toLowerCase()===R)||r(k,"aipkit_public_image_model","image_model",B[0].id)}}function M(k,S,A){if(!k)return;let C=String(k.dataset.imageMode||"generate").trim().toLowerCase(),E=s(k),T=k.querySelector("#aipkit_public_image_edit_mode_notice"),q=k.querySelector("#aipkit_public_generate_image_btn"),L=k.querySelector('.aipkit_image_generator_mode_btn[data-aipkit-image-mode="edit"]'),H=h(S,A).length>0||b(S,A).length>0||I(S,A).length>0;if(v(k,E),x(k,S,A,E),U(k,A,E),C==="generate"){T&&(T.hidden=!0,T.textContent=""),q&&(q.disabled=!1);return}let O=y(k,S);L&&(L.disabled=!H,L.classList.toggle("is-disabled",!H),L.setAttribute("aria-disabled",H?"false":"true")),C==="both"&&!H&&E==="edit"&&t(k,"generate"),q&&E==="edit"?q.disabled=!O.supported:q&&(q.disabled=!1),T&&(T.hidden=!0,T.textContent="")}function F(){let k=document.getElementById("aipkit_public_image_generator");if(!k)return;let S=k.querySelector("#aipkit_public_generate_image_btn"),A=k.querySelector("#aipkit_public_image_results"),C=k.querySelector("#aipkit_public_image_provider"),E=k.querySelector("#aipkit_public_image_model"),T=window.aipkit_image_generator_config_public||{},q=k.dataset.allowedModels||"",L=k.querySelector(".aipkit-image-history-grid"),H=k.querySelector(".aipkit-image-history-load-more-btn");if(!S||!A){console.error("AIPKit Image Generator (Public): Could not find essential UI elements (button, results)."),A&&(A.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${T?.text?.coreUiMissing||"Error: Core UI elements missing."}</p>`,A.style.display="grid");return}l(k,T),C&&C.addEventListener("change",()=>{M(k,T,q)}),E&&E.addEventListener("change",()=>{M(k,T,q)}),S.dataset.listenerAttached!=="true"&&(S.addEventListener("click",window.aipkit_handlePublicImageGeneration),S.dataset.listenerAttached="true");let O=k.querySelector("#aipkit_public_image_mode"),D=k.querySelectorAll(".aipkit_image_generator_mode_btn"),B=a(k,O);t(k,B),D.forEach(R=>{R.dataset.modeListenerAttached!=="true"&&(R.addEventListener("click",()=>{if(R.disabled)return;let $=s(k),K=String(R.getAttribute("data-aipkit-image-mode")||"").trim().toLowerCase()==="edit"?"edit":"generate";if($==="generate"&&K==="edit")k.dataset.lastGenerateProvider=String(o(k,"aipkit_public_image_provider","image_provider")||"").trim(),k.dataset.lastGenerateModel=String(o(k,"aipkit_public_image_model","image_model")||"").trim();else if($==="edit"&&K==="generate"){let G=String(k.dataset.lastGenerateProvider||"").trim(),W=String(k.dataset.lastGenerateModel||"").trim();G&&r(k,"aipkit_public_image_provider","image_provider",G),W&&r(k,"aipkit_public_image_model","image_model",W)}t(k,K),M(k,T,q)}),R.dataset.modeListenerAttached="true")}),M(k,T,q),L&&(L.addEventListener("click",window.aipkit_handleEditHistoryImage),L.addEventListener("click",window.aipkit_handleDeleteImage)),H&&H.addEventListener("click",window.aipkit_handleLoadMoreHistory),A&&(A.style.display="none",A.innerHTML="")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",F):F(),window.aipkit_initPublicImageGenerator=F})();(function(){"use strict";function d(i,a,t,o){let r=window.aipkit_token_usage_config||{},s=r.text||{},u=document.createElement("div");u.className="aipkit-usage-details-table-container";let p=document.createElement("div");p.className="aipkit-usage-details-pagination-container",o.appendChild(u),o.appendChild(p),u.innerHTML=`<p style="text-align:center;"><span class="aipkit_spinner" style="display:inline-block;width:20px;height:20px;"></span> ${s.loadingDetails||"Loading details..."}</p>`;let l={action:"aipkit_get_token_usage_details",nonce:r.nonce,module:i,context_id:a,page:t},w=new FormData;for(let _ in l)w.append(_,l[_]);fetch(r.ajaxUrl,{method:"POST",body:w,credentials:"same-origin"}).then(_=>_.json()).then(_=>{if(!_.success)throw new Error(_.data?.message||"Failed to load data.");n(_.data.items,u),e(_.data.pagination,p,i,a,o)}).catch(_=>{console.error("Error fetching token usage details:",_),u.innerHTML=`<p style="color:red;text-align:center;">${s.errorLoading||"Error loading details."} (${_.message})</p>`})}function n(i,a){if(!i||i.length===0){a.innerHTML='<p style="text-align:center;">No detailed usage records found for this period.</p>';return}let t='<table class="aipkit_usage_details_table"><thead><tr><th>Date & Time</th><th>Tokens Used</th></tr></thead><tbody>';i.forEach(o=>{let s=new Date(o.timestamp*1e3).toLocaleString(void 0,{dateStyle:"medium",timeStyle:"short"});t+=`<tr><td>${s}</td><td>${o.tokens.toLocaleString()}</td></tr>`}),t+="</tbody></table>",a.innerHTML=t}function e(i,a,t,o,r){let{currentPage:s,totalPages:u}=i,p=window.aipkit_token_usage_config?.text||{};if(a.innerHTML="",u<=1)return;let l=document.createElement("button");l.className="aipkit_btn aipkit_btn-secondary aipkit_btn-small",l.textContent=p.previous||"Previous",l.disabled=s<=1,l.addEventListener("click",()=>d(t,o,s-1,r)),a.appendChild(l);let w=document.createElement("span");w.className="aipkit_pagination-current",w.textContent=`${p.pageLabel||"Page"} ${s} ${p.ofLabel||"of"} ${u}`,a.appendChild(w);let _=document.createElement("button");_.className="aipkit_btn aipkit_btn-secondary aipkit_btn-small",_.textContent=p.next||"Next",_.disabled=s>=u,_.addEventListener("click",()=>d(t,o,s+1,r)),a.appendChild(_)}document.addEventListener("click",function(i){let a=i.target.closest(".aipkit-usage-details-btn");if(!a||a.disabled)return;let t=a.closest("tr.aipkit-usage-main-row");if(!t)return;let o=t.nextElementSibling,r=o&&o.classList.contains("aipkit-usage-details-row");if(document.querySelectorAll(".aipkit-usage-details-row").forEach(s=>{if(s!==o){let u=s.previousElementSibling.querySelector(".aipkit-usage-details-btn");u&&u.classList.remove("aipkit-active"),s.remove()}}),r)o.remove(),a.classList.remove("aipkit-active");else{a.classList.add("aipkit-active");let s=document.createElement("tr");s.className="aipkit-usage-details-row";let u=document.createElement("td");u.colSpan=t.cells.length,u.className="aipkit-usage-details-cell";let p=document.createElement("div");p.className="aipkit-usage-details-content",u.appendChild(p),s.appendChild(u),t.parentNode.insertBefore(s,t.nextSibling);let l=a.dataset.module,w=a.dataset.contextId;d(l,w,1,p)}}),document.addEventListener("click",function(i){let a=i.target.closest(".aipkit_toggle_purchase_history");if(!a)return;i.preventDefault();let t=document.getElementById("aipkit_purchase_history_details");if(!t)return;a.getAttribute("aria-expanded")==="true"?(t.style.display="none",a.setAttribute("aria-expanded","false")):(t.style.display="block",a.setAttribute("aria-expanded","true"))})})();(function(){"use strict";function d(e){e.preventDefault();let i=e.target,a=i.querySelector(".aipkit_semantic_search_input"),t=i.querySelector(".aipkit_semantic_search_button"),o=i.closest(".aipkit_semantic_search_wrapper"),r=o.querySelector(".aipkit_semantic_search_results");if(!a||!t||!o||!r){console.error("Semantic Search: Missing required form elements.");return}let s=a.value.trim();if(!s)return;let u=window.aipkit_semantic_search_config||{},p=u.text||{};t.disabled=!0;let l=t.querySelector(".aipkit_spinner");l&&(l.style.display="inline-block"),r.innerHTML='<div class="aipkit-search-loading"><span class="aipkit_spinner"></span></div>';let w={query:s};window.aipkit_frontendApiRequest("aipkit_perform_semantic_search",w,u).then(_=>{r.innerHTML=_.html||`<p>${u.settings.no_results_text||"No results found."}</p>`}).catch(_=>{console.error("Semantic Search Error:",_),r.innerHTML=`<p class="aipkit-search-error">${p.error||"An error occurred while searching."}</p>`}).finally(()=>{t.disabled=!1,l&&(l.style.display="none")})}function n(){document.querySelectorAll(".aipkit_semantic_search_form").forEach(i=>{i.dataset.listenerAttached!=="true"&&(i.addEventListener("submit",d),i.dataset.listenerAttached="true")})}document.addEventListener("DOMContentLoaded",n),document.addEventListener("aipkit:contentLoaded",n)})();(function(){"use strict";function d(n,e,i){if(!n)return console.error("AIPKit ShowConsentBox: mainChatEl not found."),null;let a=n.querySelector(".aipkit_consent_overlay"),t=n.querySelector(".aipkit_chat_input");if(!a){a=document.createElement("div"),a.className="aipkit_consent_overlay",a.innerHTML=`
                <h5 class="aipkit_consent_title">${e.text.consentTitle||"Consent Required"}</h5>
                <p class="aipkit_consent_message">${e.text.consentMessage||"Please agree to continue."}</p>
                <button type="button" class="aipkit_btn aipkit_btn-primary aipkit_consent_agree_btn">
                    ${e.text.consentButton||"I Agree"}
                </button>
            `,t?t.appendChild(a):n.appendChild(a);let o=a.querySelector(".aipkit_consent_agree_btn");o&&typeof i=="function"&&o.addEventListener("click",i)}return t&&t.classList.add("aipkit-consent-active"),a.classList.remove("aipkit_hidden"),a}window.aipkit_chatUI_showConsentBox=d})();(function(){"use strict";function d(n){if(n){n.classList.add("aipkit_hidden");let e=n.closest(".aipkit_chat_input");e&&e.classList.remove("aipkit-consent-active")}}window.aipkit_chatUI_hideConsentBox=d})();(function(){"use strict";function d(n,e,i,a,t,o){n.consentGiven=!0,localStorage.setItem(e,"true"),typeof t=="function"&&o&&t(o);let r=a.closest("[data-bot-id]")?.dataset.botId||"unknown";typeof i=="function"&&i();let s=a.closest(".aipkit_chat_container");s&&s.dispatchEvent(new CustomEvent("aipkit:consentGiven"))}window.aipkit_chatUI_handleConsentAgree=d})();(function(){"use strict";function d(n,e,i,a){let t=e.botId,o=`aipkit_chatbot_consent_given_${t}`;i.consentGiven=localStorage.getItem(o)==="true";let r=null;function s(){typeof window.aipkit_chatUI_handleConsentAgree=="function"?window.aipkit_chatUI_handleConsentAgree(i,o,a,n,p,r):console.error(`AIPKit Consent UI Init (${t}): aipkit_chatUI_handleConsentAgree helper function not found.`)}function u(){typeof window.aipkit_chatUI_showConsentBox=="function"?r=window.aipkit_chatUI_showConsentBox(n,e,s):console.error(`AIPKit Consent UI Init (${t}): aipkit_chatUI_showConsentBox helper function not found.`)}function p(){r&&typeof window.aipkit_chatUI_hideConsentBox=="function"?window.aipkit_chatUI_hideConsentBox(r):r&&console.error(`AIPKit Consent UI Init (${t}): aipkit_chatUI_hideConsentBox helper function not found.`)}return e.requireConsentCompliance&&!i.consentGiven&&u(),{showConsentBoxIfNeeded:()=>e.requireConsentCompliance&&!i.consentGiven?(u(),!0):!1,isConsentGiven:()=>i.consentGiven}}window.aipkit_initConsentUI=d})();(function(){"use strict";function d(n,e){let{messagesEl:i}=n;if(!i||!e||!e.text){console.error("AIPKit Download PDF: Missing messages element or config.");return}if(typeof window.aipkit_chatUI_extractTextFromBubble!="function"||typeof window.aipkit_chatUI_generateDownloadFilename!="function"||typeof window.aipkit_chatUI_triggerBlobDownload!="function"){console.error("AIPKit Download PDF: One or more helper functions (extractText, generateFilename, triggerBlobDownload) not found."),alert("Error: Could not prepare PDF download.");return}if(typeof window.jspdf>"u"||typeof window.jspdf.jsPDF>"u"){console.error("AIPKit Download PDF: jsPDF library is not loaded."),alert(e.text.pdfError||"Could not generate PDF. jsPDF library might be missing.");return}let{jsPDF:a}=window.jspdf,t=new a,o=i.querySelectorAll(".aipkit_chat_message"),r=e?.headerName||"Bot",s=e.text.userPrefix||"User",u=e.text.errorPrefix||"Error",p=10,l=t.internal.pageSize.height,w=10,_=6,c=l-w*2,f=!1;if(t.setFontSize(16),t.text(`Chat Transcript - ${r}`,w,p),p+=_*2,t.setFontSize(12),o.forEach(m=>{let h=m.querySelector(".aipkit_chat_bubble");if(!h)return;let b=window.aipkit_chatUI_extractTextFromBubble(h),I="";if(m.classList.contains("aipkit_chat_message-user")?(I=`${s}:`,t.setFont(void 0,"bold")):m.classList.contains("aipkit_chat_message-bot")?(I=`${r}:`,t.setFont(void 0,"normal")):m.classList.contains("aipkit_chat_message-error")?(I=`${u}:`,t.setFont(void 0,"italic")):t.setFont(void 0,"normal"),I&&b){f=!0;let y=I,v=`${b}`;p+_>c+w&&(t.addPage(),p=w),t.text(y,w,p),p+=_,t.splitTextToSize(v,t.internal.pageSize.width-w*2).forEach(x=>{p+_>c+w&&(t.addPage(),p=w),t.text(x,w,p),p+=_}),p+=_/2,t.setFont(void 0,"normal")}}),!f){console.warn("AIPKit Chat Download PDF: No transcript content found."),alert(e.text.downloadEmpty||"Nothing to download.");return}let g=window.aipkit_chatUI_generateDownloadFilename(e,"pdf");try{t.save(g)}catch(m){console.error("AIPKit Download PDF: Error calling doc.save()",m),alert("An error occurred while generating the PDF.")}}window.aipkit_chatUI_downloadTranscriptActionPdf=d})();(function(){"use strict";function d(n){let i=n.currentTarget.closest(".aipkit-ai-form-wrapper"),a=i?i.querySelector(".aipkit-ai-form-results-content"):null,t=i?i.dataset.formId:"unknown";if(!a){console.error("AI Forms PDF: Results content div (.aipkit-ai-form-results-content) not found.");return}if(typeof window.jspdf>"u"||typeof window.jspdf.jsPDF>"u"){console.error("AI Forms PDF: jsPDF library is not loaded."),alert("Could not generate PDF. Required library is missing.");return}let{jsPDF:o}=window.jspdf,r=new o,s=a.innerText||a.textContent||"";if(!s.trim()){alert("Nothing to export.");return}let u=r.internal.pageSize.height,p=10,l=6,w=u-p*2,_=p;r.setFontSize(12),r.splitTextToSize(s,r.internal.pageSize.width-p*2).forEach(h=>{_+l>w+p&&(r.addPage(),_=p),r.text(h,p,_),_+=l});let f=new Date,g=`${f.getFullYear()}${String(f.getMonth()+1).padStart(2,"0")}${String(f.getDate()).padStart(2,"0")}`,m=`aiform-${t}-result-${g}.pdf`;r.save(m)}window.aipkitForms_handleDownloadPdf=d})();(function(){"use strict";let d='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-volume"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 8a5 5 0 0 1 0 8" /><path d="M17.7 5a9 9 0 0 1 0 14" /><path d="M6 15h-2a1 1 0 0 1 -1 -1v-4a1 1 0 0 1 1 -1h2l3.5 -4.5a.8 .8 0 0 1 1.5 .5v14a.8 .8 0 0 1 -1.5 .5l-3.5 -4.5" /></svg>',n='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-player-pause"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 5m0 1a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1z" /><path d="M14 5m0 1a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1z" /></svg>',e='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-alert-square-rounded"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c7.2 0 9 1.8 9 9s-1.8 9 -9 9s-9 -1.8 -9 -9s1.8 -9 9 -9z" /><path d="M12 8v4" /><path d="M12 16h.01" /></svg>';function i(t,o,r=null){if(t)switch(t.classList.remove("is-connecting","is-listening","is-speaking","is-error"),t.innerHTML="",o){case"connecting":t.classList.add("is-connecting");let s=document.createElement("span");s.className="aipkit_spinner",s.style.display="inline-block",t.appendChild(s),t.title=r||"Connecting...",t.disabled=!0;break;case"listening":t.classList.add("is-listening"),t.innerHTML=n,t.title=r||"Listening... (Click to stop)",t.disabled=!1;break;case"speaking":t.classList.add("is-speaking"),t.innerHTML=d,t.title=r||"AI is speaking... (Click to stop)",t.disabled=!1;break;case"error":t.classList.add("is-error"),t.innerHTML=e,t.title=r||"Error. Click to retry.",t.disabled=!1;break;case"idle":default:t.innerHTML=d,t.title=r||"Start Voice Conversation",t.disabled=!1;break}}function a(t,o){t.inputField&&(t.inputField.disabled=o),t.actionButton&&(t.actionButton.disabled=o),t.inputActionButton&&(t.inputActionButton.disabled=o),t.voiceInputButton&&(t.voiceInputButton.disabled=o)}window.aipkit_realtimeUIHandler={setButtonState:i,toggleMainInputs:a}})();(function(){"use strict";async function d(i){try{let a=await navigator.mediaDevices.getUserMedia({audio:!0});return a.getTracks().forEach(t=>i.addTrack(t,a)),a}catch(a){throw console.error("Error getting user media:",a),a}}function n(i){let a=document.createElement("audio");return a.autoplay=!0,i.ontrack=t=>{t.streams&&t.streams[0]&&(a.srcObject=t.streams[0])},a}function e(i){i&&i.getTracks().forEach(a=>a.stop())}window.aipkit_realtimeAudioHandler={startLocalStream:d,setupRemoteStream:n,stopLocalStream:e}})();(function(){"use strict";async function d(n,e,i){let a=i.createDataChannel("aipkit-events"),t={userTranscript:"",botTranscript:""},o=async r=>{let s=r?.usage||null;if(!t.userTranscript&&!t.botTranscript)return;let u={user_transcript:t.userTranscript,bot_transcript:t.botTranscript,usage_data:s?JSON.stringify(s):null};try{await window.aipkit_frontendApiRequest("aipkit_log_realtime_session_turn",u,e)}catch(p){console.error("AIPKit Realtime: Failed to log session turn.",p)}finally{t={userTranscript:"",botTranscript:""}}};a.onopen=()=>console.log("AIPKit Realtime: Data channel opened."),a.onmessage=r=>{try{let s=JSON.parse(r.data);s.type==="input.transcription"&&s.transcription&&(t.userTranscript+=s.transcription.trim()+" "),s.type==="response.done"&&s.response&&(s.response.output&&s.response.output[0]&&s.response.output[0].content&&s.response.output[0].content[0]&&s.response.output[0].content[0].transcript&&(t.botTranscript=s.response.output[0].content[0].transcript),o(s.response))}catch(s){console.error("AIPKit Realtime: Error processing message from server:",r.data,s)}},a.onclose=()=>console.log("AIPKit Realtime: Data channel closed."),a.onerror=r=>console.error("AIPKit Realtime: Data channel error:",r);try{let r=await i.createOffer();await i.setLocalDescription(r);let s=e.realtimeModel||"gpt-4o-realtime-preview",u=await fetch(`https://api.openai.com/v1/realtime?model=${s}`,{method:"POST",body:r.sdp,headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/sdp"}});if(!u.ok){let l=await u.text();throw new Error(`SDP exchange failed with status ${u.status}: ${l}`)}let p={type:"answer",sdp:await u.text()};return await i.setRemoteDescription(p),a}catch(r){throw console.error("AIPKit Realtime: WebRTC connection failed.",r),i&&i.connectionState!=="closed"&&i.close(),r}}window.aipkit_realtimeConnector={connect:d}})();(function(){"use strict";let d={peerConnection:null,localStream:null,remoteAudioElement:null,dataChannel:null,isSessionActive:!1,currentBotId:null,elements:null,config:null,mainUIState:null,uiInstance:null};async function n(t){t&&(t.preventDefault(),t.stopPropagation()),d.isSessionActive?i():await e()}async function e(){if(d.config.requireConsentCompliance&&!d.mainUIState.consentGiven&&!d.config.directVoiceMode){console.warn(`AIPKit Realtime (${d.config.botId}): Cannot start session, consent required. Opening popup.`),d.uiInstance&&typeof d.uiInstance.openPopup=="function"&&d.uiInstance.openPopup();return}if(!window.aipkit_current_conversation_uuid)if(typeof window.aipkit_regenerateConversationUUID=="function")window.aipkit_regenerateConversationUUID();else{console.error("AIPKit Realtime: Cannot start session, aipkit_regenerateConversationUUID function is missing.");let u=d.elements.triggerButton,p=d.elements.container.querySelector(".aipkit_realtime_voice_agent_btn"),l=d.config.directVoiceMode?u:p;window.aipkit_realtimeUIHandler.setButtonState(l,"error","Error: Cannot create session ID.");return}window.aipkit_is_fresh_session=!1;let t=d.elements.triggerButton,o=d.elements.container.querySelector(".aipkit_realtime_voice_agent_btn"),r=d.config.directVoiceMode?t:o,{...s}=d.elements;window.aipkit_realtimeUIHandler.setButtonState(r,"connecting"),d.config.directVoiceMode||window.aipkit_realtimeUIHandler.toggleMainInputs(s,!0);try{let p=(await window.aipkit_frontendApiRequest("aipkit_create_realtime_session",{bot_id:d.currentBotId},d.config))?.client_secret?.value;if(!p)throw new Error("Could not retrieve a session key from the server.");let l=new RTCPeerConnection;d.peerConnection=l,d.remoteAudioElement=window.aipkit_realtimeAudioHandler.setupRemoteStream(l),d.localStream=await window.aipkit_realtimeAudioHandler.startLocalStream(l);let w=await window.aipkit_realtimeConnector.connect(p,d.config,l);d.dataChannel=w,l.onconnectionstatechange=()=>{(l.connectionState==="disconnected"||l.connectionState==="closed"||l.connectionState==="failed")&&i("Connection lost.")},d.isSessionActive=!0,window.aipkit_realtimeUIHandler.setButtonState(r,"listening");let _=d.config.text?.initialGreeting;if(_&&typeof window.aipkit_handlePlayAction=="function"&&d.config.ttsEnabled){let c=document.createElement("button"),f='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-player-play"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 4v16l13 -8z" /></svg>';c.className="aipkit_action_btn aipkit_play_btn",c.innerHTML=f;let g=document.createElement("div");g.setAttribute("data-raw-text",_);let m=document.createElement("div");m.appendChild(g),m.appendChild(c),window.aipkit_handlePlayAction(c)}}catch(u){console.error("AIPKit Realtime: Failed to start session.",u),i(`Error: ${u.message||"Could not connect."}`,!0)}}function i(t=null,o=!1){d.peerConnection&&(d.peerConnection.close(),d.peerConnection=null),d.localStream&&(window.aipkit_realtimeAudioHandler.stopLocalStream(d.localStream),d.localStream=null),d.remoteAudioElement&&(d.remoteAudioElement.srcObject=null,d.remoteAudioElement=null),d.currentAudio&&typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(),d.isSessionActive=!1;let r=d.elements.triggerButton,s=d.elements.container.querySelector(".aipkit_realtime_voice_agent_btn"),u=d.config.directVoiceMode?r:s,{...p}=d.elements;window.aipkit_realtimeUIHandler.setButtonState(u,o?"error":"idle",t),d.config.directVoiceMode||window.aipkit_realtimeUIHandler.toggleMainInputs(p,!1)}function a(t,o,r,s,u){let p=t.container.querySelector(".aipkit_realtime_voice_agent_btn"),l=t.container.closest(".aipkit_popup_wrapper"),w=l?l.querySelector(".aipkit_popup_trigger"):null;!p||!w&&o.popupEnabled||(d.uiInstance=u,d.mainUIState=r,d.config=o,d.elements={...t,triggerButton:w},d.currentBotId=o.botId,o.directVoiceMode&&w?(w.addEventListener("click",n),p.style.display="none"):p.addEventListener("click",n))}window.aipkit_initRealtimeVoiceAgent=a})();})();
